{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./node_modules/@babel/runtime/helpers/defineProperty.js","webpack:///./node_modules/@babel/runtime/helpers/objectSpread.js","webpack:///./node_modules/@cliqz-oss/firefox-client/index.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/browser.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/client-methods.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/client.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/console.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/device.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/dom.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/domnode.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/extend.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/jsobject.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/memory.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/network.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/simulator.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/stylesheets.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/tab.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/webapps.js","webpack:///./node_modules/@cliqz-oss/node-firefox-connect/index.js","webpack:///./src/cmd/build.js","webpack:///./src/cmd/docs.js","webpack:///./src/cmd/index.js","webpack:///./src/cmd/lint.js","webpack:///./src/cmd/run.js","webpack:///./src/cmd/sign.js","webpack:///./src/config.js","webpack:///./src/errors.js","webpack:///./src/extension-runners/firefox-android.js","webpack:///./src/extension-runners/firefox-desktop.js","webpack:///./src/extension-runners/index.js","webpack:///./src/firefox/index.js","webpack:///./src/firefox/preferences.js","webpack:///./src/firefox/remote.js","webpack:///./src/main.js","webpack:///./src/program.js","webpack:///./src/util/adb.js","webpack:///./src/util/artifacts.js","webpack:///./src/util/desktop-notifier.js","webpack:///./src/util/file-exists.js","webpack:///./src/util/file-filter.js","webpack:///./src/util/is-directory.js","webpack:///./src/util/logger.js","webpack:///./src/util/manifest.js","webpack:///./src/util/promisify.js","webpack:///./src/util/stdin.js","webpack:///./src/util/temp-dir.js","webpack:///./src/util/updates.js","webpack:///./src/util/zip-dir.js","webpack:///./src/watcher.js","webpack:///external \"adbkit\"","webpack:///external \"addons-linter\"","webpack:///external \"bunyan\"","webpack:///external \"camelcase\"","webpack:///external \"child_process\"","webpack:///external \"colors\"","webpack:///external \"debounce\"","webpack:///external \"decamelize\"","webpack:///external \"es6-error\"","webpack:///external \"es6-promise\"","webpack:///external \"event-to-promise\"","webpack:///external \"events\"","webpack:///external \"firefox-profile\"","webpack:///external \"fs\"","webpack:///external \"fx-runner\"","webpack:///external \"git-rev-sync\"","webpack:///external \"js-select\"","webpack:///external \"mkdirp\"","webpack:///external \"multimatch\"","webpack:///external \"mz\"","webpack:///external \"net\"","webpack:///external \"node-notifier\"","webpack:///external \"opn\"","webpack:///external \"os\"","webpack:///external \"parse-json\"","webpack:///external \"path\"","webpack:///external \"readline\"","webpack:///external \"require-uncached\"","webpack:///external \"sign-addon\"","webpack:///external \"strip-json-comments\"","webpack:///external \"tmp\"","webpack:///external \"update-notifier\"","webpack:///external \"util\"","webpack:///external \"watchpack\"","webpack:///external \"yargs\"","webpack:///external \"zip-dir\""],"names":["log","createLogger","__filename","safeFileName","name","toLowerCase","replace","getDefaultLocalizedName","messageFile","manifestData","messageData","messageContents","extensionName","fs","readFile","encoding","error","UsageError","parseJSON","stripJsonComments","match","messageName","message","Promise","resolve","defaultPackageCreator","sourceDir","fileFilter","artifactsDir","overwriteDest","showReadyMessage","eventToPromise","defaultEventToPromise","id","getManifestId","debug","getValidatedManifest","buffer","zipDir","filter","args","wantFile","default_locale","path","join","packageName","version","extensionPath","stream","createWriteStream","flags","write","end","isErrorWithCode","info","build","asNeeded","ignoreFiles","createFileFilter","defaultFileFilterCreator","onSourceChange","defaultSourceWatcher","packageCreator","rebuildAsNeeded","createPackage","prepareArtifactsDir","result","onChange","catch","stack","shouldWatchFile","url","docs","params","openUrl","opn","reject","options","default","runCommand","require","lint","run","sign","boring","metadata","output","pretty","selfHosted","verbose","warningsAsErrors","createLinter","defaultLinterCreator","shouldExitProgram","linter","config","logLevel","Boolean","shouldScanFile","fileName","_","runAsBinary","browserConsole","pref","firefox","firefoxProfile","keepProfileChanges","noInput","noReload","preInstall","startUrl","target","adbBin","adbHost","adbPort","adbDevice","firefoxApk","buildExtension","defaultBuildExtension","desktopNotifications","defaultDesktopNotifications","firefoxApp","defaultFirefoxApp","firefoxClient","defaultFirefoxClient","reloadStrategy","defaultReloadStrategy","MultiExtensionRunner","DefaultMultiExtensionRunner","defaultGetValidatedManifest","customPrefs","runners","commonRunnerParams","extensions","length","includes","firefoxDesktopRunnerParams","firefoxBinary","profilePath","firefoxDesktopRunner","createExtensionRunner","push","firefoxAndroidRunnerParams","buildSourceDir","extensionSourceDir","tmpArtifactsDir","firefoxAndroidRunner","extensionRunner","defaultAsyncFsReadFile","bind","extensionIdFile","apiKey","apiProxy","apiSecret","apiUrlPrefix","timeout","channel","defaultBuilder","preValidatedManifest","signAddon","defaultAddonSigner","withTempDir","tmpDir","buildResult","idFromSourceDir","all","getIdFromSourceDir","manifestId","warn","signingResult","xpiPath","downloadDir","saveIdToSourceDir","success","WebExtError","asyncFsReadFile","filePath","content","lines","toString","split","line","trim","startsWith","writeFile","applyConfigToArgv","argv","argvFromCLI","configObject","configFileName","newArgv","option","Object","keys","camelCase","Array","isArray","decamelizedOptName","decamelize","type","undefined","expectedType","optionType","defaultValue","wasValueSetOnCLI","coerce","loadJSConfigFile","resolvedFilePath","requireUncached","endsWith","webExt","discoverConfigFiles","getHomeDir","os","homedir","magicConfigName","possibleConfigs","process","cwd","configs","map","resolvedFileName","fileExists","existingConfigs","forEach","f","ExtendableError","constructor","InvalidManifest","RemoteTempInstallNotSupported","MultiExtensionsReloadError","errorsMap","errors","msg","String","errorsBySourceDir","onlyInstancesOf","predicate","errorHandler","onlyErrorsWithCode","codeWanted","throwError","indexOf","code","errno","ignoredParams","getIgnoredParamsWarningsMessage","optionName","FirefoxAndroidExtensionRunner","cleanupCallbacks","Set","adbExtensionsPathBySourceDir","Map","reloadableExtensions","printIgnoredParamsWarnings","ADBUtils","DefaultADBUtils","adbUtils","adbDevicesDiscoveryAndSelect","apkPackagesDiscoveryAndSelect","adbCheckRuntimePermissions","adbForceStopSelectedPackage","adbPrepareProfileDir","adbStartSelectedPackage","buildAndPushExtensions","adbDiscoveryAndForwardRDPUnixSocket","rdpInstallExtensions","getName","reloadAllExtensions","runnerName","reloadErrors","res","reloadExtensionBySourceDir","reloadError","Error","set","size","addonId","get","buildAndPushExtension","remoteFirefox","reloadAddon","registerCleanup","fn","add","exit","selectedAdbDevice","selectedArtifactsDir","exiting","clearArtifactsDir","getDeviceProfileDir","ignoredParam","devices","discoverDevices","devicesMsg","dev","foundDevices","device","JSON","stringify","packages","discoverInstalledFirefoxAPKs","pkgsListMsg","pkgs","pkg","selectedFirefoxApk","filteredPackages","pkgsList","amForceStopAPK","androidVersion","getAndroidVersionNumber","Number","isNaN","ensureRequiredAPKRuntimePermissions","profile","createProfile","app","getOrCreateArtifactsDir","deviceProfileDir","runShellCommand","pushFile","profileDir","startFirefoxAPK","extFileName","basename","adbExtensionPath","firefoxAndroidTimeout","stdin","unixSocketDiscoveryRetryInterval","unixSocketDiscoveryMaxTime","handleCtrlC","str","key","ctrl","setUserAbortDiscovery","isTTY","readline","emitKeypressEvents","setRawMode","on","selectedRDPSocketFile","discoverRDPUnixSocket","maxDiscoveryTime","retryInterval","removeListener","tcpPort","chooseLocalTcpPort","forwardSocketSpec","substr","setupForward","selectedTCPPort","srv","net","createServer","listen","freeTcpPort","address","port","close","client","extension","installTemporaryAddon","then","installResult","addon","FirefoxDesktopExtensionRunner","setupProfileDir","startFirefoxInstance","runningInfo","kill","useProfile","copyProfile","installExtension","asProxy","binaryArgs","urls","cleanupCb","debuggerPort","extensionRunners","promises","runner","reloadPromise","results","handleReloadResults","cleanupCallback","title","defaultWatcherCreator","reloadExtension","file","createWatcher","allowInput","watcher","watchedSourceDir","pause","keypressUsageInfo","userExit","keyPressed","once","pid","defaultAsyncFsStat","stat","defaultFirefoxEnv","XPCOM_DEBUG_BREAK","NS_TRACE_MALLOC_DISABLE_STACKS","defaultRemotePortFinder","portToTry","REMOTE_PORT","retriesLeft","connectToFirefox","defaultFirefoxConnector","disconnect","fxRunner","defaultFxRunner","findRemotePort","remotePort","env","binary","stderr","data","stdout","DEFAULT_PROFILES_NAMES","isDefaultProfile","profilePathOrName","ProfileFinder","FirefoxProfile","Finder","fsStat","baseProfileDir","locateUserDirectory","profilesIniPath","finder","readProfiles","promisify","normalizedProfileDirPath","normalize","sep","profiles","Name","Default","profileFullPath","IsRelative","Path","configureProfile","getPrefs","defaultPrefGetter","prefs","setPreference","customPrefsStr","custom","updatePreferences","defaultCreateProfileFinder","userDirectoryPath","FxProfile","getPath","profileName","hasProfileName","profileDef","configureThisProfile","isFirefoxDefaultProfile","createProfileFinder","isForbiddenProfile","destinationDirectory","getProfilePath","profileIsDirPath","isDirectory","profileDirectory","copyFromUserProfile","defaultUserProfileCopier","copy","copyByName","dirExists","asyncFsStat","extensionsDir","mkdir","isDir","destPath","writeStream","nodeFs","readStream","createReadStream","pipe","nonOverridablePreferences","prefsCommon","prefsFennec","prefsFirefox","common","fennec","appPrefs","coerceCLICustomPreference","cliPrefs","prefsAry","value","slice","test","parseInt","RemoteFirefox","checkedForAddonReloading","addonRequest","request","makeRequest","to","actor","response","addonPath","tabsResponse","addonsActor","installResponse","getInstalledAddon","addons","a","checkForAddonReloading","requestTypes","supportedRequestTypes","Date","toTimeString","connect","connectWithMaxRetries","maxRetries","establishConnection","lastError","retries","setTimeout","util","logger","main","cmd","envPrefix","Program","absolutePackageDir","yargsInstance","yargs","verboseEnabled","parserConfiguration","strict","commands","command","description","executor","commandOptions","yargsForCmd","demandCommand","exitProcess","setGlobalOptions","global","demandOption","enableVerboseMode","logStream","makeVerbose","execute","checkForUpdates","defaultUpdateChecker","systemProcess","defaultLogStream","getVersion","defaultVersionGetter","defaultApplyConfigToArgv","defaultConfigDiscovery","defaultLoadJSConfigFile","globalEnv","WEBEXT_BUILD_ENV","adjustedArgv","configFiles","configDiscovery","noConfigDiscovery","discoveredConfigs","niceFileList","packageData","readFileSync","parse","git","branch","long","defaultCommands","runOptions","program","usage","help","alias","describe","requiresArg","choices","wrapADBCall","asyncFn","adb","defaultADB","adbClient","createClient","bin","host","artifactsDirMap","userAbortDiscovery","deviceId","shell","readAll","listDevices","pmList","androidVersionNumber","apk","permissions","permissionsMap","perm","pmDumpLogs","now","testDirOut","delete","localPath","devicePath","transfer","startActivity","wait","action","component","extras","rdpUnixSockets","discoveryStartedAt","pop","remote","local","forward","defaultAsyncMkdirp","mkdirp","defaultAsyncFsAccess","access","asyncMkdirp","asyncFsAccess","stats","W_OK","accessErr","mkdirErr","defaultLog","showDesktopNotification","icon","notifier","defaultNotifier","notify","err","fileIsReadable","constants","R_OK","isFile","isSubPath","src","relate","relative","FileFilter","baseIgnoredPatterns","filesToIgnore","addToIgnoreList","resolveWithSourceDir","resolvedPath","files","charAt","resolvedFile","matches","multimatch","ConsoleStream","isCapturing","capturedMessages","format","level","prefix","nameFromLevel","packet","localProcess","thisLevel","bunyan","TRACE","INFO","startCapturing","stopCapturing","flushCapturedLogs","consoleStream","filename","createBunyanLog","defaultLogCreator","streams","manifestFile","manifestContents","applications","gecko","multiArgsPromisedFn","callerArgs","rest","rawMode","tmp","dir","createTempDir","makePromise","TempDir","create","successHandler","_path","_removeTempDir","unsafeCleanup","tmpPath","removeTempDir","remove","promiseResult","updateNotifier","defaultUpdateNotifier","updateCheckInterval","zipDirModule","Watchpack","executeImmediately","debounce","proxyFileChanges","watch"],"mappings":";;;AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,kDAA0C,gCAAgC;AAC1E;AACA;;AAEA;AACA;AACA;AACA,gEAAwD,kBAAkB;AAC1E;AACA,yDAAiD,cAAc;AAC/D;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iDAAyC,iCAAiC;AAC1E,wHAAgH,mBAAmB,EAAE;AACrI;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;;AAGA;AACA;;;;;;;;;;;;AClFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;AACH;AACA;;AAEA;AACA;;AAEA,iC;;;;;;;;;;;ACfA,qBAAqB,mBAAO,CAAC,iFAAkB;;AAE/C;AACA,iBAAiB,sBAAsB;AACvC;AACA;;AAEA;AACA;AACA;AACA,OAAO;AACP;;AAEA;AACA;AACA,KAAK;AACL;;AAEA;AACA;;AAEA,+B;;;;;;;;;;;ACrBA,iBAAiB,mBAAO,CAAC,8EAAe,E;;;;;;;;;;;ACAxC,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,aAAa,mBAAO,CAAC,wEAAU;AAC/B,UAAU,mBAAO,CAAC,kEAAO;AACzB,cAAc,mBAAO,CAAC,0EAAW;AACjC,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,8EAAa;;AAEzC;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,CAAC;;;;;;;;;;;;AC1HD,aAAa,mBAAO,CAAC,sBAAQ;AAC7B,aAAa,mBAAO,CAAC,wEAAU;;AAE/B;AACA;;AAEA;AACA;AACA;AACA;AACA,cAAc,OAAO;AACrB;AACA,cAAc,OAAO;AACrB;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,cAAc,OAAO;AACrB;AACA,cAAc,OAAO;AACrB;AACA,cAAc,SAAS;AACvB;AACA;AACA,cAAc,SAAS;AACvB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB,mBAAO,CAAC,4EAAY;AACrC;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;;AAED,+B;;;;;;;;;;;AClHA,UAAU,mBAAO,CAAC,gBAAK;AACvB,aAAa,mBAAO,CAAC,sBAAQ;AAC7B,aAAa,mBAAO,CAAC,wEAAU;;AAE/B,aAAa,mBAAO,CAAC,sBAAQ;;AAE7B;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,aAAa,OAAO;AACpB;AACA,aAAa,SAAS;AACtB;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,gCAAgC;AAChC;AACA,qDAAqD;AACrD;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;;AAEA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,CAAC;;;;;;;;;;;;ACtPD,aAAa,mBAAO,CAAC,4BAAW;AAChC,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,eAAe,mBAAO,CAAC,4EAAY;;AAEnC;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,oCAAoC,wBAAwB;AAC5D,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,mCAAmC,wBAAwB;AAC3D,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gCAAgC,aAAa;AAC7C;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,CAAC;;;;;;;;;;;;AC1GD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;AACL,GAAG;AACH;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;AACL;AACA,CAAC;;;;;;;;;;;;AC5BD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,WAAW,mBAAO,CAAC,0EAAW;;AAE9B;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;;AAEA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;;AAEA;AACA,KAAK;AACL,GAAG;;AAEH;AACA,sCAAsC,mBAAmB;AACzD;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAG;;AAEH;AACA,yCAAyC,+BAA+B;AACxE,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;;AAEA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,CAAC;;AAED;AACA;;AAEA;AACA;;AAEA,2CAA2C;;AAE3C;AACA;AACA;;AAEA,0CAA0C;;;;;;;;;;;;AChH1C,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,GAAG;AACH;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA,KAAK;AACL,sCAAsC,sBAAsB;AAC5D,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA,uCAAuC,qBAAqB;AAC5D;AACA,GAAG;;AAEH;AACA,0CAA0C,qBAAqB;AAC/D;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,CAAC;;AAED;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B,yBAAyB;AACpD;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,CAAC;;;;;;;;;;;;AC5KD;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAG,IAAI;AACP,C;;;;;;;;;;;ACXA,aAAa,mBAAO,CAAC,4BAAW;AAChC,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA,8BAA8B,aAAa;AAC3C;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,C;;;;;;;;;;;AC1FD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,CAAC;;;;;;;;;;;;ACfD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,oCAAoC,wBAAwB;AAC5D,GAAG;;AAEH;AACA,mCAAmC,wBAAwB;AAC3D,GAAG;;AAEH;AACA;;AAEA;AACA,GAAG;;AAEH;AACA,qCAAqC,mBAAmB;AACxD;AACA,KAAK;AACL;AACA,CAAC;;AAED;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,CAAC;;;;;;;;;;;;;;;;ACpGD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,UAAU,mBAAO,CAAC,kEAAO;;AAEzB;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,CAAC;;;;;;;;;;;;ACrBD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL,GAAG;;AAEH;AACA,mCAAmC,aAAa;AAChD;AACA,KAAK;AACL;AACA,CAAC;;AAED;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;;AAEA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL,GAAG;;AAEH;AACA,4BAA4B,+BAA+B;AAC3D,GAAG;;AAEH;AACA;AACA;AACA,CAAC;;AAED;AACA;AACA;;AAEA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,CAAC;;AAED;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,CAAC;;;;;;;;;;;;ACxHD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,cAAc,mBAAO,CAAC,0EAAW;AACjC,aAAa,mBAAO,CAAC,wEAAU;AAC/B,UAAU,mBAAO,CAAC,kEAAO;AACzB,cAAc,mBAAO,CAAC,0EAAW;AACjC,kBAAkB,mBAAO,CAAC,kFAAe;;AAEzC;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA,oCAAoC,iBAAiB;AACrD;AACA;AACA;;AAEA,6BAA6B,qCAAqC;AAClE;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA,gCAAgC,WAAW;AAC3C;AACA,CAAC;;;;;;;;;;;;ACtFD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,UAAU,mBAAO,CAAC,kEAAO;AACzB,SAAS,mBAAO,CAAC,cAAI;AACrB,YAAY,mBAAO,CAAC,oCAAe;;AAEnC;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA,4BAA4B,yBAAyB;AACrD,GAAG;AACH;AACA,2BAA2B,yBAAyB;AACpD,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;AACH;AACA,iCAAiC,yBAAyB;AAC1D;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;AACH;AACA;AACA;AACA,OAAO;AACP;AACA,oCAAoC;AACpC;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW,OAAO;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,OAAO;AACP;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,qDAAqD;AACrD;AACA,GAAG;AACH;AACA;AACA,+BAA+B,4BAA4B;AAC3D;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT,KAAK;AACL,GAAG;AACH;AACA;AACA;AACA;AACA,gFAAgF,gBAAgB;AAChG;AACA;AACA;AACA;AACA,qGAAqG,gBAAgB;AACrH;AACA;AACA;AACA;AACA,+BAA+B,aAAa;AAC5C;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,GAAG;AACH;AACA,+BAA+B,yBAAyB;AACxD;AACA,CAAC;;;;;;;;;;;;;ACzKY;;AAEb;AACA;AACA,cAAc,mBAAO,CAAC,gCAAa;AACnC,oBAAoB,mBAAO,CAAC,oFAA2B;;AAEvD;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA,GAAG;AACH;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;CAKA;;AAKA,MAAMA,GAAG,GAAGC,kEAAY,CAACC,UAAD,CAAxB;AAGO,SAAS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","file":"web-ext.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/main.js\");\n","function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nmodule.exports = _defineProperty;","var defineProperty = require(\"./defineProperty\");\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n    var ownKeys = Object.keys(source);\n\n    if (typeof Object.getOwnPropertySymbols === 'function') {\n      ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(source, sym).enumerable;\n      }));\n    }\n\n    ownKeys.forEach(function (key) {\n      defineProperty(target, key, source[key]);\n    });\n  }\n\n  return target;\n}\n\nmodule.exports = _objectSpread;","module.exports = require(\"./lib/browser\");","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    Client = require(\"./client\"),\n    Tab = require(\"./tab\"),\n    Webapps = require(\"./webapps\"),\n    Device = require(\"./device\"),\n    SimulatorApps = require(\"./simulator\");\n\nconst DEFAULT_PORT = 6000;\nconst DEFAULT_HOST = \"localhost\";\n\nmodule.exports = FirefoxClient;\n\nfunction FirefoxClient(options) {\n  var client = new Client(options);\n  var actor = 'root';\n\n  client.on(\"error\", this.onError.bind(this));\n  client.on(\"end\", this.onEnd.bind(this));\n  client.on(\"timeout\", this.onTimeout.bind(this));\n\n  this.initialize(client, actor);\n}\n\nFirefoxClient.prototype = extend(ClientMethods, {\n  connect: function(port, host, cb) {\n    if (typeof port == \"function\") {\n      // (cb)\n      cb = port;\n      port = DEFAULT_PORT;\n      host = DEFAULT_HOST;\n\n    }\n    if (typeof host == \"function\") {\n      // (port, cb)\n      cb = host;\n      host = DEFAULT_HOST;\n    }\n    // (port, host, cb)\n\n    this.client.connect(port, host, cb);\n\n    this.client.expectReply(this.actor, function(packet) {\n      // root message\n    });\n  },\n\n  disconnect: function() {\n    this.client.disconnect();\n  },\n\n  onError: function(error) {\n    this.emit(\"error\", error);\n  },\n\n  onEnd: function() {\n    this.emit(\"end\");\n  },\n\n  onTimeout: function() {\n    this.emit(\"timeout\");\n  },\n\n  selectedTab: function(cb) {\n    this.request(\"listTabs\", function(resp) {\n      var tab = resp.tabs[resp.selected];\n      return new Tab(this.client, tab);\n    }.bind(this), cb);\n  },\n\n  listTabs: function(cb) {\n    this.request(\"listTabs\", function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n\n      if (resp.simulatorWebappsActor) {\n        // the server is the Firefox OS Simulator, return apps as \"tabs\"\n        var apps = new SimulatorApps(this.client, resp.simulatorWebappsActor);\n        apps.listApps(cb);\n      }\n      else {\n        var tabs = resp.tabs.map(function(tab) {\n          return new Tab(this.client, tab);\n        }.bind(this));\n        cb(null, tabs);\n      }\n    }.bind(this));\n  },\n\n  getWebapps: function(cb) {\n    this.request(\"listTabs\", (function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n      var webapps = new Webapps(this.client, resp);\n      cb(null, webapps);\n    }).bind(this));\n  },\n\n  getDevice: function(cb) {\n    this.request(\"listTabs\", (function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n      var device = new Device(this.client, resp);\n      cb(null, device);\n    }).bind(this));\n  },\n\n  getRoot: function(cb) {\n    this.request(\"listTabs\", (function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n      if (!resp.consoleActor) {\n        return cb(\"No root actor being available.\");\n      }\n      var root = new Tab(this.client, resp);\n      cb(null, root);\n    }).bind(this));\n  }\n})\n","var events = require(\"events\"),\n    extend = require(\"./extend\");\n\n// to be instantiated later - to avoid circular dep resolution\nvar JSObject;\n\nvar ClientMethods = extend(events.EventEmitter.prototype, {\n  /**\n   * Intialize this client object.\n   *\n   * @param  {object} client\n   *         Client to send requests on.\n   * @param  {string} actor\n   *         Actor id to set as 'from' field on requests\n   */\n  initialize: function(client, actor) {\n    this.client = client;\n    this.actor = actor;\n\n    this.client.on('message', function(message) {\n      if (message.from == this.actor) {\n        this.emit(message.type, message);\n      }\n    }.bind(this));\n  },\n\n  /**\n   * Make request to our actor on the server.\n   *\n   * @param  {string}   type\n   *         Method name of the request\n   * @param  {object}   message\n   *         Optional extra properties (arguments to method)\n   * @param  {Function}   transform\n   *         Optional tranform for response object. Takes response object\n   *         and returns object to send on.\n   * @param  {Function} callback\n   *         Callback to call with (maybe transformed) response\n   */\n  request: function(type, message, transform, callback) {\n    if (typeof message == \"function\") {\n      if (typeof transform == \"function\") {\n        // (type, trans, cb)\n        callback = transform;\n        transform = message;\n      }\n      else {\n        // (type, cb)\n        callback = message;\n      }\n      message = {};\n    }\n    else if (!callback) {\n      if (!message) {\n        // (type)\n        message = {};\n      }\n      // (type, message, cb)\n      callback = transform;\n      transform = null;\n    }\n\n    message.to = this.actor;\n    message.type = type;\n\n    this.client.makeRequest(message, function(resp) {\n      delete resp.from;\n\n      if (resp.error) {\n        var err = new Error(resp.message);\n        err.name = resp.error;\n\n        callback(err);\n        return;\n      }\n\n      if (transform) {\n        resp = transform(resp);\n      }\n\n      if (callback) {\n        callback(null, resp);\n      }\n    });\n  },\n\n  /*\n   * Transform obj response into a JSObject\n   */\n  createJSObject: function(obj) {\n    if (obj == null) {\n      return;\n    }\n    if (!JSObject) {\n      // circular dependencies\n      JSObject = require(\"./jsobject\");\n    }\n    if (obj.type == \"object\") {\n      return new JSObject(this.client, obj);\n    }\n    return obj;\n  },\n\n  /**\n   * Create function that plucks out only one value from an object.\n   * Used as the transform function for some responses.\n   */\n  pluck: function(prop) {\n    return function(obj) {\n      return obj[prop];\n    }\n  }\n})\n\nmodule.exports = ClientMethods;","var net = require(\"net\"),\n    events = require(\"events\"),\n    extend = require(\"./extend\");\n\nvar colors = require(\"colors\");\n\nmodule.exports = Client;\n\n// this is very unfortunate! and temporary. we can't\n// rely on 'type' property to signify an event, and we\n// need to write clients for each actor to handle differences\n// in actor protocols\nvar unsolicitedEvents = {\n  \"tabNavigated\": \"tabNavigated\",\n  \"styleApplied\": \"styleApplied\",\n  \"propertyChange\": \"propertyChange\",\n  \"networkEventUpdate\": \"networkEventUpdate\",\n  \"networkEvent\": \"networkEvent\",\n  \"propertyChange\": \"propertyChange\",\n  \"newMutations\": \"newMutations\",\n  \"appOpen\": \"appOpen\",\n  \"appClose\": \"appClose\",\n  \"appInstall\": \"appInstall\",\n  \"appUninstall\": \"appUninstall\",\n  \"frameUpdate\": \"frameUpdate\",\n  \"tabListChanged\": \"tabListChanged\"\n};\n\n/**\n * a Client object handles connecting with a Firefox remote debugging\n * server instance (e.g. a Firefox instance), plus sending and receiving\n * packets on that conection using the Firefox remote debugging protocol.\n *\n * Important methods:\n * connect - Create the connection to the server.\n * makeRequest - Make a request to the server with a JSON message,\n *   and a callback to call with the response.\n *\n * Important events:\n * 'message' - An unsolicited (e.g. not a response to a prior request)\n *    packet has been received. These packets usually describe events.\n */\nfunction Client(options) {\n  this.options = options || {};\n\n  this.incoming = new Buffer(\"\");\n\n  this._pendingRequests = [];\n  this._activeRequests = {};\n}\n\nClient.prototype = extend(events.EventEmitter.prototype, {\n  connect: function(port, host, cb) {\n    this.client = net.createConnection({\n      port: port,\n      host: host\n    });\n\n    this.client.on(\"connect\", cb);\n    this.client.on(\"data\", this.onData.bind(this));\n    this.client.on(\"error\", this.onError.bind(this));\n    this.client.on(\"end\", this.onEnd.bind(this));\n    this.client.on(\"timeout\", this.onTimeout.bind(this));\n  },\n\n  disconnect: function() {\n    if (this.client) {\n      this.client.end();\n    }\n  },\n\n  /**\n   * Set a request to be sent to an actor on the server. If the actor\n   * is already handling a request, queue this request until the actor\n   * has responded to the previous request.\n   *\n   * @param {object} request\n   *        Message to be JSON-ified and sent to server.\n   * @param {function} callback\n   *        Function that's called with the response from the server.\n   */\n  makeRequest: function(request, callback) {\n    this.log(\"request: \" + JSON.stringify(request).green);\n\n    if (!request.to) {\n      var type = request.type || \"\";\n      throw new Error(type + \" request packet has no destination.\");\n    }\n    this._pendingRequests.push({ to: request.to,\n                                 message: request,\n                                 callback: callback });\n    this._flushRequests();\n  },\n\n  /**\n   * Activate (send) any pending requests to actors that don't have an\n   * active request.\n   */\n  _flushRequests: function() {\n    this._pendingRequests = this._pendingRequests.filter(function(request) {\n      // only one active request per actor at a time\n      if (this._activeRequests[request.to]) {\n        return true;\n      }\n\n      // no active requests for this actor, so activate this one\n      this.sendMessage(request.message);\n      this.expectReply(request.to, request.callback);\n\n      // remove from pending requests\n      return false;\n    }.bind(this));\n  },\n\n  /**\n   * Send a JSON message over the connection to the server.\n   */\n  sendMessage: function(message) {\n    if (!message.to) {\n      throw new Error(\"No actor specified in request\");\n    }\n    if (!this.client) {\n      throw new Error(\"Not connected, connect() before sending requests\");\n    }\n    var str = JSON.stringify(message);\n\n    // message is preceded by byteLength(message):\n    str = (new Buffer(str).length) + \":\" + str;\n\n    this.client.write(str);\n  },\n\n  /**\n   * Arrange to hand the next reply from |actor| to |handler|.\n   */\n  expectReply: function(actor, handler) {\n    if (this._activeRequests[actor]) {\n      throw Error(\"clashing handlers for next reply from \" + uneval(actor));\n    }\n    this._activeRequests[actor] = handler;\n  },\n\n  /**\n   * Handler for a new message coming in. It's either an unsolicited event\n   * from the server, or a response to a previous request from the client.\n   */\n  handleMessage: function(message) {\n    if (!message.from) {\n      if (message.error) {\n        throw new Error(message.message);\n      }\n      throw new Error(\"Server didn't specify an actor: \" + JSON.stringify(message));\n    }\n\n    if (!(message.type in unsolicitedEvents)\n        && this._activeRequests[message.from]) {\n      this.log(\"response: \" + JSON.stringify(message).yellow);\n\n      var callback = this._activeRequests[message.from];\n      delete this._activeRequests[message.from];\n\n      callback(message);\n\n      this._flushRequests();\n    }\n    else if (message.type) {\n      // this is an unsolicited event from the server\n      this.log(\"unsolicited event: \".grey + JSON.stringify(message).grey);\n\n      this.emit('message', message);\n      return;\n    }\n    else {\n      throw new Error(\"Unexpected packet from actor \" +  message.from\n      +  JSON.stringify(message));\n    }\n  },\n\n  /**\n   * Called when a new data chunk is received on the connection.\n   * Parse data into message(s) and call message handler for any full\n   * messages that are read in.\n   */\n  onData: function(data) {\n    this.incoming = Buffer.concat([this.incoming, data]);\n\n    while(this.readMessage()) {};\n  },\n\n  /**\n   * Parse out and process the next message from the data read from\n   * the connection. Returns true if a full meassage was parsed, false\n   * otherwise.\n   */\n  readMessage: function() {\n    var sep = this.incoming.toString().indexOf(':');\n    if (sep < 0) {\n      return false;\n    }\n\n    // beginning of a message is preceded by byteLength(message) + \":\"\n    var count = parseInt(this.incoming.slice(0, sep));\n\n    if (this.incoming.length - (sep + 1) < count) {\n      this.log(\"no complete response yet\".grey);\n      return false;\n    }\n    this.incoming = this.incoming.slice(sep + 1);\n\n    var packet = this.incoming.slice(0, count);\n\n    this.incoming = this.incoming.slice(count);\n\n    var message;\n    try {\n      message = JSON.parse(packet.toString());\n    } catch(e) {\n      throw new Error(\"Couldn't parse packet from server as JSON \" + e\n        + \", message:\\n\" + packet);\n    }\n    this.handleMessage(message);\n\n    return true;\n  },\n\n  onError: function(error) {\n    var code = error.code ? error.code : error;\n    this.log(\"connection error: \".red + code.red);\n    this.emit(\"error\", error);\n  },\n\n  onEnd: function() {\n    this.log(\"connection closed by server\".red);\n    this.emit(\"end\");\n  },\n\n  onTimeout: function() {\n    this.log(\"connection timeout\".red);\n    this.emit(\"timeout\");\n  },\n\n  log: function(str) {\n    if (this.options.log) {\n      console.log(str);\n    }\n  }\n})\n","var select = require(\"js-select\"),\n    extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    JSObject = require(\"./jsobject\");\n\nmodule.exports = Console;\n\nfunction Console(client, actor) {\n  this.initialize(client, actor);\n\n  this.on(\"consoleAPICall\", this.onConsoleAPI.bind(this));\n  this.on(\"pageError\", this.onPageError.bind(this));\n}\n\nConsole.prototype = extend(ClientMethods, {\n  types: [\"PageError\", \"ConsoleAPI\"],\n\n  /**\n   * Response object:\n   *   -empty-\n   */\n  startListening: function(cb) {\n    this.request('startListeners', { listeners: this.types }, cb);\n  },\n\n  /**\n   * Response object:\n   *   -empty-\n   */\n  stopListening: function(cb) {\n    this.request('stopListeners', { listeners: this.types }, cb);\n  },\n\n  /**\n   * Event object:\n   *   level - \"log\", etc.\n   *   filename - file with call\n   *   lineNumber - line number of call\n   *   functionName - function log called from\n   *   timeStamp - ms timestamp of call\n   *   arguments - array of the arguments to log call\n   *   private -\n   */\n  onConsoleAPI: function(event) {\n    var message = this.transformConsoleCall(event.message);\n\n    this.emit(\"console-api-call\", message);\n  },\n\n  /**\n   * Event object:\n   *   errorMessage - string error message\n   *   sourceName - file error\n   *   lineText\n   *   lineNumber - line number of error\n   *   columnNumber - column number of error\n   *   category - usually \"content javascript\",\n   *   timeStamp - time in ms of error occurance\n   *   warning - whether it's a warning\n   *   error - whether it's an error\n   *   exception - whether it's an exception\n   *   strict -\n   *   private -\n   */\n  onPageError: function(event) {\n    this.emit(\"page-error\", event.pageError);\n  },\n\n  /**\n   * Response object: array of page error or console call objects.\n   */\n  getCachedLogs: function(cb) {\n    var message = {\n      messageTypes: this.types\n    };\n    this.request('getCachedMessages', message, function(resp) {\n      select(resp, \".messages > *\").update(this.transformConsoleCall.bind(this));\n      return resp.messages;\n    }.bind(this), cb);\n  },\n\n  /**\n   * Response object:\n   *   -empty-\n   */\n  clearCachedLogs: function(cb) {\n    this.request('clearMessagesCache', cb);\n  },\n\n  /**\n   * Response object:\n   *   input - original input\n   *   result - result of the evaluation, a value or JSObject\n   *   timestamp - timestamp in ms of the evaluation\n   *   exception - any exception as a result of the evaluation\n   */\n  evaluateJS: function(text, cb) {\n    this.request('evaluateJS', { text: text }, function(resp) {\n      return select(resp, \".result, .exception\")\n             .update(this.createJSObject.bind(this));\n    }.bind(this), cb)\n  },\n\n  transformConsoleCall: function(message) {\n    return select(message, \".arguments > *\").update(this.createJSObject.bind(this));\n  }\n})\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\");\n\nmodule.exports = Device;\n\nfunction Device(client, tab) {\n  this.initialize(client, tab.deviceActor);\n}\n\nDevice.prototype = extend(ClientMethods, {\n  getDescription: function(cb) {\n    this.request(\"getDescription\", function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n\n      cb(null, resp.value);\n    });\n  },\n  getRawPermissionsTable: function(cb) {\n    this.request(\"getRawPermissionsTable\", function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n\n      cb(null, resp.value.rawPermissionsTable);\n    });\n  }\n})\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    Node = require(\"./domnode\");\n\nmodule.exports = DOM;\n\nfunction DOM(client, actor) {\n  this.initialize(client, actor);\n  this.walker = null;\n}\n\nDOM.prototype = extend(ClientMethods, {\n  document: function(cb) {\n    this.walkerRequest(\"document\", function(err, resp) {\n      if (err) return cb(err);\n\n      var node = new Node(this.client, this.walker, resp.node);\n      cb(null, node);\n    }.bind(this))\n  },\n\n  documentElement: function(cb) {\n    this.walkerRequest(\"documentElement\", function(err, resp) {\n      var node = new Node(this.client, this.walker, resp.node);\n      cb(err, node);\n    }.bind(this))\n  },\n\n  querySelector: function(selector, cb) {\n    this.document(function(err, node) {\n      if (err) return cb(err);\n\n      node.querySelector(selector, cb);\n    })\n  },\n\n  querySelectorAll: function(selector, cb) {\n    this.document(function(err, node) {\n      if (err) return cb(err);\n\n      node.querySelectorAll(selector, cb);\n    })\n  },\n\n  getComputedStyle: function(node, cb) {\n    this.styleRequest(\"getComputed\", { node: node.actor },\n                      this.pluck('computed'), cb);\n  },\n\n  getUsedFontFaces: function(node, options, cb) {\n    var message = {\n      node: node.actor,\n      includePreviews: options.includePreviews,\n      previewText: options.previewText,\n      previewFontSize: options.previewFontSize\n    };\n\n    this.styleRequest(\"getUsedFontFaces\", message,\n                      this.pluck('fontFaces'), cb);\n  },\n\n  getFontPreview: function(node, font, cb) {\n    this.styleRequest(\"getFontPreview\", { node: node.actor, font: font }, cb);\n  },\n\n  walkerRequest: function(type, message, cb) {\n    this.getWalker(function(err, walker) {\n      walker.request(type, message, cb);\n    });\n  },\n\n  getWalker: function(cb) {\n    if (this.walker) {\n      return cb(null, this.walker);\n    }\n    this.request('getWalker', function(err, resp) {\n      this.walker = new Walker(this.client, resp.walker);\n      cb(err, this.walker);\n    }.bind(this))\n  },\n\n  styleRequest: function(type, message, transform, cb) {\n    this.getStyle(function(err, style) {\n      if (err) throw err;\n\n      style.request(type, message, transform, cb);\n    })\n  },\n\n  getStyle: function(cb) {\n    if (this.style) {\n      return cb(null, this.style);\n    }\n    this.request('getPageStyle', function(err, resp) {\n      this.style = new Style(this.client, resp.pageStyle);\n      cb(err, this.style);\n    }.bind(this))\n  }\n})\n\nfunction Walker(client, walker) {\n  this.initialize(client, walker.actor);\n\n  this.root = new Node(client, this, walker.root);\n}\n\nWalker.prototype = extend(ClientMethods, {});\n\nfunction Style(client, style) {\n  this.initialize(client, style.actor);\n}\n\nStyle.prototype = extend(ClientMethods, {});\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\");\n\nmodule.exports = Node;\n\nfunction Node(client, walker, node) {\n  this.initialize(client, node.actor);\n  this.walker = walker;\n\n  this.getNode = this.getNode.bind(this);\n  this.getNodeArray = this.getNodeArray.bind(this);\n  this.getNodeList = this.getNodeList.bind(this);\n\n  walker.on('newMutations', function(event) {\n    //console.log(\"on new mutations! \", JSON.stringify(event));\n  });\n\n  ['nodeType', 'nodeName', 'namespaceURI', 'attrs']\n  .forEach(function(attr) {\n    this[attr] = node[attr];\n  }.bind(this));\n}\n\nNode.prototype = extend(ClientMethods, {\n  getAttribute: function(name) {\n    for (var i in this.attrs) {\n      var attr = this.attrs[i];\n      if (attr.name == name) {\n        return attr.value;\n      }\n    }\n  },\n\n  setAttribute: function(name, value, cb) {\n    var mods = [{\n      attributeName: name,\n      newValue: value\n    }];\n    this.request('modifyAttributes', { modifications: mods }, cb);\n  },\n\n  parentNode: function(cb) {\n    this.parents(function(err, nodes) {\n      if (err) {\n        return cb(err);\n      }\n      var node = null;\n      if (nodes.length) {\n        node = nodes[0];\n      }\n      cb(null, node);\n    })\n  },\n\n  parents: function(cb) {\n    this.nodeRequest('parents', this.getNodeArray, cb);\n  },\n\n  children: function(cb) {\n    this.nodeRequest('children', this.getNodeArray, cb);\n  },\n\n  siblings: function(cb) {\n    this.nodeRequest('siblings', this.getNodeArray, cb);\n  },\n\n  nextSibling: function(cb) {\n    this.nodeRequest('nextSibling', this.getNode, cb);\n  },\n\n  previousSibling: function(cb) {\n    this.nodeRequest('previousSibling', this.getNode, cb);\n  },\n\n  querySelector: function(selector, cb) {\n    this.nodeRequest('querySelector', { selector: selector },\n                     this.getNode, cb);\n  },\n\n  querySelectorAll: function(selector, cb) {\n    this.nodeRequest('querySelectorAll', { selector: selector },\n                     this.getNodeList, cb);\n  },\n\n  getUniqueSelector: function(cb) {\n    this.request('getUniqueSelector', cb);\n  },\n\n  innerHTML: function(cb) {\n    this.nodeRequest('innerHTML', function(resp) {\n      return resp.value;\n    }, cb)\n  },\n\n  outerHTML: function(cb) {\n    this.nodeRequest('outerHTML', function(resp) {\n      return resp.value;\n    }, cb)\n  },\n\n  remove: function(cb) {\n    this.nodeRequest('removeNode', function(resp) {\n      return new Node(this.client, this.walker, resp.nextSibling);\n    }.bind(this), cb);\n  },\n\n  highlight: function(cb) {\n    this.nodeRequest('highlight', cb);\n  },\n\n  release: function(cb) {\n    this.nodeRequest('releaseNode', cb);\n  },\n\n  getNode: function(resp) {\n    if (resp.node) {\n      return new Node(this.client, this.walker, resp.node);\n    }\n    return null;\n  },\n\n  getNodeArray: function(resp) {\n    return resp.nodes.map(function(form) {\n      return new Node(this.client, this.walker, form);\n    }.bind(this));\n  },\n\n  getNodeList: function(resp) {\n    return new NodeList(this.client, this.walker, resp.list);\n  },\n\n  nodeRequest: function(type, message, transform, cb) {\n    if (!cb) {\n      cb = transform;\n      transform = message;\n      message = {};\n    }\n    message.node = this.actor;\n\n    this.walker.request(type, message, transform, cb);\n  }\n});\n\nfunction NodeList(client, walker, list) {\n  this.client = client;\n  this.walker = walker;\n  this.actor = list.actor;\n\n  this.length = list.length;\n}\n\nNodeList.prototype = extend(ClientMethods, {\n  items: function(start, end, cb) {\n    if (typeof start == \"function\") {\n      cb = start;\n      start = 0;\n      end = this.length;\n    }\n    else if (typeof end == \"function\") {\n      cb = end;\n      end = this.length;\n    }\n    this.request('items', { start: start, end: end },\n      this.getNodeArray.bind(this), cb);\n  },\n\n  // TODO: add this function to ClientMethods\n  getNodeArray: function(resp) {\n    return resp.nodes.map(function(form) {\n      return new Node(this.client, this.walker, form);\n    }.bind(this));\n  }\n});\n","module.exports = function extend(prototype, properties) {\n  return Object.create(prototype, getOwnPropertyDescriptors(properties));\n}\n\nfunction getOwnPropertyDescriptors(object) {\n  var names = Object.getOwnPropertyNames(object);\n\n  return names.reduce(function(descriptor, name) {\n    descriptor[name] = Object.getOwnPropertyDescriptor(object, name);\n    return descriptor;\n  }, {});\n}","var select = require(\"js-select\"),\n    extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\");\n\nmodule.exports = JSObject;\n\nfunction JSObject(client, obj) {\n  this.initialize(client, obj.actor);\n  this.obj = obj;\n}\n\nJSObject.prototype = extend(ClientMethods, {\n  type: \"object\",\n\n  get class() {\n    return this.obj.class;\n  },\n\n  get name() {\n    return this.obj.name;\n  },\n\n  get displayName() {\n    return this.obj.displayName;\n  },\n\n  ownPropertyNames: function(cb) {\n    this.request('ownPropertyNames', function(resp) {\n      return resp.ownPropertyNames;\n    }, cb);\n  },\n\n  ownPropertyDescriptor: function(name, cb) {\n    this.request('property', { name: name }, function(resp) {\n      return this.transformDescriptor(resp.descriptor);\n    }.bind(this), cb);\n  },\n\n  ownProperties: function(cb) {\n    this.request('prototypeAndProperties', function(resp) {\n      return this.transformProperties(resp.ownProperties);\n    }.bind(this), cb);\n  },\n\n  prototype: function(cb) {\n    this.request('prototype', function(resp) {\n      return this.createJSObject(resp.prototype);\n    }.bind(this), cb);\n  },\n\n  ownPropertiesAndPrototype: function(cb) {\n    this.request('prototypeAndProperties', function(resp) {\n      resp.ownProperties = this.transformProperties(resp.ownProperties);\n      resp.safeGetterValues = this.transformGetters(resp.safeGetterValues);\n      resp.prototype = this.createJSObject(resp.prototype);\n\n      return resp;\n    }.bind(this), cb);\n  },\n\n  /* helpers */\n  transformProperties: function(props) {\n    var transformed = {};\n    for (var prop in props) {\n      transformed[prop] = this.transformDescriptor(props[prop]);\n    }\n    return transformed;\n  },\n\n  transformGetters: function(getters) {\n    var transformed = {};\n    for (var prop in getters) {\n      transformed[prop] = this.transformGetter(getters[prop]);\n    }\n    return transformed;\n  },\n\n  transformDescriptor: function(descriptor) {\n    descriptor.value = this.createJSObject(descriptor.value);\n    return descriptor;\n  },\n\n  transformGetter: function(getter) {\n    return {\n      value: this.createJSObject(getter.getterValue),\n      prototypeLevel: getter.getterPrototypeLevel,\n      enumerable: getter.enumerable,\n      writable: getter.writable\n    }\n  }\n})","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\");\n\nmodule.exports = Memory;\n\nfunction Memory(client, actor) {\n  this.initialize(client, actor);\n}\n\nMemory.prototype = extend(ClientMethods, {\n  measure: function(cb) {\n    this.request('measure', function (err, resp) {\n      cb(err, resp);\n    });\n  }\n})\n","var extend = require(\"./extend\");\nvar ClientMethods = require(\"./client-methods\");\n\nmodule.exports = Network;\n\nfunction Network(client, actor) {\n  this.initialize(client, actor);\n\n  this.on(\"networkEvent\", this.onNetworkEvent.bind(this));\n}\n\nNetwork.prototype = extend(ClientMethods, {\n  types: [\"NetworkActivity\"],\n\n  startLogging: function(cb) {\n    this.request('startListeners', { listeners: this.types }, cb);\n  },\n\n  stopLogging: function(cb) {\n    this.request('stopListeners', { listeners: this.types }, cb);\n  },\n\n  onNetworkEvent: function(event) {\n    var networkEvent = new NetworkEvent(this.client, event.eventActor);\n\n    this.emit(\"network-event\", networkEvent);\n  },\n\n  sendHTTPRequest: function(request, cb) {\n    this.request('sendHTTPRequest', { request: request }, function(resp) {\n      return new NetworkEvent(this.client, resp.eventActor);\n    }.bind(this), cb);\n  }\n})\n\nfunction NetworkEvent(client, event) {\n  this.initialize(client, event.actor);\n  this.event = event;\n\n  this.on(\"networkEventUpdate\", this.onUpdate.bind(this));\n}\n\nNetworkEvent.prototype = extend(ClientMethods, {\n  get url() {\n   return this.event.url;\n  },\n\n  get method() {\n    return this.event.method;\n  },\n\n  get isXHR() {\n    return this.event.isXHR;\n  },\n\n  getRequestHeaders: function(cb) {\n    this.request('getRequestHeaders', cb);\n  },\n\n  getRequestCookies: function(cb) {\n    this.request('getRequestCookies', this.pluck('cookies'), cb);\n  },\n\n  getRequestPostData: function(cb) {\n    this.request('getRequestPostData', cb);\n  },\n\n  getResponseHeaders: function(cb) {\n    this.request('getResponseHeaders', cb);\n  },\n\n  getResponseCookies: function(cb) {\n    this.request('getResponseCookies', this.pluck('cookies'), cb);\n  },\n\n  getResponseContent: function(cb) {\n    this.request('getResponseContent', cb);\n  },\n\n  getEventTimings: function(cb) {\n    this.request('getEventTimings', cb);\n  },\n\n  onUpdate: function(event) {\n    var types = {\n      \"requestHeaders\": \"request-headers\",\n      \"requestCookies\": \"request-cookies\",\n      \"requestPostData\": \"request-postdata\",\n      \"responseStart\": \"response-start\",\n      \"responseHeaders\": \"response-headers\",\n      \"responseCookies\": \"response-cookies\",\n      \"responseContent\": \"response-content\",\n      \"eventTimings\": \"event-timings\"\n    }\n\n    var type = types[event.updateType];\n    delete event.updateType;\n\n    this.emit(type, event);\n  }\n})\n\n\n\n\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    Tab = require(\"./tab\");\n\nmodule.exports = SimulatorApps;\n\nfunction SimulatorApps(client, actor) {\n  this.initialize(client, actor);\n}\n\nSimulatorApps.prototype = extend(ClientMethods, {\n  listApps: function(cb) {\n    this.request('listApps', function(resp) {\n      var apps = [];\n      for (var url in resp.apps) {\n        var app = resp.apps[url];\n        apps.push(new Tab(this.client, app));\n      }\n      return apps;\n    }.bind(this), cb);\n  }\n})\n","var extend = require(\"./extend\");\nvar ClientMethods = require(\"./client-methods\");\n\nmodule.exports = StyleSheets;\n\nfunction StyleSheets(client, actor) {\n  this.initialize(client, actor);\n}\n\nStyleSheets.prototype = extend(ClientMethods, {\n  getStyleSheets: function(cb) {\n    this.request('getStyleSheets', function(resp) {\n      return resp.styleSheets.map(function(sheet) {\n        return new StyleSheet(this.client, sheet);\n      }.bind(this));\n    }.bind(this), cb);\n  },\n\n  addStyleSheet: function(text, cb) {\n    this.request('addStyleSheet', { text: text }, function(resp) {\n      return new StyleSheet(this.client, resp.styleSheet);\n    }.bind(this), cb);\n  }\n})\n\nfunction StyleSheet(client, sheet) {\n  this.initialize(client, sheet.actor);\n  this.sheet = sheet;\n\n  this.on(\"propertyChange\", this.onPropertyChange.bind(this));\n}\n\nStyleSheet.prototype = extend(ClientMethods, {\n  get href() {\n    return this.sheet.href;\n  },\n\n  get disabled() {\n    return this.sheet.disabled;\n  },\n\n  get ruleCount() {\n    return this.sheet.ruleCount;\n  },\n\n  onPropertyChange: function(event) {\n    this.sheet[event.property] = event.value;\n    this.emit(event.property + \"-changed\", event.value);\n  },\n\n  toggleDisabled: function(cb) {\n    this.request('toggleDisabled', function(err, resp) {\n      if (err) return cb(err);\n\n      this.sheet.disabled = resp.disabled;\n      cb(null, resp.disabled);\n    }.bind(this));\n  },\n\n  getOriginalSources: function(cb) {\n    this.request('getOriginalSources', function(resp) {\n      if (resp.originalSources === null) {\n        return [];\n      }\n      return resp.originalSources.map(function(form) {\n        return new OriginalSource(this.client, form);\n      }.bind(this));\n    }.bind(this), cb);\n  },\n\n  getMediaRules: function(cb) {\n    this.request('getMediaRules', function(resp) {\n      return resp.mediaRules.map(function(form) {\n        return new MediaRule(this.client, form);\n      }.bind(this));\n    }.bind(this), cb);\n  },\n\n  update: function(text, cb) {\n    this.request('update', { text: text, transition: true }, cb);\n  },\n\n  getText: function(cb) {\n    this.request('getText', this.pluck('text'), cb);\n  }\n});\n\nfunction MediaRule(client, rule) {\n  this.initialize(client, rule.actor);\n  this.rule = rule;\n\n  this.on(\"matchesChange\", function(event) {\n    this.emit(\"matches-change\", event.matches);\n  }.bind(this));\n}\nMediaRule.prototype = extend(ClientMethods, {\n  get mediaText() {\n    return this.rule.mediaText;\n  },\n\n  get matches() {\n    return this.rule.matches;\n  }\n})\n\nfunction OriginalSource(client, source) {\n  console.log(\"source\", source);\n  this.initialize(client, source.actor);\n\n  this.source = source;\n}\n\nOriginalSource.prototype = extend(ClientMethods, {\n  get url()  {\n    return this.source.url\n  },\n\n  getText: function(cb) {\n    this.request('getText', this.pluck('text'), cb);\n  }\n});\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    Console = require(\"./console\"),\n    Memory = require(\"./memory\"),\n    DOM = require(\"./dom\"),\n    Network = require(\"./network\"),\n    StyleSheets = require(\"./stylesheets\");\n\nmodule.exports = Tab;\n\nfunction Tab(client, tab) {\n  this.initialize(client, tab.actor);\n\n  this.tab = tab;\n  this.updateInfo(tab);\n\n  this.on(\"tabNavigated\", this.onTabNavigated.bind(this));\n}\n\nTab.prototype = extend(ClientMethods, {\n  updateInfo: function(form) {\n    this.url = form.url;\n    this.title = form.title;\n  },\n\n  get StyleSheets() {\n    if (!this._StyleSheets) {\n      this._StyleSheets = new StyleSheets(this.client, this.tab.styleSheetsActor);\n    }\n    return this._StyleSheets;\n  },\n\n  get DOM() {\n    if (!this._DOM) {\n      this._DOM = new DOM(this.client, this.tab.inspectorActor);\n    }\n    return this._DOM;\n  },\n\n  get Network() {\n    if (!this._Network) {\n      this._Network = new Network(this.client, this.tab.consoleActor);\n    }\n    return this._Network;\n  },\n\n  get Console() {\n    if (!this._Console) {\n      this._Console = new Console(this.client, this.tab.consoleActor);\n    }\n    return this._Console;\n  },\n\n  get Memory() {\n    if (!this._Memory) {\n      this._Memory = new Memory(this.client, this.tab.memoryActor);\n    }\n    return this._Memory;\n  },\n\n  onTabNavigated: function(event) {\n    if (event.state == \"start\") {\n      this.emit(\"before-navigate\", { url: event.url });\n    }\n    else if (event.state == \"stop\") {\n      this.updateInfo(event);\n\n      this.emit(\"navigate\", { url: event.url, title: event.title });\n    }\n  },\n\n  attach: function(cb) {\n    this.request(\"attach\", cb);\n  },\n\n  detach: function(cb) {\n    this.request(\"detach\", cb);\n  },\n\n  reload: function(cb) {\n    this.request(\"reload\", cb);\n  },\n\n  navigateTo: function(url, cb) {\n    this.request(\"navigateTo\", { url: url }, cb);\n  }\n})\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    Tab = require(\"./tab\"),\n    fs = require(\"fs\"),\n    spawn = require(\"child_process\").spawn;\n\nmodule.exports = Webapps;\n\nvar CHUNK_SIZE = 20480;\n\n// Also dispatch appOpen/appClose, appInstall/appUninstall events\nfunction Webapps(client, tab) {\n  this.initialize(client, tab.webappsActor);\n}\n\nWebapps.prototype = extend(ClientMethods, {\n  watchApps: function(cb) {\n    this.request(\"watchApps\", cb);\n  },\n  unwatchApps: function(cb) {\n    this.request(\"unwatchApps\", cb);\n  },\n  launch: function(manifestURL, cb) {\n    this.request(\"launch\", {manifestURL: manifestURL}, cb);\n  },\n  close: function(manifestURL, cb) {\n    this.request(\"close\", {manifestURL: manifestURL}, cb);\n  },\n  getInstalledApps: function(cb) {\n    this.request(\"getAll\", function (err, resp) {\n      if (err) {\n        cb(err);\n        return;\n      }\n      cb(null, resp.apps);\n    });\n  },\n  listRunningApps: function(cb) {\n    this.request(\"listRunningApps\", function (err, resp) {\n      if (err) {\n        cb(err);\n        return;\n      }\n      cb(null, resp.apps);\n    });\n  },\n  getApp: function(manifestURL, cb) {\n    this.request(\"getAppActor\", {manifestURL: manifestURL}, (function (err, resp) {\n      if (err) {\n        cb(err);\n        return;\n      }\n      var actor = new Tab(this.client, resp.actor);\n      cb(null, actor);\n    }).bind(this));\n  },\n  installHosted: function(options, cb) {\n    this.request(\n      \"install\",\n      { appId: options.appId,\n        metadata: options.metadata,\n        manifest: options.manifest },\n      function (err, resp) {\n        if (err || resp.error) {\n          cb(err || resp.error);\n          return;\n        }\n        cb(null, resp.appId);\n      });\n  },\n  _upload: function (path, cb) {\n    // First create an upload actor\n    this.request(\"uploadPackage\", function (err, resp) {\n      var actor = resp.actor;\n      fs.readFile(path, function(err, data) {\n        chunk(actor, data);\n      });\n    });\n    // Send push the file chunk by chunk\n    var self = this;\n    var step = 0;\n    function chunk(actor, data) {\n      var i = step++ * CHUNK_SIZE;\n      var m = Math.min(i + CHUNK_SIZE, data.length);\n      var c = \"\";\n      for(; i < m; i++)\n        c += String.fromCharCode(data[i]);\n      var message = {\n        to: actor,\n        type: \"chunk\",\n        chunk: c\n      };\n      self.client.makeRequest(message, function(resp) {\n        if (resp.error) {\n          cb(resp);\n          return;\n        }\n        if (i < data.length) {\n          setTimeout(chunk, 0, actor, data);\n        } else {\n          done(actor);\n        }\n      });\n    }\n    // Finally close the upload\n    function done(actor) {\n      var message = {\n        to: actor,\n        type: \"done\"\n      };\n      self.client.makeRequest(message, function(resp) {\n        if (resp.error) {\n          cb(resp);\n        } else {\n          cb(null, actor, cleanup.bind(null, actor));\n        }\n      });\n    }\n\n    // Remove the temporary uploaded file from the server:\n    function cleanup(actor) {\n      var message = {\n        to: actor,\n        type: \"remove\"\n      };\n      self.client.makeRequest(message, function () {});\n    }\n  },\n  installPackaged: function(path, appId, cb) {\n    this._upload(path, (function (err, actor, cleanup) {\n      this.request(\"install\", {appId: appId, upload: actor},\n        function (err, resp) {\n          if (err) {\n            cb(err);\n            return;\n          }\n          cb(null, resp.appId);\n          cleanup();\n        });\n    }).bind(this));\n  },\n  installPackagedWithADB: function(path, appId, cb) {\n    var self = this;\n    // First ensure the temporary folder exists\n    function createTemporaryFolder() {\n      var c = spawn(\"adb\", [\"shell\", \"mkdir -p /data/local/tmp/b2g/\" + appId], {stdio:\"inherit\"});\n      c.on(\"close\", uploadPackage);\n    }\n    // then upload the package to the temporary directory\n    function uploadPackage() {\n      var child = spawn(\"adb\", [\"push\", path, \"/data/local/tmp/b2g/\" + appId + \"/application.zip\"], {stdio:\"inherit\"});\n      child.on(\"close\", installApp);\n    }\n    // finally order the webapps actor to install the app\n    function installApp() {\n      self.request(\"install\", {appId: appId},\n        function (err, resp) {\n          if (err) {\n            cb(err);\n            return;\n          }\n          cb(null, resp.appId);\n        });\n    }\n    createTemporaryFolder();\n  },\n  uninstall: function(manifestURL, cb) {\n    this.request(\"uninstall\", {manifestURL: manifestURL}, cb);\n  }\n})\n","'use strict';\n\n// See https://github.com/jshint/jshint/issues/1747 for context\n/* global -Promise */\nvar Promise = require('es6-promise').Promise;\nvar FirefoxClient = require('@cliqz-oss/firefox-client');\n\nmodule.exports = connect;\n\nfunction connect(port) {\n  return new Promise(function(resolve, reject) {\n\n    var client = new FirefoxClient();\n    client.connect(port, function(err) {\n      if (err) {\n        reject(err);\n      }\n      resolve(client);\n    });\n\n    client.on('error', reject);\n    client.on('timeout', reject);\n  });\n}\n","/* @flow */\nimport path from 'path';\nimport {createWriteStream} from 'fs';\n\nimport {fs} from 'mz';\nimport parseJSON from 'parse-json';\nimport stripJsonComments from 'strip-json-comments';\nimport defaultEventToPromise from 'event-to-promise';\n\nimport defaultSourceWatcher from '../watcher';\nimport {zipDir} from '../util/zip-dir';\nimport getValidatedManifest, {getManifestId} from '../util/manifest';\nimport {prepareArtifactsDir} from '../util/artifacts';\nimport {createLogger} from '../util/logger';\nimport {UsageError, isErrorWithCode} from '../errors';\nimport {\n  createFileFilter as defaultFileFilterCreator,\n  FileFilter,\n} from '../util/file-filter';\n// Import flow types.\nimport type {OnSourceChangeFn} from '../watcher';\nimport type {ExtensionManifest} from '../util/manifest';\nimport type {FileFilterCreatorFn} from '../util/file-filter';\n\nconst log = createLogger(__filename);\n\n\nexport function safeFileName(name: string): string {\n  return name.toLowerCase().replace(/[^a-z0-9.-]+/g, '_');\n}\n\n\n// defaultPackageCreator types and implementation.\n\nexport type ExtensionBuildResult = {|\n  extensionPath: string,\n|};\n\nexport type PackageCreatorParams = {|\n  manifestData?: ExtensionManifest,\n  sourceDir: string,\n  fileFilter: FileFilter,\n  artifactsDir: string,\n  overwriteDest: boolean,\n  showReadyMessage: boolean\n|};\n\nexport type LocalizedNameParams = {|\n  messageFile: string,\n  manifestData: ExtensionManifest,\n|}\n\nexport type PackageCreatorOptions = {|\n  eventToPromise: typeof defaultEventToPromise,\n|};\n\n// This defines the _locales/messages.json type. See:\n// https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Internationalization#Providing_localized_strings_in__locales\ntype LocalizedMessageData = {|\n  [messageName: string]: {|\n    description: string,\n    message: string,\n  |},\n|}\n\nexport async function getDefaultLocalizedName(\n  {messageFile, manifestData}: LocalizedNameParams\n): Promise<string> {\n\n  let messageData: LocalizedMessageData;\n  let messageContents: string | Buffer;\n  let extensionName: string = manifestData.name;\n\n  try {\n    messageContents = await fs.readFile(messageFile, {encoding: 'utf-8'});\n  } catch (error) {\n    throw new UsageError(\n      `Error reading messages.json file at ${messageFile}: ${error}`);\n  }\n\n  try {\n    messageData = parseJSON(stripJsonComments(messageContents), messageFile);\n  } catch (error) {\n    throw new UsageError(\n      `Error parsing messages.json ${error}`);\n  }\n\n  extensionName = manifestData.name.replace(\n    /__MSG_([A-Za-z0-9@_]+?)__/g,\n    (match, messageName) => {\n      if (!(messageData[messageName]\n            && messageData[messageName].message)) {\n        const error = new UsageError(\n          `The locale file ${messageFile} ` +\n            `is missing key: ${messageName}`);\n        throw error;\n      } else {\n        return messageData[messageName].message;\n      }\n    });\n  return Promise.resolve(extensionName);\n}\n\nexport type PackageCreatorFn =\n    (params: PackageCreatorParams) => Promise<ExtensionBuildResult>;\n\nexport async function defaultPackageCreator(\n  {\n    manifestData,\n    sourceDir,\n    fileFilter,\n    artifactsDir,\n    overwriteDest,\n    showReadyMessage,\n  }: PackageCreatorParams,\n  {\n    eventToPromise = defaultEventToPromise,\n  }: PackageCreatorOptions = {}\n): Promise<ExtensionBuildResult> {\n  let id;\n  if (manifestData) {\n    id = getManifestId(manifestData);\n    log.debug(`Using manifest id=${id || '[not specified]'}`);\n  } else {\n    manifestData = await getValidatedManifest(sourceDir);\n  }\n\n  const buffer = await zipDir(sourceDir, {\n    filter: (...args) => fileFilter.wantFile(...args),\n  });\n\n  let extensionName: string = manifestData.name;\n\n  if (manifestData.default_locale) {\n    const messageFile = path.join(\n      sourceDir, '_locales',\n      manifestData.default_locale, 'messages.json'\n    );\n    log.debug('Manifest declared default_locale, localizing extension name');\n    extensionName = await getDefaultLocalizedName({\n      messageFile, manifestData,\n    });\n  }\n  const packageName = safeFileName(\n    `${extensionName}-${manifestData.version}.zip`);\n  const extensionPath = path.join(artifactsDir, packageName);\n\n  // Added 'wx' flags to avoid overwriting of existing package.\n  let stream = createWriteStream(extensionPath, {flags: 'wx'});\n\n  stream.write(buffer, () => stream.end());\n\n  try {\n    await eventToPromise(stream, 'close');\n  } catch (error) {\n    if (!isErrorWithCode('EEXIST', error)) {\n      throw error;\n    }\n    if (!overwriteDest) {\n      throw new UsageError(\n        `Extension exists at the destination path: ${extensionPath}\\n` +\n        'Use --overwrite-dest to enable overwriting.');\n    }\n    log.info(`Destination exists, overwriting: ${extensionPath}`);\n    stream = createWriteStream(extensionPath);\n    stream.write(buffer, () => stream.end());\n    await eventToPromise(stream, 'close');\n  }\n\n  if (showReadyMessage) {\n    log.info(`Your web extension is ready: ${extensionPath}`);\n  }\n  return {extensionPath};\n}\n\n\n// Build command types and implementation.\n\nexport type BuildCmdParams = {|\n  sourceDir: string,\n  artifactsDir: string,\n  asNeeded?: boolean,\n  overwriteDest?: boolean,\n  ignoreFiles?: Array<string>,\n|};\n\nexport type BuildCmdOptions = {|\n  manifestData?: ExtensionManifest,\n  fileFilter?: FileFilter,\n  onSourceChange?: OnSourceChangeFn,\n  packageCreator?: PackageCreatorFn,\n  showReadyMessage?: boolean,\n  createFileFilter?: FileFilterCreatorFn,\n  shouldExitProgram?: boolean,\n|};\n\nexport default async function build(\n  {\n    sourceDir,\n    artifactsDir,\n    asNeeded = false,\n    overwriteDest = false,\n    ignoreFiles = [],\n  }: BuildCmdParams,\n  {\n    manifestData,\n    createFileFilter = defaultFileFilterCreator,\n    fileFilter = createFileFilter({\n      sourceDir,\n      artifactsDir,\n      ignoreFiles,\n    }),\n    onSourceChange = defaultSourceWatcher,\n    packageCreator = defaultPackageCreator,\n    showReadyMessage = true,\n  }: BuildCmdOptions = {}\n): Promise<ExtensionBuildResult> {\n\n  const rebuildAsNeeded = asNeeded; // alias for `build --as-needed`\n  log.info(`Building web extension from ${sourceDir}`);\n\n  const createPackage = () => packageCreator({\n    manifestData,\n    sourceDir,\n    fileFilter,\n    artifactsDir,\n    overwriteDest,\n    showReadyMessage,\n  });\n\n  await prepareArtifactsDir(artifactsDir);\n  const result = await createPackage();\n\n  if (rebuildAsNeeded) {\n    log.info('Rebuilding when files change...');\n    onSourceChange({\n      sourceDir,\n      artifactsDir,\n      onChange: () => {\n        return createPackage().catch((error) => {\n          log.error(error.stack);\n          throw error;\n        });\n      },\n      shouldWatchFile: (...args) => fileFilter.wantFile(...args),\n    });\n  }\n\n  return result;\n}\n","/* @flow */\nimport opn from 'opn';\n\nimport {createLogger} from '../util/logger';\n\nconst log = createLogger(__filename);\n\nexport type DocsParams = {\n  noInput?: boolean,\n  shouldExitProgram?: boolean,\n}\n\nexport type DocsOptions = {\n  openUrl?: typeof opn,\n}\n\nexport const url = 'https://developer.mozilla.org/en-US/Add-ons' +\n  '/WebExtensions/Getting_started_with_web-ext';\n\nexport default function docs(\n  params: DocsParams, {openUrl = opn}: DocsOptions = {}\n): Promise<void> {\n  return new Promise((resolve, reject) => {\n    openUrl(url, (error) => {\n      if (error) {\n        log.debug(`Encountered an error while opening URL ${url}`, error);\n        reject(error);\n      } else {\n        resolve();\n      }\n    });\n  });\n}\n","/* @flow */\n\nimport type {\n  BuildCmdParams, BuildCmdOptions, ExtensionBuildResult,\n} from './build';\nimport type {LintCmdParams, LintCmdOptions} from './lint';\nimport type {CmdRunParams, CmdRunOptions} from './run';\nimport type {MultiExtensionRunner} from '../extension-runners';\nimport type {SignParams, SignOptions, SignResult} from './sign';\nimport type {DocsParams, DocsOptions} from './docs';\n\n// This module exports entry points for all supported commands. For performance\n// reasons (faster start-up), the implementations are not statically imported\n// at the top of the file, but lazily loaded in the (exported) functions.\n// The latter would slow down start-up by several seconds, as seen in #1302 .\n\nasync function build(\n  params: BuildCmdParams, options: BuildCmdOptions\n): Promise<ExtensionBuildResult> {\n  // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n  const {default: runCommand} = require('./build');\n  return runCommand(params, options);\n}\n\nasync function lint(\n  params: LintCmdParams, options: LintCmdOptions\n): Promise<void> {\n  // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n  const {default: runCommand} = require('./lint');\n  return runCommand(params, options);\n}\n\nasync function run(\n  params: CmdRunParams, options: CmdRunOptions\n): Promise<MultiExtensionRunner> {\n  // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n  const {default: runCommand} = require('./run');\n  return runCommand(params, options);\n}\n\nasync function sign(\n  params: SignParams, options: SignOptions\n): Promise<SignResult> {\n  // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n  const {default: runCommand} = require('./sign');\n  return runCommand(params, options);\n}\n\nasync function docs(\n  params: DocsParams, options: DocsOptions\n): Promise<void> {\n  // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n  const {default: runCommand} = require('./docs');\n  return runCommand(params, options);\n}\n\nexport default {build, lint, run, sign, docs};\n","/* @flow */\nimport {createInstance as defaultLinterCreator} from 'addons-linter';\n\nimport {createLogger} from '../util/logger';\nimport {\n  createFileFilter as defaultFileFilterCreator,\n} from '../util/file-filter';\n// import flow types\nimport type {FileFilterCreatorFn} from '../util/file-filter';\n\nconst log = createLogger(__filename);\n\n\n// Define the needed 'addons-linter' module flow types.\n\nexport type LinterOutputType = 'text' | 'json';\n\nexport type LinterCreatorParams = {|\n  config: {|\n    logLevel: 'debug' | 'fatal',\n    stack: boolean,\n    pretty?: boolean,\n    warningsAsErrors?: boolean,\n    metadata?: boolean,\n    output?: LinterOutputType,\n    boring?: boolean,\n    selfHosted?: boolean,\n    shouldScanFile: (fileName: string) => boolean,\n    _: Array<string>,\n  |},\n  runAsBinary: boolean,\n|};\n\nexport type Linter = {|\n  run: () => Promise<void>,\n|};\n\nexport type LinterCreatorFn = (params: LinterCreatorParams) => Linter;\n\n\n// Lint command types and implementation.\n\nexport type LintCmdParams = {|\n  artifactsDir?: string,\n  boring?: boolean,\n  ignoreFiles?: Array<string>,\n  metadata?: boolean,\n  output?: LinterOutputType,\n  pretty?: boolean,\n  selfHosted?: boolean,\n  sourceDir: string,\n  verbose?: boolean,\n  warningsAsErrors?: boolean,\n|};\n\nexport type LintCmdOptions = {|\n  createLinter?: LinterCreatorFn,\n  createFileFilter?: FileFilterCreatorFn,\n  shouldExitProgram?: boolean,\n|};\n\nexport default function lint(\n  {\n    artifactsDir,\n    boring,\n    ignoreFiles,\n    metadata,\n    output,\n    pretty,\n    sourceDir,\n    selfHosted,\n    verbose,\n    warningsAsErrors,\n  }: LintCmdParams,\n  {\n    createLinter = defaultLinterCreator,\n    createFileFilter = defaultFileFilterCreator,\n    shouldExitProgram = true,\n  }: LintCmdOptions = {}\n): Promise<void> {\n  const fileFilter = createFileFilter({sourceDir, ignoreFiles, artifactsDir});\n\n  log.debug(`Running addons-linter on ${sourceDir}`);\n  const linter = createLinter({\n    config: {\n      logLevel: verbose ? 'debug' : 'fatal',\n      stack: Boolean(verbose),\n      pretty,\n      warningsAsErrors,\n      metadata,\n      output,\n      boring,\n      selfHosted,\n      shouldScanFile: (fileName) => fileFilter.wantFile(fileName),\n      // This mimics the first command line argument from yargs,\n      // which should be the directory to the extension.\n      _: [sourceDir],\n    },\n    runAsBinary: shouldExitProgram,\n  });\n  return linter.run();\n}\n","/* @flow */\nimport defaultBuildExtension from './build';\nimport {\n  showDesktopNotification as defaultDesktopNotifications,\n} from '../util/desktop-notifier';\nimport * as defaultFirefoxApp from '../firefox';\nimport {\n  connectWithMaxRetries as defaultFirefoxClient,\n} from '../firefox/remote';\nimport {createLogger} from '../util/logger';\nimport defaultGetValidatedManifest from '../util/manifest';\nimport {\n  createExtensionRunner,\n  defaultReloadStrategy,\n  MultiExtensionRunner as DefaultMultiExtensionRunner,\n} from '../extension-runners';\n// Import objects that are only used as Flow types.\nimport type {FirefoxPreferences} from '../firefox/preferences';\n\nconst log = createLogger(__filename);\n\n\n// Run command types and implementation.\n\nexport type CmdRunParams = {|\n  artifactsDir: string,\n  browserConsole: boolean,\n  pref?: FirefoxPreferences,\n  firefox: string,\n  firefoxProfile?: string,\n  ignoreFiles?: Array<string>,\n  keepProfileChanges: boolean,\n  noInput?: boolean,\n  noReload: boolean,\n  preInstall: boolean,\n  sourceDir: string,\n  startUrl?: Array<string>,\n  target?: Array<string>,\n  args?: Array<string>,\n\n  // Android CLI options.\n  adbBin?: string,\n  adbHost?: string,\n  adbPort?: string,\n  adbDevice?: string,\n  firefoxApk?: string,\n|};\n\nexport type CmdRunOptions = {|\n  buildExtension: typeof defaultBuildExtension,\n  desktopNotifications: typeof defaultDesktopNotifications,\n  firefoxApp: typeof defaultFirefoxApp,\n  firefoxClient: typeof defaultFirefoxClient,\n  reloadStrategy: typeof defaultReloadStrategy,\n  shouldExitProgram?: boolean,\n  MultiExtensionRunner?: typeof DefaultMultiExtensionRunner,\n  getValidatedManifest?: typeof defaultGetValidatedManifest,\n|};\n\nexport default async function run(\n  {\n    artifactsDir,\n    browserConsole = false,\n    pref,\n    firefox,\n    firefoxProfile,\n    keepProfileChanges = false,\n    ignoreFiles,\n    noInput = false,\n    noReload = false,\n    preInstall = false,\n    sourceDir,\n    startUrl,\n    target,\n    // Android CLI options.\n    adbBin,\n    adbHost,\n    adbPort,\n    adbDevice,\n    firefoxApk,\n    args,\n  }: CmdRunParams,\n  {\n    buildExtension = defaultBuildExtension,\n    desktopNotifications = defaultDesktopNotifications,\n    firefoxApp = defaultFirefoxApp,\n    firefoxClient = defaultFirefoxClient,\n    reloadStrategy = defaultReloadStrategy,\n    MultiExtensionRunner = DefaultMultiExtensionRunner,\n    getValidatedManifest = defaultGetValidatedManifest,\n  }: CmdRunOptions = {}): Promise<DefaultMultiExtensionRunner> {\n\n  log.info(`Running web extension from ${sourceDir}`);\n  if (preInstall) {\n    log.info('Disabled auto-reloading because it\\'s not possible with ' +\n             '--pre-install');\n    noReload = true;\n  }\n\n  // Create an alias for --pref since it has been transformed into an\n  // object containing one or more preferences.\n  const customPrefs = pref;\n  const manifestData = await getValidatedManifest(sourceDir);\n\n  const runners = [];\n\n  const commonRunnerParams = {\n    // Common options.\n    extensions: [{sourceDir, manifestData}],\n    keepProfileChanges,\n    startUrl,\n    args,\n    desktopNotifications,\n  };\n\n  if (!target || target.length === 0 || target.includes('firefox-desktop')) {\n    const firefoxDesktopRunnerParams = {\n      ...commonRunnerParams,\n\n      // Firefox specific CLI options.\n      firefoxBinary: firefox,\n      profilePath: firefoxProfile,\n      customPrefs,\n      browserConsole,\n      preInstall,\n\n      // Firefox runner injected dependencies.\n      firefoxApp,\n      firefoxClient,\n    };\n\n    const firefoxDesktopRunner = await createExtensionRunner({\n      target: 'firefox-desktop',\n      params: firefoxDesktopRunnerParams,\n    });\n    runners.push(firefoxDesktopRunner);\n  }\n\n  if (target && target.includes('firefox-android')) {\n    const firefoxAndroidRunnerParams = {\n      ...commonRunnerParams,\n\n      // Firefox specific CLI options.\n      profilePath: firefoxProfile,\n      customPrefs,\n      browserConsole,\n      preInstall,\n      firefoxApk,\n      adbDevice,\n      adbHost,\n      adbPort,\n      adbBin,\n\n      // Injected dependencies.\n      firefoxApp,\n      firefoxClient,\n      desktopNotifications: defaultDesktopNotifications,\n      buildSourceDir: (extensionSourceDir: string, tmpArtifactsDir: string) => {\n        return buildExtension({\n          sourceDir: extensionSourceDir,\n          ignoreFiles,\n          asNeeded: false,\n          // Use a separate temporary directory for building the extension zip file\n          // that we are going to upload on the android device.\n          artifactsDir: tmpArtifactsDir,\n        }, {\n          // Suppress the message usually logged by web-ext build.\n          showReadyMessage: false,\n        });\n      },\n    };\n\n    const firefoxAndroidRunner = await createExtensionRunner({\n      target: 'firefox-android',\n      params: firefoxAndroidRunnerParams,\n    });\n    runners.push(firefoxAndroidRunner);\n  }\n\n  const extensionRunner = new MultiExtensionRunner({\n    desktopNotifications,\n    runners,\n  });\n\n  await extensionRunner.run();\n\n  if (noReload) {\n    log.info('Automatic extension reloading has been disabled');\n  } else {\n    log.info('The extension will reload if any source file changes');\n\n    reloadStrategy({\n      extensionRunner,\n      sourceDir,\n      artifactsDir,\n      ignoreFiles,\n      noInput,\n    });\n  }\n\n  return extensionRunner;\n}\n","/* @flow */\nimport path from 'path';\n\nimport {fs} from 'mz';\nimport defaultAddonSigner from 'sign-addon';\n\nimport defaultBuilder from './build';\nimport getValidatedManifest, {getManifestId} from '../util/manifest';\nimport {withTempDir} from '../util/temp-dir';\nimport {isErrorWithCode, UsageError, WebExtError} from '../errors';\nimport {prepareArtifactsDir} from '../util/artifacts';\nimport {createLogger} from '../util/logger';\nimport type {ExtensionManifest} from '../util/manifest';\n\n\nconst log = createLogger(__filename);\n\nconst defaultAsyncFsReadFile = fs.readFile.bind(fs);\n\nexport const extensionIdFile = '.web-extension-id';\n\n// Sign command types and implementation.\n\nexport type SignParams = {|\n  apiKey: string,\n  apiProxy: string,\n  apiSecret: string,\n  apiUrlPrefix: string,\n  artifactsDir: string,\n  id?: string,\n  ignoreFiles?: Array<string>,\n  sourceDir: string,\n  timeout: number,\n  verbose?: boolean,\n  channel?: string,\n|};\n\nexport type SignOptions = {\n  build?: typeof defaultBuilder,\n  signAddon?: typeof defaultAddonSigner,\n  preValidatedManifest?: ExtensionManifest,\n  shouldExitProgram?: boolean,\n};\n\nexport type SignResult = {|\n  success: boolean,\n  id: string,\n  downloadedFiles: Array<string>,\n|};\n\nexport default function sign(\n  {\n    apiKey,\n    apiProxy,\n    apiSecret,\n    apiUrlPrefix,\n    artifactsDir,\n    id,\n    ignoreFiles = [],\n    sourceDir,\n    timeout,\n    verbose,\n    channel,\n  }: SignParams,\n  {\n    build = defaultBuilder,\n    preValidatedManifest,\n    signAddon = defaultAddonSigner,\n  }: SignOptions = {}\n): Promise<SignResult> {\n  return withTempDir(\n    async function(tmpDir) {\n      await prepareArtifactsDir(artifactsDir);\n\n      let manifestData;\n\n      if (preValidatedManifest) {\n        manifestData = preValidatedManifest;\n      } else {\n        manifestData = await getValidatedManifest(sourceDir);\n      }\n\n      const [buildResult, idFromSourceDir] = await Promise.all([\n        build({sourceDir, ignoreFiles, artifactsDir: tmpDir.path()},\n              {manifestData, showReadyMessage: false}),\n        getIdFromSourceDir(sourceDir),\n      ]);\n\n      const manifestId = getManifestId(manifestData);\n\n      if (id && manifestId) {\n        throw new UsageError(\n          `Cannot set custom ID ${id} because manifest.json ` +\n          `declares ID ${manifestId}`);\n      }\n      if (id) {\n        log.debug(`Using custom ID declared as --id=${id}`);\n      }\n\n      if (manifestId) {\n        id = manifestId;\n      }\n\n      if (!id && idFromSourceDir) {\n        log.info(\n          `Using previously auto-generated extension ID: ${idFromSourceDir}`);\n        id = idFromSourceDir;\n      }\n\n      if (!id) {\n        log.warn('No extension ID specified (it will be auto-generated)');\n      }\n\n      const signingResult = await signAddon({\n        apiKey,\n        apiSecret,\n        apiUrlPrefix,\n        apiProxy,\n        timeout,\n        verbose,\n        id,\n        xpiPath: buildResult.extensionPath,\n        version: manifestData.version,\n        downloadDir: artifactsDir,\n        channel,\n      });\n\n      if (signingResult.id) {\n        await saveIdToSourceDir(sourceDir, signingResult.id);\n      }\n\n      // All information about the downloaded files would have\n      // already been logged by signAddon().\n      if (signingResult.success) {\n        log.info(`Extension ID: ${signingResult.id}`);\n        log.info('SUCCESS');\n      } else {\n        log.info('FAIL');\n        throw new WebExtError(\n          'The extension could not be signed');\n      }\n\n      return signingResult;\n    }\n  );\n}\n\n\nexport async function getIdFromSourceDir(\n  sourceDir: string,\n  asyncFsReadFile: typeof defaultAsyncFsReadFile = defaultAsyncFsReadFile,\n): Promise<string | void> {\n  const filePath = path.join(sourceDir, extensionIdFile);\n\n  let content;\n\n  try {\n    content = await asyncFsReadFile(filePath);\n  } catch (error) {\n    if (isErrorWithCode('ENOENT', error)) {\n      log.debug(`No ID file found at: ${filePath}`);\n      return;\n    }\n    throw error;\n  }\n\n  let lines = content.toString().split('\\n');\n  lines = lines.filter((line) => {\n    line = line.trim();\n    if (line && !line.startsWith('#')) {\n      return line;\n    }\n  });\n\n  const id = lines[0];\n  log.debug(`Found extension ID ${id} in ${filePath}`);\n\n  if (!id) {\n    throw new UsageError(`No ID found in extension ID file ${filePath}`);\n  }\n\n  return id;\n}\n\n\nexport async function saveIdToSourceDir(\n  sourceDir: string, id: string\n): Promise<void> {\n  const filePath = path.join(sourceDir, extensionIdFile);\n  await fs.writeFile(filePath, [\n    '# This file was created by https://github.com/mozilla/web-ext',\n    '# Your auto-generated extension ID for addons.mozilla.org is:',\n    id.toString(),\n  ].join('\\n'));\n\n  log.debug(`Saved auto-generated ID ${id} to ${filePath}`);\n}\n","/* @flow */\nimport os from 'os';\nimport path from 'path';\n\nimport requireUncached from 'require-uncached';\nimport camelCase from 'camelcase';\nimport decamelize from 'decamelize';\n\nimport fileExists from './util/file-exists';\nimport {createLogger} from './util/logger';\nimport {UsageError, WebExtError} from './errors';\n\nconst log = createLogger(__filename);\n\ntype ApplyConfigToArgvParams = {|\n  // This is the argv object which will get updated by each\n  // config applied.\n  argv: Object,\n  // This is the argv that only has CLI values applied to it.\n  argvFromCLI: Object,\n  configObject: Object,\n  options: Object,\n  configFileName: string,\n|};\n\nexport function applyConfigToArgv({\n  argv,\n  argvFromCLI,\n  configObject,\n  options,\n  configFileName,\n}: ApplyConfigToArgvParams): Object {\n  let newArgv = {...argv};\n\n  for (const option of Object.keys(configObject)) {\n    if (camelCase(option) !== option) {\n      throw new UsageError(\n        `The config option \"${option}\" must be ` +\n        `specified in camel case: \"${camelCase(option)}\"`);\n    }\n\n    // A config option cannot be a sub-command config\n    // object if it is an array.\n    if (!Array.isArray(configObject[option]) &&\n      typeof options[option] === 'object' &&\n      typeof configObject[option] === 'object') {\n      // Descend into the nested configuration for a sub-command.\n      newArgv = applyConfigToArgv({\n        argv: newArgv,\n        argvFromCLI,\n        configObject: configObject[option],\n        options: options[option],\n        configFileName});\n      continue;\n    }\n\n    const decamelizedOptName = decamelize(option, '-');\n\n    if (typeof options[decamelizedOptName] !== 'object') {\n      throw new UsageError(`The config file at ${configFileName} specified ` +\n        `an unknown option: \"${option}\"`);\n    }\n    if (options[decamelizedOptName].type === undefined) {\n      // This means yargs option type wasn't not defined correctly\n      throw new WebExtError(\n        `Option: ${option} was defined without a type.`);\n    }\n\n    const expectedType = options[decamelizedOptName].type ===\n      'count' ? 'number' : options[decamelizedOptName].type;\n\n    const optionType = (\n      Array.isArray(configObject[option]) ?\n        'array' : typeof configObject[option]\n    );\n\n    if (optionType !== expectedType) {\n      throw new UsageError(`The config file at ${configFileName} specified ` +\n        `the type of \"${option}\" incorrectly as \"${optionType}\"` +\n        ` (expected type \"${expectedType}\")`);\n    }\n\n    let defaultValue;\n    if (options[decamelizedOptName]) {\n      if (options[decamelizedOptName].default !== undefined) {\n        defaultValue = options[decamelizedOptName].default;\n      } else if (expectedType === 'boolean') {\n        defaultValue = false;\n      }\n    }\n\n    // This is our best effort (without patching yargs) to detect\n    // if a value was set on the CLI instead of in the config.\n    // It looks for a default value and if the argv value is\n    // different, it assumes that the value was configured on the CLI.\n\n    const wasValueSetOnCLI =\n      typeof argvFromCLI[option] !== 'undefined' &&\n      argvFromCLI[option] !== defaultValue;\n    if (wasValueSetOnCLI) {\n      log.debug(\n        `Favoring CLI: ${option}=${argvFromCLI[option]} over ` +\n        `configuration: ${option}=${configObject[option]}`);\n      newArgv[option] = argvFromCLI[option];\n      continue;\n    }\n\n    newArgv[option] = configObject[option];\n\n    const coerce = options[decamelizedOptName].coerce;\n    if (coerce) {\n      log.debug(\n        `Calling coerce() on configured value for ${option}`);\n      newArgv[option] = coerce(newArgv[option]);\n    }\n  }\n  return newArgv;\n}\n\nexport function loadJSConfigFile(filePath: string): Object {\n  const resolvedFilePath = path.resolve(filePath);\n  log.debug(\n    `Loading JS config file: \"${filePath}\" ` +\n    `(resolved to \"${resolvedFilePath}\")`);\n  let configObject;\n  try {\n    configObject = requireUncached(resolvedFilePath);\n  } catch (error) {\n    log.debug('Handling error:', error);\n    throw new UsageError(\n      `Cannot read config file: ${resolvedFilePath}\\n` +\n      `Error: ${error.message}`);\n  }\n  if (filePath.endsWith('package.json')) {\n    log.debug('Looking for webExt key inside package.json file');\n    configObject = configObject.webExt || {};\n  }\n  if (Object.keys(configObject).length === 0) {\n    log.debug(`Config file ${resolvedFilePath} did not define any options. ` +\n      'Did you set module.exports = {...}?');\n  }\n  return configObject;\n}\n\ntype DiscoverConfigFilesParams = {|\n  getHomeDir: () => string,\n|};\n\nexport async function discoverConfigFiles(\n  {getHomeDir = os.homedir}: DiscoverConfigFilesParams = {}\n): Promise<Array<string>> {\n  const magicConfigName = 'web-ext-config.js';\n\n  // Config files will be loaded in this order.\n  const possibleConfigs = [\n    // Look for a magic hidden config (preceded by dot) in home dir.\n    path.join(getHomeDir(), `.${magicConfigName}`),\n    // Look for webExt key inside package.json file\n    path.join(process.cwd(), 'package.json'),\n    // Look for a magic config in the current working directory.\n    path.join(process.cwd(), magicConfigName),\n  ];\n\n  const configs = await Promise.all(possibleConfigs.map(\n    async (fileName) => {\n      const resolvedFileName = path.resolve(fileName);\n      if (await fileExists(resolvedFileName)) {\n        return resolvedFileName;\n      } else {\n        log.debug(\n          `Discovered config \"${resolvedFileName}\" does not ` +\n          'exist or is not readable');\n        return undefined;\n      }\n    }\n  ));\n\n  const existingConfigs = [];\n  configs.forEach((f) => {\n    if (typeof f === 'string') {\n      existingConfigs.push(f);\n    }\n  });\n  return existingConfigs;\n}\n","/* @flow */\nimport ExtendableError from 'es6-error';\n\n\n/*\n * Base error for all custom web-ext errors.\n */\nexport class WebExtError extends ExtendableError {\n  constructor(message: string) {\n    super(message);\n  }\n}\n\n\n/*\n * The class for errors that can be fixed by the developer.\n */\nexport class UsageError extends WebExtError {\n  constructor(message: string) {\n    super(message);\n  }\n}\n\n\n/*\n * The manifest for the extension is invalid (or missing).\n */\nexport class InvalidManifest extends UsageError {\n  constructor(message: string) {\n    super(message);\n  }\n}\n\n\n/*\n * The remote Firefox does not support temporary add-on installation.\n */\nexport class RemoteTempInstallNotSupported extends WebExtError {\n  constructor(message: string) {\n    super(message);\n  }\n}\n\n/*\n * The errors collected when reloading all extensions at once\n * (initialized from a map of errors by extensionSourceDir string).\n */\nexport class MultiExtensionsReloadError extends WebExtError {\n  constructor(errorsMap: Map<string, Error>) {\n    let errors = '';\n    for (const [sourceDir, error] of errorsMap) {\n      const msg = String(error);\n      errors += `\\nError on extension loaded from ${sourceDir}: ${msg}\\n`;\n    }\n    const message = `Reload errors: ${errors}`;\n\n    super(message);\n    this.errorsBySourceDir = errorsMap;\n  }\n}\n\n/*\n * Sugar-y way to catch only instances of a certain error.\n *\n * Usage:\n *\n *  Promise.reject(SyntaxError)\n *    .catch(onlyInstancesOf(SyntaxError, (error) => {\n *      // error is guaranteed to be an instance of SyntaxError\n *    }))\n *\n * All other errors will be re-thrown.\n *\n */\nexport function onlyInstancesOf(\n  predicate: Function, errorHandler: Function\n): Function {\n  return (error) => {\n    if (error instanceof predicate) {\n      return errorHandler(error);\n    } else {\n      throw error;\n    }\n  };\n}\n\n\n/*\n * Sugar-y way to catch only errors having certain code(s).\n *\n * Usage:\n *\n *  Promise.resolve()\n *    .catch(onlyErrorsWithCode('ENOENT', (error) => {\n *      // error.code is guaranteed to be ENOENT\n *    }))\n *\n *  or:\n *\n *  Promise.resolve()\n *    .catch(onlyErrorsWithCode(['ENOENT', 'ENOTDIR'], (error) => {\n *      // ...\n *    }))\n *\n * All other errors will be re-thrown.\n *\n */\nexport function onlyErrorsWithCode(\n  codeWanted: (string | number) | Array<string | number>,\n  errorHandler: Function\n): Function {\n  return (error) => {\n    let throwError = true;\n\n    if (Array.isArray(codeWanted)) {\n      if (codeWanted.indexOf(error.code) !== -1 ||\n          codeWanted.indexOf(error.errno) !== -1) {\n        throwError = false;\n      }\n    } else if (error.code === codeWanted || error.errno === codeWanted) {\n      throwError = false;\n    }\n\n    if (throwError) {\n      throw error;\n    }\n\n    return errorHandler(error);\n  };\n}\n\nexport function isErrorWithCode(\n  codeWanted: string | Array<string>,\n  error: Object,\n): boolean {\n  if (Array.isArray(codeWanted) && codeWanted.indexOf(error.code) !== -1) {\n    return true;\n  } else if (error.code === codeWanted) {\n    return true;\n  }\n\n  return false;\n}\n","/* @flow */\n\n/**\n * This module provide an ExtensionRunner subclass that manage an extension executed\n * in a Firefox for Android instance.\n */\n\nimport net from 'net';\nimport path from 'path';\nimport readline from 'readline';\n\nimport {withTempDir} from '../util/temp-dir';\nimport DefaultADBUtils from '../util/adb';\nimport {\n  showDesktopNotification as defaultDesktopNotifications,\n} from '../util/desktop-notifier';\nimport {\n  MultiExtensionsReloadError,\n  UsageError,\n  WebExtError,\n} from '../errors';\nimport * as defaultFirefoxApp from '../firefox';\nimport {\n  connectWithMaxRetries as defaultFirefoxConnector,\n} from '../firefox/remote';\nimport {createLogger} from '../util/logger';\nimport {isTTY, setRawMode} from '../util/stdin';\nimport type {\n  ExtensionRunnerParams,\n  ExtensionRunnerReloadResult,\n} from './base';\nimport type {\n  FirefoxPreferences,\n} from '../firefox/preferences';\nimport type {\n  FirefoxRDPResponseAddon,\n  RemoteFirefox,\n} from '../firefox/remote';\nimport type {\n  ExtensionBuildResult,\n} from '../cmd/build';\n\nconst log = createLogger(__filename);\n\nconst ignoredParams = {\n  profilePath: '--profile-path',\n  keepProfileChanges: '--keep-profile-changes',\n  browserConsole: '--browser-console',\n  preInstall: '--pre-install',\n  startUrl: '--start-url',\n  args: '--args',\n};\n\nconst getIgnoredParamsWarningsMessage = (optionName) => {\n  return `The Firefox for Android target does not support ${optionName}`;\n};\n\nexport type FirefoxAndroidExtensionRunnerParams = {|\n  ...ExtensionRunnerParams,\n\n  // Firefox specific.\n  customPrefs?: FirefoxPreferences,\n\n  // Not supported (currently ignored with logged warning).\n  preInstall?: boolean,\n  browserConsole?: boolean,\n\n  // Firefox android injected dependencies.\n  adbBin?: string,\n  adbHost?: string,\n  adbPort?: string,\n  adbDevice?: string,\n  firefoxApk?: string,\n  firefoxAndroidTimeout?: number,\n\n  // Injected Dependencies.\n  firefoxApp: typeof defaultFirefoxApp,\n  firefoxClient: typeof defaultFirefoxConnector,\n  ADBUtils?: typeof DefaultADBUtils,\n  buildSourceDir: (string, string) => Promise<ExtensionBuildResult>,\n  desktopNotifications: typeof defaultDesktopNotifications,\n  stdin?: stream$Readable,\n|};\n\n/**\n * Implements an IExtensionRunner which manages a Firefox for Android instance.\n */\nexport class FirefoxAndroidExtensionRunner {\n  // Wait 3s before the next unix socket discovery loop.\n  static unixSocketDiscoveryRetryInterval = 3 * 1000;\n  // Wait for at most 3 minutes before giving up.\n  static unixSocketDiscoveryMaxTime = 3 * 60 * 1000;\n\n  params: FirefoxAndroidExtensionRunnerParams;\n  adbUtils: DefaultADBUtils;\n  exiting: boolean;\n  selectedAdbDevice: string;\n  selectedFirefoxApk: string;\n  selectedArtifactsDir: string;\n  selectedRDPSocketFile: string;\n  selectedTCPPort: number;\n  cleanupCallbacks: Set<Function>;\n  adbExtensionsPathBySourceDir: Map<string, string>;\n  reloadableExtensions: Map<string, string>;\n  remoteFirefox: RemoteFirefox;\n\n  constructor(params: FirefoxAndroidExtensionRunnerParams) {\n    this.params = params;\n    this.cleanupCallbacks = new Set();\n    this.adbExtensionsPathBySourceDir = new Map();\n    this.reloadableExtensions = new Map();\n\n    // Print warning for not currently supported options (e.g. preInstall,\n    // cloned profiles, browser console).\n    this.printIgnoredParamsWarnings();\n  }\n\n  async run(): Promise<void> {\n    const {\n      adbBin,\n      adbHost,\n      adbPort,\n      ADBUtils = DefaultADBUtils,\n    } = this.params;\n\n    this.adbUtils = new ADBUtils({\n      adbBin, adbHost, adbPort,\n    });\n\n    await this.adbDevicesDiscoveryAndSelect();\n    await this.apkPackagesDiscoveryAndSelect();\n    await this.adbCheckRuntimePermissions();\n    await this.adbForceStopSelectedPackage();\n\n    // Create profile prefs (with enabled remote RDP server), prepare the\n    // artifacts and temporary directory on the selected device, and\n    // push the profile preferences to the remote profile dir.\n    await this.adbPrepareProfileDir();\n\n    // NOTE: running Firefox for Android on the Android Emulator can be\n    // pretty slow, we can run the following 3 steps in parallel to speed up\n    // it a bit.\n    await Promise.all([\n      // Start Firefox for Android instance on the created profile.\n      this.adbStartSelectedPackage(),\n\n      // Build and push to devices all the extension xpis\n      // and keep track of the xpi built and uploaded by extension sourceDir.\n      this.buildAndPushExtensions(),\n\n      // Wait for RDP unix socket file created and\n      // Create an ADB forward connection on a free tcp port\n      this.adbDiscoveryAndForwardRDPUnixSocket(),\n    ]);\n\n    // Connect to RDP socket on the local tcp server, install all the pushed extension\n    // and keep track of the built and installed extension by extension sourceDir.\n    await this.rdpInstallExtensions();\n  }\n\n  // Method exported from the IExtensionRunner interface.\n\n  /**\n   * Returns the runner name.\n   */\n  getName() {\n    return 'Firefox Android';\n  }\n\n  /**\n   * Reloads all the extensions, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadAllExtensions(): Promise<Array<ExtensionRunnerReloadResult>> {\n    const runnerName = this.getName();\n    const reloadErrors = new Map();\n\n    for (const {sourceDir} of this.params.extensions) {\n      const [res] = await this.reloadExtensionBySourceDir(sourceDir);\n      if (res.reloadError instanceof Error) {\n        reloadErrors.set(sourceDir, res.reloadError);\n      }\n    }\n\n    if (reloadErrors.size > 0) {\n      return [{\n        runnerName,\n        reloadError: new MultiExtensionsReloadError(reloadErrors),\n      }];\n    }\n\n    return [{runnerName}];\n  }\n\n  /**\n   * Reloads a single extension, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadExtensionBySourceDir(\n    extensionSourceDir: string\n  ): Promise<Array<ExtensionRunnerReloadResult>> {\n    const runnerName = this.getName();\n    const addonId = this.reloadableExtensions.get(extensionSourceDir);\n\n    if (!addonId) {\n      return [{\n        sourceDir: extensionSourceDir,\n        reloadError: new WebExtError(\n          'Extension not reloadable: ' +\n            `no addonId has been mapped to \"${extensionSourceDir}\"`\n        ),\n        runnerName,\n      }];\n    }\n\n    try {\n      await this.buildAndPushExtension(extensionSourceDir);\n      await this.remoteFirefox.reloadAddon(addonId);\n    } catch (error) {\n      return [{\n        sourceDir: extensionSourceDir,\n        reloadError: error,\n        runnerName,\n      }];\n    }\n\n    return [{runnerName, sourceDir: extensionSourceDir}];\n  }\n\n  /**\n   * Register a callback to be called when the runner has been exited\n   * (e.g. the Firefox instance exits or the user has requested web-ext\n   * to exit).\n   */\n  registerCleanup(fn: Function): void {\n    this.cleanupCallbacks.add(fn);\n  }\n\n  /**\n   * Exits the runner, by closing the managed Firefox instance.\n   */\n  async exit(): Promise<void> {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedArtifactsDir,\n    } = this;\n\n    this.exiting = true;\n\n    // If a Firefox for Android instance has been started,\n    // we should ensure that it has been stopped when we exit.\n    await this.adbForceStopSelectedPackage();\n\n    if (selectedArtifactsDir) {\n      log.debug('Cleaning up artifacts directory on the Android device...');\n      await adbUtils.clearArtifactsDir(selectedAdbDevice);\n    }\n\n    // Call all the registered cleanup callbacks.\n    for (const fn of this.cleanupCallbacks) {\n      try {\n        fn();\n      } catch (error) {\n        log.error(error);\n      }\n    }\n  }\n\n  // Private helper methods.\n\n  getDeviceProfileDir(): string {\n    return `${this.selectedArtifactsDir}/profile`;\n  }\n\n  printIgnoredParamsWarnings() {\n    Object.keys(ignoredParams).forEach((ignoredParam) => {\n      if (this.params[ignoredParam]) {\n        log.warn(\n          getIgnoredParamsWarningsMessage(ignoredParams[ignoredParam])\n        );\n      }\n    });\n  }\n\n  async adbDevicesDiscoveryAndSelect() {\n    const {adbUtils} = this;\n    const {adbDevice} = this.params;\n    let devices = [];\n\n    log.debug('Listing android devices');\n    devices = await adbUtils.discoverDevices();\n\n    if (devices.length === 0) {\n      throw new UsageError(\n        'No Android device found through ADB. ' +\n        'Make sure the device is connected and USB debugging is enabled.'\n      );\n    }\n\n    if (!adbDevice) {\n      const devicesMsg = devices.map((dev) => ` - ${dev}`).join('\\n');\n      log.info(`\\nAndroid devices found:\\n${devicesMsg}`);\n      throw new UsageError(\n        'Select an android device using --android-device=<name>');\n    }\n\n    const foundDevices = devices.filter((device) => {\n      return device === adbDevice;\n    });\n\n    if (foundDevices.length === 0) {\n      const devicesMsg = JSON.stringify(devices);\n      throw new UsageError(\n        `Android device ${adbDevice} was not found in list: ${devicesMsg}`);\n    }\n\n    this.selectedAdbDevice = foundDevices[0];\n    log.info(`Selected ADB device: ${this.selectedAdbDevice}`);\n  }\n\n  async apkPackagesDiscoveryAndSelect() {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      params: {\n        firefoxApk,\n      },\n    } = this;\n    // Discovery and select a Firefox for Android version.\n    const packages = await adbUtils.discoverInstalledFirefoxAPKs(\n      selectedAdbDevice,\n      firefoxApk\n    );\n\n    if (packages.length === 0) {\n      throw new UsageError(\n        'No Firefox packages were found on the selected Android device');\n    }\n\n    const pkgsListMsg = (pkgs) => {\n      return pkgs.map((pkg) => ` - ${ pkg}`).join('\\n');\n    };\n\n    if (!firefoxApk) {\n      log.info(`\\nPackages found:\\n${pkgsListMsg(packages)}`);\n\n      if (packages.length > 1) {\n        throw new UsageError('Select one of the packages using --firefox-apk');\n      }\n\n      // If only one APK has been found, select it even if it has not been\n      // specified explicitly on the comment line.\n      this.selectedFirefoxApk = packages[0];\n      log.info(`Selected Firefox for Android APK: ${this.selectedFirefoxApk}`);\n      return;\n    }\n\n    const filteredPackages = packages.filter((line) => line === firefoxApk);\n\n    if (filteredPackages.length === 0) {\n      const pkgsList = pkgsListMsg(filteredPackages);\n      throw new UsageError(\n        `Package ${firefoxApk} was not found in list: ${pkgsList}`\n      );\n    }\n\n    this.selectedFirefoxApk = filteredPackages[0];\n    log.debug(`Selected Firefox for Android APK: ${this.selectedFirefoxApk}`);\n  }\n\n  async adbForceStopSelectedPackage() {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedFirefoxApk,\n    } = this;\n\n    log.info(`Stopping existing instances of ${selectedFirefoxApk}...`);\n    await adbUtils.amForceStopAPK(selectedAdbDevice, selectedFirefoxApk);\n  }\n\n  async adbCheckRuntimePermissions() {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedFirefoxApk,\n    } = this;\n\n    log.debug(`Discovering Android version for ${selectedAdbDevice}...`);\n\n    const androidVersion = await adbUtils.getAndroidVersionNumber(\n      selectedAdbDevice\n    );\n\n    if (typeof androidVersion !== 'number' || Number.isNaN(androidVersion)) {\n      throw new WebExtError(`Invalid Android version: ${androidVersion}`);\n    }\n\n    log.debug(`Detected Android version ${androidVersion}`);\n\n    if (androidVersion < 23) {\n      return;\n    }\n\n    log.debug('Checking read/write permissions needed for web-ext' +\n              `on ${selectedFirefoxApk}...`);\n\n    // Runtime permission needed to be able to run Firefox on a temporarily created profile\n    // on android versions >= 23 (Android Marshmallow, which is the first version where\n    // these permissions are optional and have to be granted explicitly).\n    await adbUtils.ensureRequiredAPKRuntimePermissions(\n      selectedAdbDevice, selectedFirefoxApk, [\n        'android.permission.READ_EXTERNAL_STORAGE',\n        'android.permission.WRITE_EXTERNAL_STORAGE',\n      ]\n    );\n  }\n\n  async adbPrepareProfileDir() {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedFirefoxApk,\n      params: {\n        firefoxApp,\n      },\n    } = this;\n    // Create the preferences file and the Fennec temporary profile.\n    log.debug(`Preparing a temporary profile for ${selectedFirefoxApk}...`);\n\n    const profile = await firefoxApp.createProfile({app: 'fennec'});\n\n    // Choose a artifacts dir name for the assets pushed to the\n    // Android device.\n    this.selectedArtifactsDir = await adbUtils.getOrCreateArtifactsDir(\n      selectedAdbDevice\n    );\n\n    const deviceProfileDir = this.getDeviceProfileDir();\n\n    await adbUtils.runShellCommand(selectedAdbDevice, [\n      'mkdir', '-p', deviceProfileDir,\n    ]);\n    await adbUtils.pushFile(selectedAdbDevice,\n                            path.join(profile.profileDir, 'user.js'),\n                            `${deviceProfileDir}/user.js`);\n\n    log.debug(`Created temporary profile at ${deviceProfileDir}.`);\n  }\n\n  async adbStartSelectedPackage() {\n    const {\n      adbUtils,\n      selectedFirefoxApk,\n      selectedAdbDevice,\n    } = this;\n\n    const deviceProfileDir = this.getDeviceProfileDir();\n\n    log.info(`Starting ${selectedFirefoxApk}...`);\n\n    log.debug(`Using profile ${deviceProfileDir}`);\n\n    await adbUtils.startFirefoxAPK(\n      selectedAdbDevice, selectedFirefoxApk, deviceProfileDir\n    );\n  }\n\n  async buildAndPushExtension(sourceDir: string) {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedArtifactsDir,\n      params: {\n        buildSourceDir,\n      },\n    } = this;\n\n    await withTempDir(async (tmpDir) => {\n      const {extensionPath} = await buildSourceDir(sourceDir, tmpDir.path());\n\n      const extFileName = path.basename(extensionPath, '.zip');\n\n      let adbExtensionPath = this.adbExtensionsPathBySourceDir.get(sourceDir);\n\n      if (!adbExtensionPath) {\n        adbExtensionPath = `${selectedArtifactsDir}/${extFileName}.xpi`;\n      }\n\n      log.debug(`Uploading ${extFileName} on the android device`);\n\n      await adbUtils.pushFile(\n        selectedAdbDevice, extensionPath, adbExtensionPath\n      );\n\n      log.debug(`Upload completed: ${adbExtensionPath}`);\n\n      this.adbExtensionsPathBySourceDir.set(sourceDir, adbExtensionPath);\n    });\n  }\n\n  async buildAndPushExtensions() {\n    for (const {sourceDir} of this.params.extensions) {\n      await this.buildAndPushExtension(sourceDir);\n    }\n  }\n\n  async adbDiscoveryAndForwardRDPUnixSocket() {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedFirefoxApk,\n      params: {\n        firefoxAndroidTimeout,\n      },\n    } = this;\n\n    const stdin = this.params.stdin || process.stdin;\n\n    const {\n      unixSocketDiscoveryRetryInterval,\n    } = FirefoxAndroidExtensionRunner;\n\n    let {\n      unixSocketDiscoveryMaxTime,\n    } = FirefoxAndroidExtensionRunner;\n\n    if (typeof firefoxAndroidTimeout === 'number') {\n      unixSocketDiscoveryMaxTime = firefoxAndroidTimeout;\n    }\n\n    const handleCtrlC = (str, key) => {\n      if (key.ctrl && key.name === 'c') {\n        adbUtils.setUserAbortDiscovery(true);\n      }\n    };\n\n    // TODO: use noInput property to decide if we should\n    // disable direct keypress handling.\n    if (isTTY(stdin)) {\n      readline.emitKeypressEvents(stdin);\n      setRawMode(stdin, true);\n\n      stdin.on('keypress', handleCtrlC);\n    }\n\n    try {\n      // Got a debugger socket file to connect.\n      this.selectedRDPSocketFile = (\n        await adbUtils.discoverRDPUnixSocket(\n          selectedAdbDevice, selectedFirefoxApk, {\n            maxDiscoveryTime: unixSocketDiscoveryMaxTime,\n            retryInterval: unixSocketDiscoveryRetryInterval,\n          }\n        )\n      );\n    } finally {\n      if (isTTY(stdin)) {\n        stdin.removeListener('keypress', handleCtrlC);\n      }\n    }\n\n    log.debug(`RDP Socket File selected: ${this.selectedRDPSocketFile}`);\n\n    const tcpPort = await this.chooseLocalTcpPort();\n\n    // Log the choosen tcp port at info level (useful to the user to be able\n    // to connect the Firefox DevTools to the Firefox for Android instance).\n    log.info(`You can connect to this Android device on TCP port ${tcpPort}`);\n\n    const forwardSocketSpec = this.selectedRDPSocketFile.startsWith('@') ?\n      `localabstract:${this.selectedRDPSocketFile.substr(1)}`\n      : `localfilesystem:${this.selectedRDPSocketFile}`;\n\n    await adbUtils.setupForward(\n      selectedAdbDevice,\n      forwardSocketSpec,\n      `tcp:${tcpPort}`\n    );\n\n    this.selectedTCPPort = tcpPort;\n  }\n\n  chooseLocalTcpPort(): Promise<number> {\n    return new Promise((resolve) => {\n      const srv = net.createServer();\n      // $FLOW_FIXME: flow has his own opinions on this method signature.\n      srv.listen(0, () => {\n        const freeTcpPort = srv.address().port;\n        srv.close();\n        resolve(freeTcpPort);\n      });\n    });\n  }\n\n  async rdpInstallExtensions() {\n    const {\n      selectedTCPPort,\n      params: {\n        extensions,\n        firefoxClient,\n      },\n    } = this;\n\n    const remoteFirefox = this.remoteFirefox = await firefoxClient({\n      port: selectedTCPPort,\n    });\n\n    // Exit and cleanup the extension runner if the connection to the\n    // remote Firefox for Android instance has been closed.\n    remoteFirefox.client.on('end', () => {\n      if (!this.exiting) {\n        log.info('Exiting the device because Firefox for Android disconnected');\n        this.exit();\n      }\n    });\n\n    // Install all the temporary addons.\n    for (const extension of extensions) {\n      const {sourceDir} = extension;\n      const adbExtensionPath = this.adbExtensionsPathBySourceDir.get(\n        sourceDir\n      );\n\n      if (!adbExtensionPath) {\n        throw new WebExtError(\n          `ADB extension path for \"${sourceDir}\" was unexpectedly empty`\n        );\n      }\n\n      const addonId = await (\n        remoteFirefox.installTemporaryAddon(adbExtensionPath)\n          .then((installResult: FirefoxRDPResponseAddon) => {\n            return installResult.addon.id;\n          })\n      );\n\n      if (!addonId) {\n        throw new WebExtError(\n          'Received an empty addonId from ' +\n          `remoteFirefox.installTemporaryAddon(\"${adbExtensionPath}\")`\n        );\n      }\n\n      this.reloadableExtensions.set(extension.sourceDir, addonId);\n    }\n  }\n}\n","/* @flow */\n\n/**\n * This module provide an ExtensionRunner subclass that manage an extension executed\n * in a Firefox for Desktop instance.\n */\n\n// Import flow types from npm dependencies.\nimport type FirefoxProfile from 'firefox-profile';\n\nimport {\n  MultiExtensionsReloadError,\n  RemoteTempInstallNotSupported,\n  WebExtError,\n} from '../errors';\nimport * as defaultFirefoxApp from '../firefox';\nimport {\n  connectWithMaxRetries as defaultFirefoxConnector,\n} from '../firefox/remote';\nimport {createLogger} from '../util/logger';\n// Import flow types from project files.\nimport type {\n  FirefoxRDPResponseAddon,\n  RemoteFirefox,\n} from '../firefox/remote';\nimport type {\n  ExtensionRunnerParams,\n  ExtensionRunnerReloadResult,\n} from './base';\nimport type {FirefoxPreferences} from '../firefox/preferences';\nimport type {FirefoxInfo} from '../firefox/index'; // eslint-disable-line import/named\n\ntype FirefoxDesktopSpecificRunnerParams = {|\n  customPrefs?: FirefoxPreferences,\n  browserConsole: boolean,\n  firefoxBinary: string,\n  preInstall: boolean,\n\n  // Firefox desktop injected dependencies.\n  firefoxApp: typeof defaultFirefoxApp,\n  firefoxClient: typeof defaultFirefoxConnector,\n|};\n\nexport type FirefoxDesktopExtensionRunnerParams = {|\n  ...ExtensionRunnerParams,\n  // Firefox desktop CLI params.\n  ...FirefoxDesktopSpecificRunnerParams,\n|};\n\nconst log = createLogger(__filename);\n\n/**\n * Implements an IExtensionRunner which manages a Firefox Desktop instance.\n */\nexport class FirefoxDesktopExtensionRunner {\n  cleanupCallbacks: Set<Function>;\n  params: FirefoxDesktopExtensionRunnerParams;\n  profile: FirefoxProfile;\n  // Map extensions sourceDir to their related addon ids.\n  reloadableExtensions: Map<string, string>;\n  remoteFirefox: RemoteFirefox;\n  runningInfo: FirefoxInfo;\n\n  constructor(params: FirefoxDesktopExtensionRunnerParams) {\n    this.params = params;\n\n    this.reloadableExtensions = new Map();\n    this.cleanupCallbacks = new Set();\n  }\n\n  // Method exported from the IExtensionRunner interface.\n\n  /**\n   * Returns the runner name.\n   */\n  getName() {\n    return 'Firefox Desktop';\n  }\n\n  /**\n   * Setup the Firefox Profile and run a Firefox Desktop instance.\n   */\n  async run(): Promise<void> {\n    // Get a firefox profile with the custom Prefs set (a new or a cloned one).\n    // Pre-install extensions as proxy if needed (and disable auto-reload if you do)\n    await this.setupProfileDir();\n\n    // (if reload is enabled):\n    // - Connect to the firefox instance on RDP\n    // - Install any extension if needed (if not installed as proxy)\n    // - Keep track of the extension id assigned in a map with the sourceDir as a key\n    await this.startFirefoxInstance();\n  }\n\n  /**\n   * Reloads all the extensions, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadAllExtensions(): Promise<Array<ExtensionRunnerReloadResult>> {\n    const runnerName = this.getName();\n    const reloadErrors = new Map();\n    for (const {sourceDir} of this.params.extensions) {\n      const [res] = await this.reloadExtensionBySourceDir(sourceDir);\n      if (res.reloadError instanceof Error) {\n        reloadErrors.set(sourceDir, res.reloadError);\n      }\n    }\n\n    if (reloadErrors.size > 0) {\n      return [{\n        runnerName,\n        reloadError: new MultiExtensionsReloadError(reloadErrors),\n      }];\n    }\n\n    return [{runnerName}];\n  }\n\n  /**\n   * Reloads a single extension, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadExtensionBySourceDir(\n    extensionSourceDir: string\n  ): Promise<Array<ExtensionRunnerReloadResult>> {\n    const runnerName = this.getName();\n    const addonId = this.reloadableExtensions.get(extensionSourceDir);\n\n    if (!addonId) {\n      return [{\n        sourceDir: extensionSourceDir,\n        reloadError: new WebExtError(\n          'Extension not reloadable: ' +\n          `no addonId has been mapped to \"${extensionSourceDir}\"`\n        ),\n        runnerName,\n      }];\n    }\n\n    try {\n      await this.remoteFirefox.reloadAddon(addonId);\n    } catch (error) {\n      return [{\n        sourceDir: extensionSourceDir,\n        reloadError: error,\n        runnerName,\n      }];\n    }\n\n    return [{runnerName, sourceDir: extensionSourceDir}];\n  }\n\n  /**\n   * Register a callback to be called when the runner has been exited\n   * (e.g. the Firefox instance exits or the user has requested web-ext\n   * to exit).\n   */\n  registerCleanup(fn: Function): void {\n    this.cleanupCallbacks.add(fn);\n  }\n\n  /**\n   * Exits the runner, by closing the managed Firefox instance.\n   */\n  async exit(): Promise<void> {\n    if (!this.runningInfo || !this.runningInfo.firefox) {\n      throw new WebExtError('No firefox instance is currently running');\n    }\n\n    this.runningInfo.firefox.kill();\n  }\n\n  // Private helper methods.\n\n  async setupProfileDir() {\n    const {\n      customPrefs,\n      extensions,\n      keepProfileChanges,\n      preInstall,\n      profilePath,\n      firefoxApp,\n    } = this.params;\n\n    if (profilePath) {\n      if (keepProfileChanges) {\n        log.debug(`Using Firefox profile from ${profilePath}`);\n        this.profile = await firefoxApp.useProfile(profilePath, {customPrefs});\n      } else {\n        log.debug(`Copying Firefox profile from ${profilePath}`);\n        this.profile = await firefoxApp.copyProfile(profilePath, {customPrefs});\n      }\n    } else {\n      log.debug('Creating new Firefox profile');\n      this.profile = await firefoxApp.createProfile({customPrefs});\n    }\n\n    // preInstall the extensions if needed.\n    if (preInstall) {\n      for (const extension of extensions) {\n        await firefoxApp.installExtension({\n          asProxy: true,\n          extensionPath: extension.sourceDir,\n          manifestData: extension.manifestData,\n          profile: this.profile,\n        });\n      }\n    }\n  }\n\n  async startFirefoxInstance() {\n    const {\n      browserConsole,\n      extensions,\n      firefoxBinary,\n      preInstall,\n      startUrl,\n      firefoxApp,\n      firefoxClient,\n      args,\n    } = this.params;\n\n    const binaryArgs = [];\n\n    if (browserConsole) {\n      binaryArgs.push('-jsconsole');\n    }\n    if (startUrl) {\n      const urls = Array.isArray(startUrl) ? startUrl : [startUrl];\n      for (const url of urls) {\n        binaryArgs.push('--url', url);\n      }\n    }\n\n    if (args) {\n      binaryArgs.push(...args);\n    }\n\n    this.runningInfo = await firefoxApp.run(this.profile, {\n      firefoxBinary, binaryArgs,\n    });\n\n    this.runningInfo.firefox.on('close', () => {\n      for (const cleanupCb of this.cleanupCallbacks) {\n        try {\n          cleanupCb();\n        } catch (error) {\n          log.error(`Exception on executing cleanup callback: ${error}`);\n        }\n      }\n    });\n\n    if (!preInstall) {\n      const remoteFirefox = this.remoteFirefox = await firefoxClient({\n        port: this.runningInfo.debuggerPort,\n      });\n\n      // Install all the temporary addons.\n      for (const extension of extensions) {\n        try {\n          const addonId = await (\n            remoteFirefox.installTemporaryAddon(extension.sourceDir)\n              .then((installResult: FirefoxRDPResponseAddon) => {\n                return installResult.addon.id;\n              })\n          );\n\n          if (!addonId) {\n            throw new WebExtError(\n              'Unexpected missing addonId in the installAsTemporaryAddon result'\n            );\n          }\n\n          this.reloadableExtensions.set(extension.sourceDir, addonId);\n        } catch (error) {\n          if (error instanceof RemoteTempInstallNotSupported) {\n            log.debug(`Caught: ${error}`);\n            throw new WebExtError(\n              'Temporary add-on installation is not supported in this version' +\n              ' of Firefox (you need Firefox 49 or higher). For older Firefox' +\n              ' versions, use --pre-install'\n            );\n          } else {\n            throw error;\n          }\n        }\n      }\n    }\n  }\n}\n","/* @flow */\n\nimport readline from 'readline';\n\nimport type Watchpack from 'watchpack';\n\nimport type {\n  IExtensionRunner, // eslint-disable-line import/named\n  ExtensionRunnerReloadResult,\n} from './base';\nimport {WebExtError} from '../errors';\nimport {\n  showDesktopNotification as defaultDesktopNotifications,\n} from '../util/desktop-notifier';\nimport type {FirefoxAndroidExtensionRunnerParams} from './firefox-android';\nimport type {FirefoxDesktopExtensionRunnerParams} from './firefox-desktop';\nimport {createLogger} from '../util/logger';\nimport type {FileFilterCreatorFn} from '../util/file-filter';\nimport {\n  createFileFilter as defaultFileFilterCreator,\n} from '../util/file-filter';\nimport {\n  isTTY, setRawMode,\n} from '../util/stdin';\nimport defaultSourceWatcher from '../watcher';\nimport type {OnSourceChangeFn} from '../watcher';\n\n\nconst log = createLogger(__filename);\n\nexport type ExtensionRunnerConfig = {|\n  target: 'firefox-desktop',\n  params: FirefoxDesktopExtensionRunnerParams,\n|} | {|\n  target: 'firefox-android',\n  params: FirefoxAndroidExtensionRunnerParams,\n|};\n\nexport type MultiExtensionRunnerParams = {|\n  runners: Array<IExtensionRunner>,\n  desktopNotifications: typeof defaultDesktopNotifications,\n|};\n\nexport async function createExtensionRunner(config: ExtensionRunnerConfig) {\n  switch (config.target) {\n    case 'firefox-desktop': {\n      // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n      const {FirefoxDesktopExtensionRunner} = require('./firefox-desktop');\n      return new FirefoxDesktopExtensionRunner(config.params);\n    }\n    case 'firefox-android': {\n      // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n      const {FirefoxAndroidExtensionRunner} = require('./firefox-android');\n      return new FirefoxAndroidExtensionRunner(config.params);\n    }\n    default:\n      throw new WebExtError(`Unknown target: \"${config.target}\"`);\n  }\n}\n\n/**\n * Implements an IExtensionRunner which allow the caller to\n * manage multiple extension runners at the same time (e.g. by running\n * a Firefox Desktop instance alongside to a Firefox for Android instance).\n */\nexport class MultiExtensionRunner {\n  extensionRunners: Array<IExtensionRunner>;\n  desktopNotifications: typeof defaultDesktopNotifications;\n\n  constructor(params: MultiExtensionRunnerParams) {\n    this.extensionRunners = params.runners;\n    this.desktopNotifications = params.desktopNotifications;\n  }\n\n  // Method exported from the IExtensionRunner interface.\n\n  /**\n   * Returns the runner name.\n   */\n  getName() {\n    return 'Multi Extension Runner';\n  }\n\n  /**\n   * Call the `run` method on all the managed extension runners,\n   * and awaits that all the runners has been successfully started.\n   */\n  async run(): Promise<void> {\n    const promises = [];\n    for (const runner of this.extensionRunners) {\n      promises.push(runner.run());\n    }\n\n    await Promise.all(promises);\n  }\n\n  /**\n   * Reloads all the extensions on all the managed extension runners,\n   * collect any reload error, and resolves to an array composed by\n   * a ExtensionRunnerReloadResult object per managed runner.\n   *\n   * Any detected reload error is also logged on the terminal and shows as a\n   * desktop notification.\n   */\n  async reloadAllExtensions(): Promise<Array<ExtensionRunnerReloadResult>> {\n    log.debug('Reloading all reloadable add-ons');\n\n    const promises = [];\n    for (const runner of this.extensionRunners) {\n      const reloadPromise = runner.reloadAllExtensions().then(\n        () => {\n          return {runnerName: runner.getName()};\n        },\n        (error) => {\n          return {\n            runnerName: runner.getName(),\n            reloadError: error,\n          };\n        }\n      );\n\n      promises.push(reloadPromise);\n    }\n\n    return await Promise.all(promises).then((results) => {\n      this.handleReloadResults(results);\n      return results;\n    });\n  }\n\n  /**\n   * Reloads a single extension on all the managed extension runners,\n   * collect any reload error and resolves to an array composed by\n   * a ExtensionRunnerReloadResult object per managed runner.\n   *\n   * Any detected reload error is also logged on the terminal and shows as a\n   * desktop notification.\n   */\n  async reloadExtensionBySourceDir(\n    sourceDir: string\n  ): Promise<Array<ExtensionRunnerReloadResult>> {\n    log.debug(`Reloading add-on at ${sourceDir}`);\n\n    const promises = [];\n    for (const runner of this.extensionRunners) {\n      const reloadPromise = runner.reloadExtensionBySourceDir(sourceDir).then(\n        () => {\n          return {runnerName: runner.getName(), sourceDir};\n        },\n        (error) => {\n          return {\n            runnerName: runner.getName(),\n            reloadError: error,\n            sourceDir,\n          };\n        }\n      );\n\n      promises.push(reloadPromise);\n    }\n\n    // $FLOW_FIXME: When upgrading to Flow 0.61.0, it could not follow the type of sourceDir in the array of promises.\n    return await Promise.all(promises).then((results) => {\n      this.handleReloadResults(results);\n      return results;\n    });\n  }\n\n  /**\n   * Register a callback to be called when all the managed runners has been exited.\n   */\n  registerCleanup(cleanupCallback: Function): void {\n    const promises = [];\n\n    // Create a promise for every extension runner managed by this instance,\n    // the promise will be resolved when the particular runner calls its\n    // registered cleanup callbacks.\n    for (const runner of this.extensionRunners) {\n      promises.push(new Promise((resolve) => {\n        runner.registerCleanup(resolve);\n      }));\n    }\n\n    // Wait for all the created promises to be resolved or rejected\n    // (once each one of the runners has cleaned up) and then call\n    // the cleanup callback registered to this runner.\n    Promise.all(promises).then(cleanupCallback, cleanupCallback);\n  }\n\n  /**\n   * Exits all the managed runner has been exited.\n   */\n  async exit(): Promise<void> {\n    const promises = [];\n    for (const runner of this.extensionRunners) {\n      promises.push(runner.exit());\n    }\n\n    await Promise.all(promises);\n  }\n\n  // Private helper methods.\n\n  handleReloadResults(results: Array<ExtensionRunnerReloadResult>): void {\n    for (const {runnerName, reloadError, sourceDir} of results) {\n      if (reloadError instanceof Error) {\n        let message = 'Error occurred while reloading';\n        if (sourceDir) {\n          message += ` \"${sourceDir}\" `;\n        }\n\n        message += `on \"${runnerName}\" - ${reloadError.message}`;\n\n        log.error(`\\n${message}`);\n        log.debug(reloadError.stack);\n\n        this.desktopNotifications({\n          title: 'web-ext run: extension reload error',\n          message,\n        });\n      }\n    }\n  }\n}\n\n// defaultWatcherCreator types and implementation.\n\nexport type WatcherCreatorParams = {|\n  reloadExtension: (string) => void,\n  sourceDir: string,\n  artifactsDir: string,\n  onSourceChange?: OnSourceChangeFn,\n  ignoreFiles?: Array<string>,\n  createFileFilter?: FileFilterCreatorFn,\n|};\n\nexport type WatcherCreatorFn = (params: WatcherCreatorParams) => Watchpack;\n\nexport function defaultWatcherCreator(\n  {\n    reloadExtension, sourceDir, artifactsDir, ignoreFiles,\n    onSourceChange = defaultSourceWatcher,\n    createFileFilter = defaultFileFilterCreator,\n  }: WatcherCreatorParams\n): Watchpack {\n  const fileFilter = createFileFilter(\n    {sourceDir, artifactsDir, ignoreFiles}\n  );\n  return onSourceChange({\n    sourceDir,\n    artifactsDir,\n    onChange: () => reloadExtension(sourceDir),\n    shouldWatchFile: (file) => fileFilter.wantFile(file),\n  });\n}\n\n\n// defaultReloadStrategy types and implementation.\n\nexport type ReloadStrategyParams = {|\n  extensionRunner: IExtensionRunner,\n  sourceDir: string,\n  artifactsDir: string,\n  ignoreFiles?: Array<string>,\n  noInput?: boolean,\n|};\n\nexport type ReloadStrategyOptions = {|\n  createWatcher?: WatcherCreatorFn,\n  stdin?: stream$Readable,\n  kill?: typeof process.kill,\n|};\n\nexport function defaultReloadStrategy(\n  {\n    artifactsDir,\n    extensionRunner,\n    ignoreFiles,\n    noInput = false,\n    sourceDir,\n  }: ReloadStrategyParams,\n  {\n    createWatcher = defaultWatcherCreator,\n    stdin = process.stdin,\n    kill = process.kill,\n  }: ReloadStrategyOptions = {}\n): void {\n  const allowInput = !noInput;\n  if (!allowInput) {\n    log.debug('Input has been disabled because of noInput==true');\n  }\n\n  const watcher: Watchpack = createWatcher({\n    reloadExtension: (watchedSourceDir) => {\n      extensionRunner.reloadExtensionBySourceDir(watchedSourceDir);\n    },\n    sourceDir,\n    artifactsDir,\n    ignoreFiles,\n  });\n\n  extensionRunner.registerCleanup(() => {\n    watcher.close();\n    if (allowInput) {\n      stdin.pause();\n    }\n  });\n\n  if (allowInput && isTTY(stdin)) {\n    readline.emitKeypressEvents(stdin);\n    setRawMode(stdin, true);\n\n    const keypressUsageInfo = 'Press R to reload (and Ctrl-C to quit)';\n\n    // NOTE: this `Promise.resolve().then(...)` is basically used to spawn a \"co-routine\"\n    // that is executed before the callback attached to the Promise returned by this function\n    // (and it allows the `run` function to not be stuck in the while loop).\n    Promise.resolve().then(async function() {\n      log.info(keypressUsageInfo);\n\n      let userExit = false;\n\n      while (!userExit) {\n        const keyPressed = await new Promise((resolve) => {\n          stdin.once('keypress', (str, key) => resolve(key));\n        });\n\n        if (keyPressed.ctrl && keyPressed.name === 'c') {\n          userExit = true;\n        } else if (keyPressed.name === 'z') {\n          // Prepare to suspend.\n\n          // NOTE: Switch the raw mode off before suspending (needed to make the keypress event\n          // to work correctly when the nodejs process is resumed).\n          setRawMode(stdin, false);\n\n          log.info('\\nweb-ext has been suspended on user request');\n          kill(process.pid, 'SIGTSTP');\n\n          // Prepare to resume.\n\n          log.info(`\\nweb-ext has been resumed. ${keypressUsageInfo}`);\n\n          // Switch the raw mode on on resume.\n          setRawMode(stdin, true);\n        } else if (keyPressed.name === 'r') {\n          log.debug('Reloading installed extensions on user request');\n          extensionRunner.reloadAllExtensions();\n        }\n      }\n\n      log.info('\\nExiting web-ext on user request');\n      extensionRunner.exit();\n    });\n  }\n}\n","/* @flow */\nimport nodeFs from 'fs';\nimport path from 'path';\nimport {promisify} from 'util';\n\nimport {default as defaultFxRunner} from 'fx-runner';\nimport FirefoxProfile, {copyFromUserProfile as defaultUserProfileCopier}\n  from 'firefox-profile';\nimport {fs} from 'mz';\nimport eventToPromise from 'event-to-promise';\n\nimport isDirectory from '../util/is-directory';\nimport {isErrorWithCode, UsageError, WebExtError} from '../errors';\nimport {getPrefs as defaultPrefGetter} from './preferences';\nimport {getManifestId} from '../util/manifest';\nimport {createLogger} from '../util/logger';\nimport {connect as defaultFirefoxConnector, REMOTE_PORT} from './remote';\n// Import flow types\nimport type {FirefoxConnectorFn} from './remote';\nimport type {\n  PreferencesAppName,\n  PreferencesGetterFn,\n  FirefoxPreferences,\n} from './preferences';\nimport type {ExtensionManifest} from '../util/manifest';\n\n\nconst log = createLogger(__filename);\n\nconst defaultAsyncFsStat = fs.stat.bind(fs);\n\nexport const defaultFirefoxEnv = {\n  XPCOM_DEBUG_BREAK: 'stack',\n  NS_TRACE_MALLOC_DISABLE_STACKS: '1',\n};\n\n// defaultRemotePortFinder types and implementation.\n\nexport type RemotePortFinderParams = {|\n  portToTry?: number,\n  retriesLeft?: number,\n  connectToFirefox?: FirefoxConnectorFn,\n|};\n\nexport type RemotePortFinderFn =\n  (params?: RemotePortFinderParams) => Promise<number>;\n\nexport async function defaultRemotePortFinder(\n  {\n    portToTry = REMOTE_PORT,\n    retriesLeft = 10,\n    connectToFirefox = defaultFirefoxConnector,\n  }: RemotePortFinderParams = {}\n): Promise<number> {\n  log.debug(`Checking if remote Firefox port ${portToTry} is available`);\n\n  let client;\n\n  while (retriesLeft >= 0) {\n    try {\n      client = await connectToFirefox(portToTry);\n      log.debug(`Remote Firefox port ${portToTry} is in use ` +\n                `(retries remaining: ${retriesLeft})`);\n    } catch (error) {\n      if (isErrorWithCode('ECONNREFUSED', error)) {\n        // The connection was refused so this port is good to use.\n        return portToTry;\n      }\n\n      throw error;\n    }\n\n    client.disconnect();\n    portToTry++;\n    retriesLeft--;\n  }\n\n  throw new WebExtError('Too many retries on port search');\n}\n\n\n// Declare the needed 'fx-runner' module flow types.\n\nexport type FirefoxRunnerParams = {|\n  binary: ?string,\n  profile?: string,\n  'new-instance'?: boolean,\n  'no-remote'?: boolean,\n  'foreground'?: boolean,\n  'listen': number,\n  'binary-args'?: Array<string> | string,\n  'env'?: {\n    [key: string]: string\n  },\n  'verbose'?: boolean,\n|};\n\nexport interface FirefoxProcess extends events$EventEmitter {\n  stderr: events$EventEmitter;\n  stdout: events$EventEmitter;\n  kill: Function;\n}\n\nexport type FirefoxRunnerResults = {|\n  process: FirefoxProcess,\n  binary: string,\n  args: Array<string>,\n|}\n\nexport type FirefoxRunnerFn =\n  (params: FirefoxRunnerParams) => Promise<FirefoxRunnerResults>;\n\n\nexport type FirefoxInfo = {|\n  firefox: FirefoxProcess,\n  debuggerPort: number,\n|}\n\n// Run command types and implementaion.\n\nexport type FirefoxRunOptions = {|\n  fxRunner?: FirefoxRunnerFn,\n  findRemotePort?: RemotePortFinderFn,\n  firefoxBinary?: string,\n  binaryArgs?: Array<string>,\n  args?: Array<any>,\n|};\n\n/*\n * Runs Firefox with the given profile object and resolves a promise on exit.\n */\nexport async function run(\n  profile: FirefoxProfile,\n  {\n    fxRunner = defaultFxRunner,\n    findRemotePort = defaultRemotePortFinder,\n    firefoxBinary, binaryArgs,\n  }: FirefoxRunOptions = {}\n): Promise<FirefoxInfo> {\n\n  log.debug(`Running Firefox with profile at ${profile.path()}`);\n\n  const remotePort = await findRemotePort();\n\n  const results = await fxRunner({\n    // if this is falsey, fxRunner tries to find the default one.\n    'binary': firefoxBinary,\n    'binary-args': binaryArgs,\n    // This ensures a new instance of Firefox is created. It has nothing\n    // to do with the devtools remote debugger.\n    'no-remote': true,\n    'listen': remotePort,\n    'foreground': true,\n    'profile': profile.path(),\n    'env': {\n      ...process.env,\n      ...defaultFirefoxEnv,\n    },\n    'verbose': true,\n  });\n\n  const firefox = results.process;\n\n  log.debug(`Executing Firefox binary: ${results.binary}`);\n  log.debug(`Firefox args: ${results.args.join(' ')}`);\n\n  firefox.on('error', (error) => {\n    // TODO: show a nice error when it can't find Firefox.\n    // if (/No such file/.test(err) || err.code === 'ENOENT') {\n    log.error(`Firefox error: ${error}`);\n    throw error;\n  });\n\n  log.info(\n    'Use --verbose or open Tools > Web Developer > Browser Console ' +\n    'to see logging');\n\n  firefox.stderr.on('data', (data) => {\n    log.debug(`Firefox stderr: ${data.toString().trim()}`);\n  });\n\n  firefox.stdout.on('data', (data) => {\n    log.debug(`Firefox stdout: ${data.toString().trim()}`);\n  });\n\n  firefox.on('close', () => {\n    log.debug('Firefox closed');\n  });\n\n  return { firefox, debuggerPort: remotePort };\n}\n\n\n// isDefaultProfile types and implementation.\n\nconst DEFAULT_PROFILES_NAMES = [\n  'default',\n  'dev-edition-default',\n];\n\nexport type IsDefaultProfileFn = (\n  profilePathOrName: string,\n  ProfileFinder?: typeof FirefoxProfile.Finder,\n  fsStat?: typeof fs.stat,\n) => Promise<boolean>;\n\n/*\n * Tests if a profile is a default Firefox profile (both as a profile name or\n * profile path).\n *\n * Returns a promise that resolves to true if the profile is one of default Firefox profile.\n */\nexport async function isDefaultProfile(\n  profilePathOrName: string,\n  ProfileFinder?: typeof FirefoxProfile.Finder = FirefoxProfile.Finder,\n  fsStat?: typeof fs.stat = fs.stat,\n): Promise<boolean> {\n  if (DEFAULT_PROFILES_NAMES.includes(profilePathOrName)) {\n    return true;\n  }\n\n  const baseProfileDir = ProfileFinder.locateUserDirectory();\n  const profilesIniPath = path.join(baseProfileDir, 'profiles.ini');\n  try {\n    await fsStat(profilesIniPath);\n  } catch (error) {\n    if (isErrorWithCode('ENOENT', error)) {\n      log.debug(`profiles.ini not found: ${error}`);\n\n      // No profiles exist yet, default to false (the default profile name contains a\n      // random generated component).\n      return false;\n    }\n\n    // Re-throw any unexpected exception.\n    throw error;\n  }\n\n  // Check for profile dir path.\n  const finder = new ProfileFinder(baseProfileDir);\n  const readProfiles = promisify(finder.readProfiles.bind(finder));\n\n  await readProfiles();\n\n  const normalizedProfileDirPath = path.normalize(\n    path.join(path.resolve(profilePathOrName), path.sep)\n  );\n\n  for (const profile of finder.profiles) {\n    // Check if the profile dir path or name is one of the default profiles\n    // defined in the profiles.ini file.\n    if (DEFAULT_PROFILES_NAMES.includes(profile.Name) ||\n        profile.Default === '1') {\n      let profileFullPath;\n\n      // Check for profile name.\n      if (profile.Name === profilePathOrName) {\n        return true;\n      }\n\n      // Check for profile path.\n      if (profile.IsRelative === '1') {\n        profileFullPath = path.join(baseProfileDir, profile.Path, path.sep);\n      } else {\n        profileFullPath = path.join(profile.Path, path.sep);\n      }\n\n      if (path.normalize(profileFullPath) === normalizedProfileDirPath) {\n        return true;\n      }\n    }\n  }\n\n  // Profile directory not found.\n  return false;\n}\n\n// configureProfile types and implementation.\n\nexport type ConfigureProfileOptions = {|\n  app?: PreferencesAppName,\n  getPrefs?: PreferencesGetterFn,\n  customPrefs?: FirefoxPreferences,\n|};\n\nexport type ConfigureProfileFn = (\n  profile: FirefoxProfile,\n  options?: ConfigureProfileOptions\n) => Promise<FirefoxProfile>;\n\n/*\n * Configures a profile with common preferences that are required to\n * activate extension development.\n *\n * Returns a promise that resolves with the original profile object.\n */\nexport function configureProfile(\n  profile: FirefoxProfile,\n  {\n    app = 'firefox',\n    getPrefs = defaultPrefGetter,\n    customPrefs = {},\n  }: ConfigureProfileOptions = {},\n): Promise<FirefoxProfile> {\n  // Set default preferences. Some of these are required for the add-on to\n  // operate, such as disabling signatures.\n  const prefs = getPrefs(app);\n  Object.keys(prefs).forEach((pref) => {\n    profile.setPreference(pref, prefs[pref]);\n  });\n  if (Object.keys(customPrefs).length > 0) {\n    const customPrefsStr = JSON.stringify(customPrefs, null, 2);\n    log.info(`Setting custom Firefox preferences: ${customPrefsStr}`);\n    Object.keys(customPrefs).forEach((custom) => {\n      profile.setPreference(custom, customPrefs[custom]);\n    });\n  }\n  profile.updatePreferences();\n  return Promise.resolve(profile);\n}\n\nexport type getProfileFn = (profileName: string) => Promise<string | void>;\n\nexport type CreateProfileFinderParams = {|\n  userDirectoryPath?: string,\n  FxProfile?: typeof FirefoxProfile\n|}\n\nexport function defaultCreateProfileFinder(\n  {\n    userDirectoryPath,\n    FxProfile = FirefoxProfile,\n  }: CreateProfileFinderParams = {}\n): getProfileFn {\n  const finder = new FxProfile.Finder(userDirectoryPath);\n  const readProfiles = promisify(finder.readProfiles.bind(finder));\n  const getPath = promisify(finder.getPath.bind(finder));\n  return async (profileName: string): Promise<string | void> => {\n    try {\n      await readProfiles();\n      const hasProfileName = finder.profiles.filter(\n        (profileDef) => profileDef.Name === profileName).length !== 0;\n      if (hasProfileName) {\n        return await getPath(profileName);\n      }\n    } catch (error) {\n      if (!isErrorWithCode('ENOENT', error)) {\n        throw error;\n      }\n      log.warn('Unable to find Firefox profiles.ini');\n    }\n  };\n}\n\n// useProfile types and implementation.\n\nexport type UseProfileParams = {\n  app?: PreferencesAppName,\n  configureThisProfile?: ConfigureProfileFn,\n  isFirefoxDefaultProfile?: IsDefaultProfileFn,\n  customPrefs?: FirefoxPreferences,\n  createProfileFinder?: typeof defaultCreateProfileFinder,\n};\n\n// Use the target path as a Firefox profile without cloning it\n\nexport async function useProfile(\n  profilePath: string,\n  {\n    app,\n    configureThisProfile = configureProfile,\n    isFirefoxDefaultProfile = isDefaultProfile,\n    customPrefs = {},\n    createProfileFinder = defaultCreateProfileFinder,\n  }: UseProfileParams = {},\n): Promise<FirefoxProfile> {\n  const isForbiddenProfile = await isFirefoxDefaultProfile(profilePath);\n  if (isForbiddenProfile) {\n    throw new UsageError(\n      'Cannot use --keep-profile-changes on a default profile' +\n      ` (\"${profilePath}\")` +\n      ' because web-ext will make it insecure and unsuitable for daily use.' +\n      '\\nSee https://github.com/mozilla/web-ext/issues/1005'\n    );\n  }\n\n  let destinationDirectory;\n  const getProfilePath = createProfileFinder();\n\n  const profileIsDirPath = await isDirectory(profilePath);\n  if (profileIsDirPath) {\n    log.debug(`Using profile directory \"${profilePath}\"`);\n    destinationDirectory = profilePath;\n  } else {\n    log.debug(`Assuming ${profilePath} is a named profile`);\n    destinationDirectory = await getProfilePath(profilePath);\n    if (!destinationDirectory) {\n      throw new UsageError(\n        `The request \"${profilePath}\" profile name ` +\n        'cannot be resolved to a profile path'\n      );\n    }\n  }\n\n  const profile = new FirefoxProfile({destinationDirectory});\n  return await configureThisProfile(profile, {app, customPrefs});\n}\n\n\n// createProfile types and implementation.\n\nexport type CreateProfileParams = {\n  app?: PreferencesAppName,\n  configureThisProfile?: ConfigureProfileFn,\n  customPrefs?: FirefoxPreferences,\n};\n\n/*\n * Creates a new temporary profile and resolves with the profile object.\n *\n * The profile will be deleted when the system process exits.\n */\nexport async function createProfile(\n  {\n    app,\n    configureThisProfile = configureProfile,\n    customPrefs = {},\n  }: CreateProfileParams = {},\n): Promise<FirefoxProfile> {\n  const profile = new FirefoxProfile();\n  return await configureThisProfile(profile, {app, customPrefs});\n}\n\n\n// copyProfile types and implementation.\n\nexport type CopyProfileOptions = {|\n  app?: PreferencesAppName,\n  configureThisProfile?: ConfigureProfileFn,\n  copyFromUserProfile?: Function,\n  customPrefs?: FirefoxPreferences,\n|};\n\n/*\n * Copies an existing Firefox profile and creates a new temporary profile.\n * The new profile will be configured with some preferences required to\n * activate extension development.\n *\n * It resolves with the new profile object.\n *\n * The temporary profile will be deleted when the system process exits.\n *\n * The existing profile can be specified as a directory path or a name of\n * one that exists in the current user's Firefox directory.\n */\nexport async function copyProfile(\n  profileDirectory: string,\n  {\n    app,\n    configureThisProfile = configureProfile,\n    copyFromUserProfile = defaultUserProfileCopier,\n    customPrefs = {},\n  }: CopyProfileOptions = {},\n): Promise<FirefoxProfile> {\n\n  const copy = promisify(FirefoxProfile.copy);\n  const copyByName = promisify(copyFromUserProfile);\n\n  try {\n    const dirExists = await isDirectory(profileDirectory);\n\n    let profile;\n\n    if (dirExists) {\n      log.debug(`Copying profile directory from \"${profileDirectory}\"`);\n      profile = await copy({profileDirectory});\n    } else {\n      log.debug(`Assuming ${profileDirectory} is a named profile`);\n      profile = await copyByName({name: profileDirectory});\n    }\n\n    return configureThisProfile(profile, {app, customPrefs});\n  } catch (error) {\n    throw new WebExtError(\n      `Could not copy Firefox profile from ${profileDirectory}: ${error}`);\n  }\n}\n\n\n// installExtension types and implementation.\n\nexport type InstallExtensionParams = {|\n  asProxy?: boolean,\n  manifestData: ExtensionManifest,\n  profile: FirefoxProfile,\n  extensionPath: string,\n  asyncFsStat?: typeof defaultAsyncFsStat,\n|};\n\n/*\n * Installs an extension into the given Firefox profile object.\n * Resolves when complete.\n *\n * The extension is copied into a special location and you need to turn\n * on some preferences to allow this. See extensions.autoDisableScopes in\n * ./preferences.js.\n *\n * When asProxy is true, a special proxy file will be installed. This is a\n * text file that contains the path to the extension source.\n */\nexport async function installExtension(\n  {\n    asProxy = false,\n    manifestData,\n    profile,\n    extensionPath,\n    asyncFsStat = defaultAsyncFsStat,\n  }: InstallExtensionParams): Promise<any> {\n  // This more or less follows\n  // https://github.com/saadtazi/firefox-profile-js/blob/master/lib/firefox_profile.js#L531\n  // (which is broken for web extensions).\n  // TODO: maybe uplift a patch that supports web extensions instead?\n\n  if (!profile.extensionsDir) {\n    throw new WebExtError('profile.extensionsDir was unexpectedly empty');\n  }\n\n  try {\n    await asyncFsStat(profile.extensionsDir);\n  } catch (error) {\n    if (isErrorWithCode('ENOENT', error)) {\n      log.debug(`Creating extensions directory: ${profile.extensionsDir}`);\n      await fs.mkdir(profile.extensionsDir);\n    } else {\n      throw error;\n    }\n  }\n\n  const id = getManifestId(manifestData);\n  if (!id) {\n    throw new UsageError(\n      'An explicit extension ID is required when installing to ' +\n      'a profile (applications.gecko.id not found in manifest.json)');\n  }\n\n  if (asProxy) {\n    log.debug(`Installing as an extension proxy; source: ${extensionPath}`);\n\n    const isDir = await isDirectory(extensionPath);\n    if (!isDir) {\n      throw new WebExtError(\n        'proxy install: extensionPath must be the extension source ' +\n        `directory; got: ${extensionPath}`);\n    }\n\n    // Write a special extension proxy file containing the source\n    // directory. See:\n    // https://developer.mozilla.org/en-US/Add-ons/Setting_up_extension_development_environment#Firefox_extension_proxy_file\n    const destPath = path.join(profile.extensionsDir, `${id}`);\n    const writeStream = nodeFs.createWriteStream(destPath);\n    writeStream.write(extensionPath);\n    writeStream.end();\n    return await eventToPromise(writeStream, 'close');\n  } else {\n    // Write the XPI file to the profile.\n    const readStream = nodeFs.createReadStream(extensionPath);\n    const destPath = path.join(profile.extensionsDir, `${id}.xpi`);\n    const writeStream = nodeFs.createWriteStream(destPath);\n\n    log.debug(`Installing extension from ${extensionPath} to ${destPath}`);\n    readStream.pipe(writeStream);\n\n    return await Promise.all([\n      eventToPromise(readStream, 'close'),\n      eventToPromise(writeStream, 'close'),\n    ]);\n  }\n}\n","/* @flow */\nimport {WebExtError, UsageError} from '../errors';\nimport {createLogger} from '../util/logger';\n\nconst log = createLogger(__filename);\nexport const nonOverridablePreferences = [\n  'devtools.debugger.remote-enabled', 'devtools.debugger.prompt-connection',\n  'xpinstall.signatures.required',\n];\n\n// Flow Types\n\nexport type FirefoxPreferences = {\n  [key: string]: boolean | string | number,\n};\n\nexport type PreferencesAppName = 'firefox' | 'fennec';\n\n\n// Preferences Maps\n\nconst prefsCommon: FirefoxPreferences = {\n  // Allow debug output via dump to be printed to the system console\n  'browser.dom.window.dump.enabled': true,\n\n  // Allow remote connections to the debugger.\n  'devtools.debugger.remote-enabled': true,\n  // Disable the prompt for allowing connections.\n  'devtools.debugger.prompt-connection': false,\n\n  // Turn off platform logging because it is a lot of info.\n  'extensions.logging.enabled': false,\n\n  // Disable extension updates and notifications.\n  'extensions.checkCompatibility.nightly': false,\n  'extensions.update.enabled': false,\n  'extensions.update.notifyUser': false,\n\n  // From:\n  // http://hg.mozilla.org/mozilla-central/file/1dd81c324ac7/build/automation.py.in//l372\n  // Only load extensions from the application and user profile.\n  // AddonManager.SCOPE_PROFILE + AddonManager.SCOPE_APPLICATION\n  'extensions.enabledScopes': 5,\n  // Disable metadata caching for installed add-ons by default.\n  'extensions.getAddons.cache.enabled': false,\n  // Disable intalling any distribution add-ons.\n  'extensions.installDistroAddons': false,\n  // Allow installing extensions dropped into the profile folder.\n  'extensions.autoDisableScopes': 10,\n\n  // Disable app update.\n  'app.update.enabled': false,\n\n  // Allow unsigned add-ons.\n  'xpinstall.signatures.required': false,\n};\n\n// Prefs specific to Firefox for Android.\nconst prefsFennec: FirefoxPreferences = {\n  'browser.console.showInPanel': true,\n  'browser.firstrun.show.uidiscovery': false,\n  'devtools.remote.usb.enabled': true,\n};\n\n// Prefs specific to Firefox for desktop.\nconst prefsFirefox: FirefoxPreferences = {\n  'browser.startup.homepage': 'about:blank',\n  'startup.homepage_welcome_url': 'about:blank',\n  'startup.homepage_welcome_url.additional': '',\n  'devtools.errorconsole.enabled': true,\n  'devtools.chrome.enabled': true,\n\n  // From:\n  // http://hg.mozilla.org/mozilla-central/file/1dd81c324ac7/build/automation.py.in//l388\n  // Make url-classifier updates so rare that they won't affect tests.\n  'urlclassifier.updateinterval': 172800,\n  // Point the url-classifier to a nonexistent local URL for fast failures.\n  'browser.safebrowsing.provider.0.gethashURL':\n    'http://localhost/safebrowsing-dummy/gethash',\n  'browser.safebrowsing.provider.0.keyURL':\n    'http://localhost/safebrowsing-dummy/newkey',\n  'browser.safebrowsing.provider.0.updateURL':\n    'http://localhost/safebrowsing-dummy/update',\n\n  // Disable self repair/SHIELD\n  'browser.selfsupport.url': 'https://localhost/selfrepair',\n  // Disable Reader Mode UI tour\n  'browser.reader.detectedFirstArticle': true,\n\n  // Set the policy firstURL to an empty string to prevent\n  // the privacy info page to be opened on every \"web-ext run\".\n  // (See #1114 for rationale)\n  'datareporting.policy.firstRunURL': '',\n};\n\nconst prefs = {\n  common: prefsCommon,\n  fennec: prefsFennec,\n  firefox: prefsFirefox,\n};\n\n\n// Module exports\n\nexport type PreferencesGetterFn =\n  (appName: PreferencesAppName) => FirefoxPreferences;\n\nexport function getPrefs(\n  app: PreferencesAppName = 'firefox'\n): FirefoxPreferences {\n  const appPrefs = prefs[app];\n  if (!appPrefs) {\n    throw new WebExtError(`Unsupported application: ${app}`);\n  }\n  return {\n    ...prefsCommon,\n    ...appPrefs,\n  };\n}\n\nexport function coerceCLICustomPreference(\n  cliPrefs: Array<string>\n): FirefoxPreferences {\n  const customPrefs = {};\n\n  for (const pref of cliPrefs) {\n    const prefsAry = pref.split('=');\n\n    if (prefsAry.length < 2) {\n      throw new UsageError(\n        `Incomplete custom preference: \"${pref}\". ` +\n        'Syntax expected: \"prefname=prefvalue\".'\n      );\n    }\n\n    const key = prefsAry[0];\n    let value = prefsAry.slice(1).join('=');\n\n    if (/[^\\w{@}.-]/.test(key)) {\n      throw new UsageError(`Invalid custom preference name: ${key}`);\n    }\n\n    if (value === `${parseInt(value)}`) {\n      value = parseInt(value, 10);\n    } else if (value === 'true' || value === 'false') {\n      value = (value === 'true');\n    }\n\n    if (nonOverridablePreferences.includes(key)) {\n      log.warn(`'${key}' preference cannot be customized.`);\n      continue;\n    }\n    customPrefs[`${key}`] = value;\n  }\n\n  return customPrefs;\n}\n","/* @flow */\nimport defaultFirefoxConnector from '@cliqz-oss/node-firefox-connect';\n// RemoteFirefox types and implementation\nimport type FirefoxClient from '@cliqz-oss/firefox-client';\n\nimport {createLogger} from '../util/logger';\nimport {\n  isErrorWithCode,\n  RemoteTempInstallNotSupported,\n  UsageError,\n  WebExtError,\n} from '../errors';\n\nconst log = createLogger(__filename);\n\n// The default port that Firefox's remote debugger will listen on and the\n// client will connect to.\nexport const REMOTE_PORT = 6005;\n\nexport type FirefoxConnectorFn =\n  (port?: number) => Promise<FirefoxClient>;\n\nexport type FirefoxRDPAddonActor = {|\n  id: string,\n  actor: string,\n|};\n\nexport type FirefoxRDPResponseError = {|\n  error: {\n    message: string,\n  },\n|};\n\nexport type FirefoxRDPResponseAddon = {|\n  addon: FirefoxRDPAddonActor,\n|};\n\nexport type FirefoxRDPResponseRequestTypes = {|\n  requestTypes: Array<string>,\n|};\n\n// NOTE: this type aliases Object to catch any other possible response.\nexport type FirefoxRDPResponseAny = Object;\n\nexport type FirefoxRDPResponseMaybe =\n  FirefoxRDPResponseRequestTypes | FirefoxRDPResponseAny;\n\nexport class RemoteFirefox {\n  client: Object;\n  checkedForAddonReloading: boolean;\n\n  constructor(client: FirefoxClient) {\n    this.client = client;\n    this.checkedForAddonReloading = false;\n\n    client.client.on('disconnect', () => {\n      log.debug('Received \"disconnect\" from Firefox client');\n    });\n    client.client.on('end', () => {\n      log.debug('Received \"end\" from Firefox client');\n    });\n    client.client.on('message', (info) => {\n      // These are arbitrary messages that the client library ignores.\n      log.debug(`Received message from client: ${JSON.stringify(info)}`);\n    });\n  }\n\n  disconnect() {\n    this.client.disconnect();\n  }\n\n  addonRequest(\n    addon: FirefoxRDPAddonActor,\n    request: string\n  ): Promise<FirefoxRDPResponseMaybe> {\n    return new Promise((resolve, reject) => {\n      this.client.client.makeRequest(\n        {to: addon.actor, type: request}, (response) => {\n          if (response.error) {\n            const error = `${response.error}: ${response.message}`;\n            log.debug(\n              `Client responded to '${request}' request with error:`, error);\n            reject(new WebExtError(error));\n          } else {\n            resolve(response);\n          }\n        });\n    });\n  }\n\n  installTemporaryAddon(\n    addonPath: string\n  ): Promise<FirefoxRDPResponseAddon> {\n    return new Promise((resolve, reject) => {\n      this.client.request('listTabs', (error, tabsResponse) => {\n        if (error) {\n          return reject(new WebExtError(\n            `Remote Firefox: listTabs() error: ${error}`));\n        }\n        if (!tabsResponse.addonsActor) {\n          log.debug(\n            'listTabs returned a falsey addonsActor: ' +\n            `${tabsResponse.addonsActor}`);\n          return reject(new RemoteTempInstallNotSupported(\n            'This is an older version of Firefox that does not provide an ' +\n            'add-ons actor for remote installation. Try Firefox 49 or ' +\n            'higher.'));\n        }\n\n        this.client.client.makeRequest({\n          to: tabsResponse.addonsActor,\n          type: 'installTemporaryAddon',\n          addonPath,\n        }, (installResponse) => {\n          if (installResponse.error) {\n            return reject(new WebExtError(\n              'installTemporaryAddon: Error: ' +\n              `${installResponse.error}: ${installResponse.message}`));\n          }\n          log.debug(\n            `installTemporaryAddon: ${JSON.stringify(installResponse)}`);\n          log.info(`Installed ${addonPath} as a temporary add-on`);\n          resolve(installResponse);\n        });\n      });\n    });\n  }\n\n  getInstalledAddon(addonId: string): Promise<FirefoxRDPAddonActor> {\n    return new Promise(\n      (resolve, reject) => {\n        this.client.request('listAddons', (error, response) => {\n          if (error) {\n            reject(new WebExtError(\n              `Remote Firefox: listAddons() error: ${error}`));\n          } else {\n            resolve(response.addons);\n          }\n        });\n      })\n      .then((addons) => {\n        for (const addon of addons) {\n          if (addon.id === addonId) {\n            return addon;\n          }\n        }\n        log.debug(\n          `Remote Firefox has these addons: ${addons.map((a) => a.id)}`);\n        throw new WebExtError(\n          'The remote Firefox does not have your extension installed');\n      });\n  }\n\n  async checkForAddonReloading(\n    addon: FirefoxRDPAddonActor\n  ): Promise<FirefoxRDPAddonActor> {\n    if (this.checkedForAddonReloading) {\n      // We only need to check once if reload() is supported.\n      return addon;\n    } else {\n      const response = await this.addonRequest(addon, 'requestTypes');\n\n      if (response.requestTypes.indexOf('reload') === -1) {\n        const supportedRequestTypes = JSON.stringify(response.requestTypes);\n        log.debug(\n          `Remote Firefox only supports: ${supportedRequestTypes}`);\n        throw new UsageError(\n          'This Firefox version does not support add-on reloading. ' +\n          'Re-run with --no-reload');\n      } else {\n        this.checkedForAddonReloading = true;\n        return addon;\n      }\n    }\n  }\n\n  async reloadAddon(addonId: string): Promise<void> {\n    const addon = await this.getInstalledAddon(addonId);\n    await this.checkForAddonReloading(addon);\n    await this.addonRequest(addon, 'reload');\n    process.stdout.write(\n      `\\rLast extension reload: ${(new Date()).toTimeString()}`);\n    log.debug('\\n');\n  }\n}\n\n\n// Connect types and implementation\n\nexport type ConnectOptions = {|\n  connectToFirefox: FirefoxConnectorFn,\n|};\n\nexport async function connect(\n  port: number = REMOTE_PORT,\n  {connectToFirefox = defaultFirefoxConnector}: ConnectOptions = {}\n): Promise<RemoteFirefox> {\n  log.debug(`Connecting to Firefox on port ${port}`);\n  const client = await connectToFirefox(port);\n  log.debug(`Connected to the remote Firefox debugger on port ${port}`);\n  return new RemoteFirefox(client);\n}\n\n\n// ConnectWithMaxRetries types and implementation\n\nexport type ConnectWithMaxRetriesParams = {|\n  maxRetries?: number,\n  retryInterval?: number,\n  port: number,\n|};\n\nexport type ConnectWithMaxRetriesDeps = {|\n  connectToFirefox: typeof connect,\n|};\n\nexport async function connectWithMaxRetries(\n  // A max of 250 will try connecting for 30 seconds.\n  {maxRetries = 250, retryInterval = 120, port}: ConnectWithMaxRetriesParams,\n  {connectToFirefox = connect}: ConnectWithMaxRetriesDeps = {}\n): Promise<RemoteFirefox> {\n  async function establishConnection() {\n    var lastError;\n\n    for (let retries = 0; retries <= maxRetries; retries++) {\n      try {\n        return await connectToFirefox(port);\n      } catch (error) {\n        if (isErrorWithCode('ECONNREFUSED', error)) {\n          // Wait for `retryInterval` ms.\n          await new Promise((resolve) => {\n            setTimeout(resolve, retryInterval);\n          });\n\n          lastError = error;\n          log.debug(\n            `Retrying Firefox (${retries}); connection error: ${error}`);\n        } else {\n          log.error(error.stack);\n          throw error;\n        }\n      }\n    }\n\n    log.debug('Connect to Firefox debugger: too many retries');\n    throw lastError;\n  }\n\n  log.debug('Connecting to the remote Firefox debugger');\n  return establishConnection();\n}\n","/* @flow */\nimport {main} from './program';\nimport cmd from './cmd';\nimport * as logger from './util/logger';\n\n// This only exposes util/logger so far.\n// Do we need anything else?\nconst util = {logger};\n\nexport default {main, cmd, util};\n","/* @flow */\nimport os from 'os';\nimport path from 'path';\nimport {readFileSync} from 'fs';\n\nimport camelCase from 'camelcase';\nimport git from 'git-rev-sync';\nimport yargs from 'yargs';\n\nimport defaultCommands from './cmd';\nimport {UsageError} from './errors';\nimport {createLogger, consoleStream as defaultLogStream} from './util/logger';\nimport {coerceCLICustomPreference} from './firefox/preferences';\nimport {checkForUpdates as defaultUpdateChecker} from './util/updates';\nimport {\n  discoverConfigFiles as defaultConfigDiscovery,\n  loadJSConfigFile as defaultLoadJSConfigFile,\n  applyConfigToArgv as defaultApplyConfigToArgv,\n} from './config';\n\nconst log = createLogger(__filename);\nconst envPrefix = 'WEB_EXT';\n\n\ntype ProgramOptions = {|\n  absolutePackageDir?: string,\n|}\n\nexport type VersionGetterFn = (absolutePackageDir: string) => string;\n\n// TODO: add pipes to Flow type after https://github.com/facebook/flow/issues/2405 is fixed\n\ntype ExecuteOptions = {\n  checkForUpdates?: Function,\n  systemProcess?: typeof process,\n  logStream?: typeof defaultLogStream,\n  getVersion?: VersionGetterFn,\n  applyConfigToArgv?: typeof defaultApplyConfigToArgv,\n  discoverConfigFiles?: typeof defaultConfigDiscovery,\n  loadJSConfigFile?: typeof defaultLoadJSConfigFile,\n  shouldExitProgram?: boolean,\n  globalEnv?: string,\n}\n\n\n/*\n * The command line program.\n */\nexport class Program {\n  absolutePackageDir: string;\n  yargs: any;\n  commands: { [key: string]: Function };\n  shouldExitProgram: boolean;\n  verboseEnabled: boolean;\n  options: Object;\n\n  constructor(\n    argv: ?Array<string>,\n    {\n      absolutePackageDir = process.cwd(),\n    }: ProgramOptions = {}\n  ) {\n    // This allows us to override the process argv which is useful for\n    // testing.\n    // NOTE: process.argv.slice(2) removes the path to node and web-ext\n    // executables from the process.argv array.\n    argv = argv || process.argv.slice(2);\n\n    // NOTE: always initialize yargs explicitly with the package dir\n    // to avoid side-effects due to yargs looking for its configuration\n    // section from a package.json file stored in an arbitrary directory\n    // (e.g. in tests yargs would end up loading yargs config from the\n    // mocha package.json). web-ext package.json doesn't contain any yargs\n    // section as it is deprecated and we configure yargs using\n    // yargs.parserConfiguration. See web-ext#469 for rationale.\n    const yargsInstance = yargs(argv, absolutePackageDir);\n\n    this.absolutePackageDir = absolutePackageDir;\n    this.verboseEnabled = false;\n    this.shouldExitProgram = true;\n    this.yargs = yargsInstance;\n\n    // The following yargs configuration option is needed to fix #304.\n    this.yargs.parserConfiguration({\n      'boolean-negation': false,\n    });\n\n    this.yargs.strict();\n\n    this.commands = {};\n    this.options = {};\n  }\n\n  command(\n    name: string, description: string, executor: Function,\n    commandOptions: Object = {}\n  ): Program {\n    this.options[camelCase(name)] = commandOptions;\n\n    this.yargs.command(name, description, (yargsForCmd) => {\n      if (!commandOptions) {\n        return;\n      }\n      return yargsForCmd\n        // Make sure the user does not add any extra commands. For example,\n        // this would be a mistake because lint does not accept arguments:\n        // web-ext lint ./src/path/to/file.js\n        .demandCommand(0, 0, undefined,\n                       'This command does not take any arguments')\n        .strict()\n        .exitProcess(this.shouldExitProgram)\n        // Calling env() will be unnecessary after\n        // https://github.com/yargs/yargs/issues/486 is fixed\n        .env(envPrefix)\n        .options(commandOptions);\n    });\n    this.commands[name] = executor;\n    return this;\n  }\n\n  setGlobalOptions(options: Object): Program {\n    // This is a convenience for setting global options.\n    // An option is only global (i.e. available to all sub commands)\n    // with the `global` flag so this makes sure every option has it.\n    this.options = {...this.options, ...options};\n    Object.keys(options).forEach((key) => {\n      options[key].global = true;\n      if (options[key].demandOption === undefined) {\n        // By default, all options should be \"demanded\" otherwise\n        // yargs.strict() will think they are missing when declared.\n        options[key].demandOption = true;\n      }\n    });\n    this.yargs.options(options);\n    return this;\n  }\n\n  enableVerboseMode(\n    logStream: typeof defaultLogStream,\n    version: string\n  ): void {\n    if (this.verboseEnabled) {\n      return;\n    }\n\n    logStream.makeVerbose();\n    log.info('Version:', version);\n    this.verboseEnabled = true;\n  }\n\n  async execute(\n    {\n      checkForUpdates = defaultUpdateChecker,\n      systemProcess = process,\n      logStream = defaultLogStream,\n      getVersion = defaultVersionGetter,\n      applyConfigToArgv = defaultApplyConfigToArgv,\n      discoverConfigFiles = defaultConfigDiscovery,\n      loadJSConfigFile = defaultLoadJSConfigFile,\n      shouldExitProgram = true,\n      globalEnv = WEBEXT_BUILD_ENV,\n    }: ExecuteOptions = {}\n  ): Promise<void> {\n    this.shouldExitProgram = shouldExitProgram;\n    this.yargs.exitProcess(this.shouldExitProgram);\n\n    const argv = this.yargs.argv;\n\n    const cmd = argv._[0];\n\n    const version = getVersion(this.absolutePackageDir);\n    const runCommand = this.commands[cmd];\n\n    if (argv.verbose) {\n      this.enableVerboseMode(logStream, version);\n    }\n\n    let adjustedArgv = {...argv};\n\n    try {\n      if (cmd === undefined) {\n        throw new UsageError('No sub-command was specified in the args');\n      }\n      if (!runCommand) {\n        throw new UsageError(`Unknown command: ${cmd}`);\n      }\n      if (globalEnv === 'production') {\n        checkForUpdates({version});\n      }\n\n      const configFiles = [];\n\n      // Because of an issue with yargs special handling for '--no-' option prefix (See #306)\n      // we need to look explicitly for the options  --config-discovery and --no-config-discovery\n      // (See #1307).\n      if (argv.configDiscovery && !argv.noConfigDiscovery) {\n        log.debug(\n          'Discovering config files. ' +\n          'Set --no-config-discovery to disable');\n        const discoveredConfigs = await discoverConfigFiles();\n        configFiles.push(...discoveredConfigs);\n      } else {\n        log.debug('Not discovering config files');\n      }\n\n      if (argv.config) {\n        configFiles.push(path.resolve(argv.config));\n      }\n\n      if (configFiles.length) {\n        const niceFileList = configFiles\n          .map((f) => f.replace(process.cwd(), '.'))\n          .map((f) => f.replace(os.homedir(), '~'))\n          .join(', ');\n        log.info(\n          'Applying config file' +\n          `${configFiles.length !== 1 ? 's' : ''}: ` +\n          `${niceFileList}`);\n      }\n\n      configFiles.forEach((configFileName) => {\n        const configObject = loadJSConfigFile(configFileName);\n        adjustedArgv = applyConfigToArgv({\n          argv: adjustedArgv,\n          argvFromCLI: argv,\n          configFileName,\n          configObject,\n          options: this.options,\n        });\n      });\n\n      if (adjustedArgv.verbose) {\n        // Ensure that the verbose is enabled when specified in a config file.\n        this.enableVerboseMode(logStream, version);\n      }\n\n      await runCommand(adjustedArgv, {shouldExitProgram});\n\n    } catch (error) {\n      if (!(error instanceof UsageError) || adjustedArgv.verbose) {\n        log.error(`\\n${error.stack}\\n`);\n      } else {\n        log.error(`\\n${error}\\n`);\n      }\n      if (error.code) {\n        log.error(`Error code: ${error.code}\\n`);\n      }\n\n      log.debug(`Command executed: ${cmd}`);\n\n      if (this.shouldExitProgram) {\n        systemProcess.exit(1);\n      } else {\n        throw error;\n      }\n    }\n  }\n}\n\n// A global variable generated by DefinePlugin, generated in webpack.config.js\ndeclare var WEBEXT_BUILD_ENV: string;\n\n//A defintion of type of argument for defaultVersionGetter\ntype VersionGetterOptions = {\n  globalEnv?: string,\n};\n\nexport function defaultVersionGetter(\n  absolutePackageDir: string,\n  {globalEnv = WEBEXT_BUILD_ENV}: VersionGetterOptions = {}\n): string {\n  if (globalEnv === 'production') {\n    log.debug('Getting the version from package.json');\n    const packageData: any = readFileSync(\n      path.join(absolutePackageDir, 'package.json'));\n    return JSON.parse(packageData).version;\n  } else {\n    log.debug('Getting version from the git revision');\n    return `${git.branch(absolutePackageDir)}-${git.long(absolutePackageDir)}`;\n  }\n}\n\n// TODO: add pipes to Flow type after https://github.com/facebook/flow/issues/2405 is fixed\n\ntype MainParams = {\n  getVersion?: VersionGetterFn,\n  commands?: Object,\n  argv: Array<any>,\n  runOptions?: Object,\n}\n\nexport function main(\n  absolutePackageDir: string,\n  {\n    getVersion = defaultVersionGetter, commands = defaultCommands, argv,\n    runOptions = {},\n  }: MainParams = {}\n): Promise<any> {\n  const program = new Program(argv, {absolutePackageDir});\n  const version = getVersion(absolutePackageDir);\n\n  // yargs uses magic camel case expansion to expose options on the\n  // final argv object. For example, the 'artifacts-dir' option is alternatively\n  // available as argv.artifactsDir.\n  program.yargs\n    .usage(`Usage: $0 [options] command\n\nOption values can also be set by declaring an environment variable prefixed\nwith $${envPrefix}_. For example: $${envPrefix}_SOURCE_DIR=/path is the same as\n--source-dir=/path.\n\nTo view specific help for any given command, add the command name.\nExample: $0 --help run.\n`)\n    .help('help')\n    .alias('h', 'help')\n    .env(envPrefix)\n    .version(version)\n    .demandCommand(1, 'You must specify a command')\n    .strict();\n\n  program.setGlobalOptions({\n    'source-dir': {\n      alias: 's',\n      describe: 'Web extension source directory.',\n      default: process.cwd(),\n      requiresArg: true,\n      type: 'string',\n      coerce: path.resolve,\n    },\n    'artifacts-dir': {\n      alias: 'a',\n      describe: 'Directory where artifacts will be saved.',\n      default: path.join(process.cwd(), 'web-ext-artifacts'),\n      normalize: true,\n      requiresArg: true,\n      type: 'string',\n    },\n    'verbose': {\n      alias: 'v',\n      describe: 'Show verbose output',\n      type: 'boolean',\n      demandOption: false,\n    },\n    'ignore-files': {\n      alias: 'i',\n      describe: 'A list of glob patterns to define which files should be ' +\n                'ignored. (Example: --ignore-files=path/to/first.js ' +\n                'path/to/second.js \"**/*.log\")',\n      demandOption: false,\n      requiresArg: true,\n      type: 'array',\n    },\n    'no-input': {\n      describe: 'Disable all features that require standard input',\n      type: 'boolean',\n      demandOption: false,\n    },\n    'config': {\n      alias: 'c',\n      describe: 'Path to a CommonJS config file to set ' +\n        'option defaults',\n      default: undefined,\n      demandOption: false,\n      requiresArg: true,\n      type: 'string',\n    },\n    'config-discovery': {\n      describe: 'Discover config files in home directory and ' +\n        'working directory. Disable with --no-config-discovery.',\n      demandOption: false,\n      default: true,\n      type: 'boolean',\n    },\n  });\n\n  program\n    .command(\n      'build',\n      'Create an extension package from source',\n      commands.build, {\n        'as-needed': {\n          describe: 'Watch for file changes and re-build as needed',\n          type: 'boolean',\n        },\n        'overwrite-dest': {\n          alias: 'o',\n          describe: 'Overwrite destination package if it exists.',\n          type: 'boolean',\n        },\n      })\n    .command(\n      'sign',\n      'Sign the extension so it can be installed in Firefox',\n      commands.sign, {\n        'api-key': {\n          describe: 'API key (JWT issuer) from addons.mozilla.org',\n          demandOption: true,\n          type: 'string',\n        },\n        'api-secret': {\n          describe: 'API secret (JWT secret) from addons.mozilla.org',\n          demandOption: true,\n          type: 'string',\n        },\n        'api-url-prefix': {\n          describe: 'Signing API URL prefix',\n          default: 'https://addons.mozilla.org/api/v3',\n          demandOption: true,\n          type: 'string',\n        },\n        'api-proxy': {\n          describe:\n            'Use a proxy to access the signing API. ' +\n            'Example: https://yourproxy:6000 ',\n          demandOption: false,\n          type: 'string',\n        },\n        'id': {\n          describe:\n            'A custom ID for the extension. This has no effect if the ' +\n            'extension already declares an explicit ID in its manifest.',\n          demandOption: false,\n          type: 'string',\n        },\n        'timeout': {\n          describe: 'Number of milliseconds to wait before giving up',\n          type: 'number',\n        },\n        'channel': {\n          describe: 'The channel for which to sign the addon. Either ' +\n          '\\'listed\\' or \\'unlisted\\'',\n          type: 'string',\n        },\n      })\n    .command('run', 'Run the extension', commands.run, {\n      'target': {\n        alias: 't',\n        describe: 'The extensions runners to enable (e.g. firefox-desktop, ' +\n                  'firefox-android). Specify this option multiple times to ' +\n                  'run against multiple targets.',\n        default: 'firefox-desktop',\n        demandOption: false,\n        type: 'array',\n      },\n      'firefox': {\n        alias: ['f', 'firefox-binary'],\n        describe: 'Path or alias to a Firefox executable such as firefox-bin ' +\n                  'or firefox.exe. ' +\n                  'If not specified, the default Firefox will be used. ' +\n                  'You can specify the following aliases in lieu of a path: ' +\n                  'firefox, beta, nightly, firefoxdeveloperedition.',\n        demandOption: false,\n        type: 'string',\n      },\n      'firefox-profile': {\n        alias: 'p',\n        describe: 'Run Firefox using a copy of this profile. The profile ' +\n                  'can be specified as a directory or a name, such as one ' +\n                  'you would see in the Profile Manager. If not specified, ' +\n                  'a new temporary profile will be created.',\n        demandOption: false,\n        type: 'string',\n      },\n      'keep-profile-changes': {\n        describe: 'Run Firefox directly in custom profile. Any changes to ' +\n                  'the profile will be saved.',\n        demandOption: false,\n        type: 'boolean',\n      },\n      'no-reload': {\n        describe: 'Do not reload the extension when source files change',\n        demandOption: false,\n        type: 'boolean',\n      },\n      'pre-install': {\n        describe: 'Pre-install the extension into the profile before ' +\n                  'startup. This is only needed to support older versions ' +\n                  'of Firefox.',\n        demandOption: false,\n        type: 'boolean',\n      },\n      'pref': {\n        describe: 'Launch firefox with a custom preference ' +\n                  '(example: --pref=general.useragent.locale=fr-FR). ' +\n                  'You can repeat this option to set more than one ' +\n                  'preference.',\n        demandOption: false,\n        requiresArg: true,\n        type: 'array',\n        coerce: coerceCLICustomPreference,\n      },\n      'start-url': {\n        alias: ['u', 'url'],\n        describe: 'Launch firefox at specified page',\n        demandOption: false,\n        requiresArg: true,\n        type: 'array',\n      },\n      'browser-console': {\n        alias: ['bc'],\n        describe: 'Open the DevTools Browser Console.',\n        demandOption: false,\n        type: 'boolean',\n      },\n      'args': {\n        alias: ['arg'],\n        describe: 'Additional CLI options passed to the Browser binary',\n        demandOption: false,\n        type: 'array',\n      },\n      // Firefox for Android CLI options.\n      'adb-bin': {\n        describe: 'Specify a custom path to the adb binary',\n        demandOption: false,\n        type: 'string',\n        requiresArg: true,\n      },\n      'adb-host': {\n        describe: 'Connect to adb on the specified host',\n        demandOption: false,\n        type: 'string',\n        requiresArg: true,\n      },\n      'adb-port': {\n        describe: 'Connect to adb on the specified port',\n        demandOption: false,\n        type: 'string',\n        requiresArg: true,\n      },\n      'adb-device': {\n        alias: ['android-device'],\n        describe: 'Connect to the specified adb device name',\n        demandOption: false,\n        type: 'string',\n        requiresArg: true,\n      },\n      'firefox-apk': {\n        describe: (\n          'Run a specific Firefox for Android APK. ' +\n          'Example: org.mozilla.fennec_aurora'\n        ),\n        demandOption: false,\n        type: 'string',\n        requiresArg: true,\n      },\n    })\n    .command('lint', 'Validate the extension source', commands.lint, {\n      'output': {\n        alias: 'o',\n        describe: 'The type of output to generate',\n        type: 'string',\n        default: 'text',\n        choices: ['json', 'text'],\n      },\n      'metadata': {\n        describe: 'Output only metadata as JSON',\n        type: 'boolean',\n        default: false,\n      },\n      'warnings-as-errors': {\n        describe: 'Treat warnings as errors by exiting non-zero for warnings',\n        alias: 'w',\n        type: 'boolean',\n        default: false,\n      },\n      'pretty': {\n        describe: 'Prettify JSON output',\n        type: 'boolean',\n        default: false,\n      },\n      'self-hosted': {\n        describe:\n          'Your extension will be self-hosted. This disables messages ' +\n          'related to hosting on addons.mozilla.org.',\n        type: 'boolean',\n        default: false,\n      },\n      'boring': {\n        describe: 'Disables colorful shell output',\n        type: 'boolean',\n        default: false,\n      },\n    })\n    .command('docs', 'Open the web-ext documentation in a browser',\n             commands.docs, {});\n\n  return program.execute({getVersion, ...runOptions});\n}\n","/* @flow */\nimport defaultADB from 'adbkit';\n\nimport {\n  isErrorWithCode,\n  UsageError,\n  WebExtError,\n} from '../errors';\nimport {createLogger} from '../util/logger';\n\nconst log = createLogger(__filename);\n\nexport type ADBUtilsParams = {|\n  adb?: typeof defaultADB,\n  // ADB configs.\n  adbBin?: string,\n  adbHost?: string,\n  adbPort?: string,\n  adbDevice?: string,\n|};\n\nexport type DiscoveryParams = {|\n  maxDiscoveryTime: number,\n  retryInterval: number,\n|};\n\n// Helper function used to raise an UsageError when the adb binary has not been found.\nasync function wrapADBCall(asyncFn: (...any) => Promise<any>): Promise<any> {\n  try {\n    return await asyncFn();\n  } catch (error) {\n    if (isErrorWithCode('ENOENT', error) &&\n        error.message.includes('spawn adb')) {\n      throw new UsageError(\n        'No adb executable has been found. ' +\n          'You can Use --adb-bin, --adb-host/--adb-port ' +\n          'to configure it manually if needed.');\n    }\n\n    throw error;\n  }\n}\n\nexport default class ADBUtils {\n  params: ADBUtilsParams;\n  adb: typeof defaultADB;\n  adbClient: any; // TODO: better flow typing here.\n\n  // Map<deviceId -> artifactsDir>\n  artifactsDirMap: Map<string, string>;\n  // Toggled when the user wants to abort the RDP Unix Socket discovery loop\n  // while it is still executing.\n  userAbortDiscovery: boolean;\n\n  constructor(params: ADBUtilsParams) {\n    this.params = params;\n\n    const {\n      adb,\n      adbBin,\n      adbHost,\n      adbPort,\n    } = params;\n\n    this.adb = adb || defaultADB;\n\n    this.adbClient = this.adb.createClient({\n      bin: adbBin,\n      host: adbHost,\n      port: adbPort,\n    });\n\n    this.artifactsDirMap = new Map();\n\n    this.userAbortDiscovery = false;\n  }\n\n  runShellCommand(\n    deviceId: string, cmd: string | Array<string>\n  ): Promise<string> {\n    const {adb, adbClient} = this;\n\n    log.debug(`Run adb shell command on ${deviceId}: ${JSON.stringify(cmd)}`);\n\n    return wrapADBCall(async () => {\n      return await adbClient.shell(deviceId, cmd).then(adb.util.readAll);\n    }).then((res) => res.toString());\n  }\n\n  async discoverDevices(): Promise<Array<string>> {\n    const {adbClient} = this;\n\n    let devices = [];\n\n    log.debug('Listing android devices');\n    devices = await wrapADBCall(async () => adbClient.listDevices());\n\n    return devices.map((dev) => dev.id);\n  }\n\n  async discoverInstalledFirefoxAPKs(\n    deviceId: string,\n    firefoxApk?: string\n  ): Promise<Array<string>> {\n    log.debug(`Listing installed Firefox APKs on ${deviceId}`);\n\n    const pmList = await this.runShellCommand(deviceId, [\n      'pm', 'list', 'packages',\n    ]);\n\n    return pmList.split('\\n')\n      .map((line) => line.replace('package:', '').trim())\n      .filter((line) => {\n        // Look for an exact match if firefoxApk is defined.\n        if (firefoxApk) {\n          return line === firefoxApk;\n        }\n        // Match any package name that starts with the package name of a Firefox for Android browser.\n        return (\n          line.startsWith('org.mozilla.fennec') ||\n            line.startsWith('org.mozilla.firefox')\n        );\n      });\n  }\n\n  async getAndroidVersionNumber(deviceId: string): Promise<number> {\n    const androidVersion = (await this.runShellCommand(deviceId, [\n      'getprop', 'ro.build.version.sdk',\n    ])).trim();\n\n    const androidVersionNumber = parseInt(androidVersion);\n\n    // No need to check the granted runtime permissions on Android versions < Lollypop.\n    if (isNaN(androidVersionNumber)) {\n      throw new WebExtError(\n        'Unable to discovery android version on ' +\n        `${deviceId}: ${androidVersion}`\n      );\n    }\n\n    return androidVersionNumber;\n  }\n\n  // Raise an UsageError when the given APK does not have the required runtime permissions.\n  async ensureRequiredAPKRuntimePermissions(\n    deviceId: string, apk: string, permissions: Array<string>\n  ): Promise<void> {\n    const permissionsMap = {};\n\n    // Initialize every permission to false in the permissions map.\n    for (const perm of permissions) {\n      permissionsMap[perm] = false;\n    }\n\n    // Retrieve the permissions information for the given apk.\n    const pmDumpLogs = (await this.runShellCommand(deviceId, [\n      'pm', 'dump', apk,\n    ])).split('\\n');\n\n    // Set to true the required permissions that have been granted.\n    for (const line of pmDumpLogs) {\n      for (const perm of permissions) {\n        if (line.includes(`${perm}: granted=true`)) {\n          permissionsMap[perm] = true;\n        }\n      }\n    }\n\n    for (const perm of permissions) {\n      if (!permissionsMap[perm]) {\n        throw new UsageError(\n          `Required ${perm} has not be granted for ${apk}. ` +\n          'Please grant them using the Android Settings ' +\n          'or using the following adb command:\\n' +\n          `\\t adb shell pm grant ${apk} ${perm}\\n`\n        );\n      }\n    }\n  }\n\n  async amForceStopAPK(deviceId: string, apk: string): Promise<void> {\n    await this.runShellCommand(deviceId, [\n      'am', 'force-stop', apk,\n    ]);\n  }\n\n  async getOrCreateArtifactsDir(deviceId: string): Promise<string> {\n    let artifactsDir = this.artifactsDirMap.get(deviceId);\n\n    if (artifactsDir) {\n      return artifactsDir;\n    }\n\n    artifactsDir = `/sdcard/web-ext-artifacts-${Date.now()}`;\n\n    const testDirOut = (await this.runShellCommand(\n      deviceId, `test -d ${artifactsDir} ; echo $?`\n    )).trim();\n\n    if (testDirOut !== '1') {\n      throw new WebExtError(\n        `Cannot create artifacts directory ${artifactsDir} ` +\n        `because it exists on ${deviceId}.`\n      );\n    }\n\n    await this.runShellCommand(deviceId, ['mkdir', '-p', artifactsDir]);\n\n    this.artifactsDirMap.set(deviceId, artifactsDir);\n\n    return artifactsDir;\n  }\n\n  async clearArtifactsDir(deviceId: string): Promise<void> {\n    const artifactsDir = this.artifactsDirMap.get(deviceId);\n\n    if (!artifactsDir) {\n      // nothing to do here.\n      return;\n    }\n\n    this.artifactsDirMap.delete(deviceId);\n\n    log.debug(\n      `Removing ${artifactsDir} artifacts directory on ${deviceId} device`\n    );\n\n    await this.runShellCommand(deviceId, [\n      'rm', '-rf', artifactsDir,\n    ]);\n  }\n\n  async pushFile(\n    deviceId: string, localPath: string, devicePath: string\n  ): Promise<void> {\n    const {adbClient} = this;\n\n    log.debug(`Pushing ${localPath} to ${devicePath} on ${deviceId}`);\n\n    await wrapADBCall(async () => {\n      await adbClient.push(deviceId, localPath, devicePath)\n        .then(function(transfer) {\n          return new Promise((resolve) => {\n            transfer.on('end', resolve);\n          });\n        });\n    });\n  }\n\n  async startFirefoxAPK(\n    deviceId: string, apk: string, deviceProfileDir: string\n  ): Promise<void> {\n    const {adbClient} = this;\n\n    log.debug(\n      `Starting ${apk} with profile ${deviceProfileDir} on ${deviceId}`\n    );\n\n    await wrapADBCall(async () => {\n      await adbClient.startActivity(deviceId, {\n        wait: true,\n        action: 'android.activity.MAIN',\n        component: `${apk}/.App`,\n        extras: [\n          {\n            key: 'args',\n            value: `-profile ${deviceProfileDir}`,\n          },\n        ],\n      });\n    });\n  }\n\n  setUserAbortDiscovery(value: boolean) {\n    this.userAbortDiscovery = value;\n  }\n\n  async discoverRDPUnixSocket(\n    deviceId: string, apk: string,\n    {maxDiscoveryTime, retryInterval}: DiscoveryParams = {}\n  ): Promise<string> {\n    let rdpUnixSockets = [];\n\n    const discoveryStartedAt = Date.now();\n\n    while (rdpUnixSockets.length === 0) {\n      if (this.userAbortDiscovery) {\n        throw new UsageError(\n          'Exiting Firefox Remote Debugging socket discovery on user request'\n        );\n      }\n\n      if (Date.now() - discoveryStartedAt > maxDiscoveryTime) {\n        throw new WebExtError(\n          'Timeout while waiting for the Android Firefox Debugger Socket'\n        );\n      }\n\n      rdpUnixSockets = (await this.runShellCommand(deviceId, [\n        'cat', '/proc/net/unix',\n      ])).split('\\n').filter((line) => {\n        // The RDP unix socket is expected to be a path in the form:\n        //   /data/data/org.mozilla.fennec_rpl/firefox-debugger-socket\n        return line.trim().endsWith(`${apk}/firefox-debugger-socket`);\n      });\n\n      if (rdpUnixSockets.length === 0) {\n        await new Promise((resolve) => setTimeout(resolve, retryInterval));\n      }\n    }\n\n    // Convert into an array of unix socket filenames.\n    rdpUnixSockets = rdpUnixSockets.map((line) => {\n      return line.trim().split(/\\s/).pop();\n    });\n\n    if (rdpUnixSockets.length > 1) {\n      throw new WebExtError(\n        'Unexpected multiple RDP sockets: ' +\n        `${JSON.stringify(rdpUnixSockets)}`\n      );\n    }\n\n    return rdpUnixSockets[0];\n  }\n\n  async setupForward(deviceId: string, remote: string, local: string) {\n    const {adbClient} = this;\n\n    // TODO(rpl): we should use adb.listForwards and reuse the existing one if any (especially\n    // because adbkit doesn't seem to support `adb forward --remote` yet).\n    log.debug(`Configuring ADB forward for ${deviceId}: ${remote} -> ${local}`);\n\n    await wrapADBCall(async () => {\n      await adbClient.forward(deviceId, local, remote);\n    });\n  }\n}\n","/* @flow */\nimport {promisify} from 'util';\n\nimport {fs} from 'mz';\nimport mkdirp from 'mkdirp';\n\nimport {UsageError, isErrorWithCode} from '../errors';\nimport {createLogger} from './logger';\n\nconst log = createLogger(__filename);\n\nconst defaultAsyncMkdirp = promisify(mkdirp);\nconst defaultAsyncFsAccess = fs.access.bind(fs);\n\ntype PrepareArtifactsDirOptions = {\n  asyncMkdirp?: typeof defaultAsyncMkdirp,\n  asyncFsAccess?: typeof defaultAsyncFsAccess,\n}\n\nexport async function prepareArtifactsDir(\n  artifactsDir: string,\n  {\n    asyncMkdirp = defaultAsyncMkdirp,\n    asyncFsAccess = defaultAsyncFsAccess,\n  }: PrepareArtifactsDirOptions = {},\n): Promise<string> {\n  try {\n    const stats = await fs.stat(artifactsDir);\n    if (!stats.isDirectory()) {\n      throw new UsageError(\n        `--artifacts-dir=\"${artifactsDir}\" exists but it is not a directory.`);\n    }\n    // If the artifactsDir already exists, check that we have the write permissions on it.\n    try {\n      await asyncFsAccess(artifactsDir, fs.W_OK);\n    } catch (accessErr) {\n      if (isErrorWithCode('EACCES', accessErr)) {\n        throw new UsageError(\n          `--artifacts-dir=\"${artifactsDir}\" exists but the user lacks ` +\n          'permissions on it.');\n      } else {\n        throw accessErr;\n      }\n    }\n  } catch (error) {\n    if (isErrorWithCode('EACCES', error)) {\n      // Handle errors when the artifactsDir cannot be accessed.\n      throw new UsageError(\n        `Cannot access --artifacts-dir=\"${artifactsDir}\" because the user ` +\n        `lacks permissions: ${error}`);\n    } else if (isErrorWithCode('ENOENT', error)) {\n      // Create the artifact dir if it doesn't exist yet.\n      try {\n        log.debug(`Creating artifacts directory: ${artifactsDir}`);\n        await asyncMkdirp(artifactsDir);\n      } catch (mkdirErr) {\n        if (isErrorWithCode('EACCES', mkdirErr)) {\n          // Handle errors when the artifactsDir cannot be created for lack of permissions.\n          throw new UsageError(\n            `Cannot create --artifacts-dir=\"${artifactsDir}\" because the ` +\n            `user lacks permissions: ${mkdirErr}`);\n        } else {\n          throw mkdirErr;\n        }\n      }\n    } else {\n      throw error;\n    }\n  }\n\n  return artifactsDir;\n}\n","/* @flow */\nimport defaultNotifier from 'node-notifier';\n\nimport {createLogger} from './logger';\nimport type {Logger} from './logger';\n\nconst defaultLog = createLogger(__filename);\n\nexport type DesktopNotificationsParams = {|\n  title: string,\n  message: string,\n  icon?: string,\n|};\n\nexport type DesktopNotificationsOptions = {|\n  notifier?: typeof defaultNotifier,\n  log?: Logger,\n|};\n\nexport function showDesktopNotification(\n  {\n    title, message, icon,\n  }: DesktopNotificationsParams,\n  {\n    notifier = defaultNotifier,\n    log = defaultLog,\n  }: DesktopNotificationsOptions = {}\n): Promise<void> {\n\n  return new Promise((resolve, reject) => {\n    notifier.notify({title, message, icon}, (err, res) => {\n      if (err) {\n        log.debug(`Desktop notifier error: ${err.message},` +\n                 ` response: ${res}`);\n        reject(err);\n      } else {\n        resolve();\n      }\n    });\n  });\n}\n","/* @flow */\nimport {fs} from 'mz';\n\nimport {isErrorWithCode} from '../errors';\n\ntype FileExistsOptions = {|\n  fileIsReadable: (filePath: string) => Promise<boolean>,\n|};\n\n/*\n * Resolves true if the path is a readable file.\n *\n * Usage:\n *\n * const exists = await fileExists(filePath);\n * if (exists) {\n *   // ...\n * }\n *\n * */\nexport default async function fileExists(\n  path: string,\n  {\n    fileIsReadable = (f) => fs.access(f, fs.constants.R_OK),\n  }: FileExistsOptions = {}\n): Promise<boolean> {\n  try {\n    await fileIsReadable(path);\n    const stat = await fs.stat(path);\n    return stat.isFile();\n  } catch (error) {\n    if (isErrorWithCode(['EACCES', 'ENOENT'], error)) {\n      return false;\n    }\n    throw error;\n  }\n}\n","/* @flow */\nimport path from 'path';\n\nimport multimatch from 'multimatch';\n\nimport {createLogger} from './logger';\n\nconst log = createLogger(__filename);\n\n// check if target is a sub directory of src\nexport const isSubPath = (src: string, target: string): boolean => {\n  const relate = path.relative(src, target);\n  // same dir\n  if (!relate) {\n    return false;\n  }\n  if (relate === '..') {\n    return false;\n  }\n  return !relate.startsWith(`..${path.sep}`);\n};\n\n// FileFilter types and implementation.\n\nexport type FileFilterOptions = {|\n  baseIgnoredPatterns?: Array<string>,\n  ignoreFiles?: Array<string>,\n  sourceDir: string,\n  artifactsDir?: string,\n|};\n\n/*\n * Allows or ignores files.\n */\nexport class FileFilter {\n  filesToIgnore: Array<string>;\n  sourceDir: string;\n\n  constructor({\n    baseIgnoredPatterns = [\n      '**/*.xpi',\n      '**/*.zip',\n      '**/.*', // any hidden file and folder\n      '**/.*/**/*', // and the content inside hidden folder\n      '**/node_modules',\n      '**/node_modules/**/*',\n    ],\n    ignoreFiles = [],\n    sourceDir,\n    artifactsDir,\n  }: FileFilterOptions = {}) {\n    sourceDir = path.resolve(sourceDir);\n\n    this.filesToIgnore = [];\n    this.sourceDir = sourceDir;\n\n    this.addToIgnoreList(baseIgnoredPatterns);\n    if (ignoreFiles) {\n      this.addToIgnoreList(ignoreFiles);\n    }\n    if (artifactsDir && isSubPath(sourceDir, artifactsDir)) {\n      artifactsDir = path.resolve(artifactsDir);\n      log.debug(\n        `Ignoring artifacts directory \"${artifactsDir}\" ` +\n        'and all its subdirectories'\n      );\n      this.addToIgnoreList([\n        artifactsDir,\n        path.join(artifactsDir, '**', '*'),\n      ]);\n    }\n  }\n\n  /**\n   *  Resolve relative path to absolute path with sourceDir.\n   */\n  resolveWithSourceDir(file: string): string {\n    const resolvedPath = path.resolve(this.sourceDir, file);\n    log.debug(\n      `Resolved path ${file} with sourceDir ${this.sourceDir} ` +\n      `to ${resolvedPath}`\n    );\n    return resolvedPath;\n  }\n\n  /**\n   *  Insert more files into filesToIgnore array.\n   */\n  addToIgnoreList(files: Array<string>) {\n    for (const file of files) {\n      if (file.charAt(0) === '!') {\n        const resolvedFile = this.resolveWithSourceDir(file.substr(1));\n        this.filesToIgnore.push(`!${resolvedFile}`);\n      } else {\n        this.filesToIgnore.push(this.resolveWithSourceDir(file));\n      }\n    }\n  }\n\n  /*\n   * Returns true if the file is wanted.\n   *\n   * If filePath does not start with a slash, it will be treated as a path\n   * relative to sourceDir when matching it against all configured\n   * ignore-patterns.\n   *\n   * Example: this is called by zipdir as wantFile(filePath) for each\n   * file in the folder that is being archived.\n   */\n  wantFile(filePath: string): boolean {\n    const resolvedPath = this.resolveWithSourceDir(filePath);\n    const matches = multimatch(resolvedPath, this.filesToIgnore);\n    if (matches.length > 0) {\n      log.debug(`FileFilter: ignoring file ${resolvedPath}`);\n      return false;\n    }\n    return true;\n  }\n}\n\n// a helper function to make mocking easier\n\nexport const createFileFilter = (\n  (params: FileFilterOptions): FileFilter => new FileFilter(params)\n);\n\nexport type FileFilterCreatorFn = typeof createFileFilter;\n","/* @flow */\nimport {fs} from 'mz';\n\nimport {onlyErrorsWithCode} from '../errors';\n\n/*\n * Resolves true if the path is a readable directory.\n *\n * Usage:\n *\n * isDirectory('/some/path')\n *  .then((dirExists) => {\n *    // dirExists will be true or false.\n *  });\n *\n * */\nexport default function isDirectory(path: string): Promise<boolean> {\n  return fs.stat(path)\n    .then((stats) => stats.isDirectory())\n    .catch(onlyErrorsWithCode(['ENOENT', 'ENOTDIR'], () => {\n      return false;\n    }));\n}\n","/* @flow */\nimport bunyan, {nameFromLevel, createLogger as defaultLogCreator}\n  from 'bunyan';\n\n\n// Bunyan-related Flow types\n\nexport type TRACE = 10;\nexport type DEBUG = 20;\nexport type INFO = 30;\nexport type WARN = 40;\nexport type ERROR = 50;\nexport type FATAL = 60;\n\nexport type BunyanLogLevel =\n  TRACE | DEBUG | INFO | WARN | ERROR | FATAL;\n\nexport type BunyanLogEntry = {|\n  name: string,\n  msg: string,\n  level: BunyanLogLevel,\n|};\n\nexport type Logger = {\n  debug: (msg: string, ...args: any) => void,\n  error: (msg: string, ...args: any) => void,\n  info: (msg: string, ...args: any) => void,\n  warn: (msg: string, ...args: any) => void,\n};\n\n\n// ConsoleStream types and implementation.\n\nexport type ConsoleStreamParams = {|\n  verbose?: boolean,\n|};\n\nexport type ConsoleOptions = {|\n  localProcess?: typeof process,\n|};\n\nexport class ConsoleStream {\n  verbose: boolean;\n  isCapturing: boolean;\n  capturedMessages: Array<string>;\n\n  constructor({verbose = false}: ConsoleStreamParams = {}) {\n    this.verbose = verbose;\n    this.isCapturing = false;\n    this.capturedMessages = [];\n  }\n\n  format({name, msg, level}: BunyanLogEntry): string {\n    const prefix = this.verbose ? `[${name}][${nameFromLevel[level]}] ` : '';\n    return `${prefix}${msg}\\n`;\n  }\n\n  makeVerbose() {\n    this.verbose = true;\n  }\n\n  write(\n    packet: BunyanLogEntry,\n    {localProcess = process}: ConsoleOptions = {}\n  ): void {\n    const thisLevel: BunyanLogLevel = this.verbose ? bunyan.TRACE : bunyan.INFO;\n    if (packet.level >= thisLevel) {\n      const msg = this.format(packet);\n      if (this.isCapturing) {\n        this.capturedMessages.push(msg);\n      } else {\n        localProcess.stdout.write(msg);\n      }\n    }\n  }\n\n  startCapturing() {\n    this.isCapturing = true;\n  }\n\n  stopCapturing() {\n    this.isCapturing = false;\n    this.capturedMessages = [];\n  }\n\n  flushCapturedLogs({localProcess = process}: ConsoleOptions = {}) {\n    for (const msg of this.capturedMessages) {\n      localProcess.stdout.write(msg);\n    }\n    this.capturedMessages = [];\n  }\n}\n\nexport const consoleStream = new ConsoleStream();\n\n\n// createLogger types and implementation.\n\nexport type BunyanStreamConfig = {|\n  type: string,\n  stream: ConsoleStream,\n|};\n\nexport type CreateBunyanLogParams = {|\n  name: string,\n  level: BunyanLogLevel,\n  streams: Array<BunyanStreamConfig>,\n|};\n\nexport type CreateBunyanLogFn = (params: CreateBunyanLogParams) => Logger;\n\nexport type CreateLoggerOptions = {|\n  createBunyanLog: CreateBunyanLogFn,\n|};\n\nexport function createLogger(\n  filename: string,\n  {createBunyanLog = defaultLogCreator}: CreateLoggerOptions = {}\n): Logger {\n  return createBunyanLog({\n    // Strip the leading src/ from file names (which is in all file names) to\n    // make the name less redundant.\n    name: filename.replace(/^src\\//, ''),\n    // Capture all log levels and let the stream filter them.\n    level: bunyan.TRACE,\n    streams: [{\n      type: 'raw',\n      stream: consoleStream,\n    }],\n  });\n}\n","/* @flow */\nimport path from 'path';\n\nimport {fs} from 'mz';\nimport parseJSON from 'parse-json';\nimport stripJsonComments from 'strip-json-comments';\n\nimport {InvalidManifest} from '../errors';\nimport {createLogger} from './logger';\n\nconst log = createLogger(__filename);\n\n\n// getValidatedManifest helper types and implementation\n\nexport type ExtensionManifestApplications = {|\n  gecko: {|\n    id?: string,\n    strict_min_version?: string,\n    strict_max_version?: string,\n    update_url?: string,\n  |},\n|};\n\nexport type ExtensionManifest = {|\n  name: string,\n  version: string,\n  default_locale?: string,\n  applications?: ExtensionManifestApplications,\n|};\n\nexport default async function getValidatedManifest(\n  sourceDir: string\n): Promise<ExtensionManifest> {\n  const manifestFile = path.join(sourceDir, 'manifest.json');\n  log.debug(`Validating manifest at ${manifestFile}`);\n\n  let manifestContents;\n\n  try {\n    manifestContents = await fs.readFile(manifestFile, {encoding: 'utf-8'});\n  } catch (error) {\n    throw new InvalidManifest(\n      `Could not read manifest.json file at ${manifestFile}: ${error}`);\n  }\n\n  let manifestData;\n\n  try {\n    manifestData = parseJSON(stripJsonComments(manifestContents), manifestFile);\n  } catch (error) {\n    throw new InvalidManifest(\n      `Error parsing manifest.json at ${manifestFile}: ${error}`);\n  }\n\n  const errors = [];\n  // This is just some basic validation of what web-ext needs, not\n  // what Firefox will need to run the extension.\n  // TODO: integrate with the addons-linter for actual validation.\n  if (!manifestData.name) {\n    errors.push('missing \"name\" property');\n  }\n  if (!manifestData.version) {\n    errors.push('missing \"version\" property');\n  }\n\n  if (manifestData.applications && !manifestData.applications.gecko) {\n    // Since the applications property only applies to gecko, make\n    // sure 'gecko' exists when 'applications' is defined. This should\n    // make introspection of gecko properties easier.\n    errors.push('missing \"applications.gecko\" property');\n  }\n\n  if (errors.length) {\n    throw new InvalidManifest(\n      `Manifest at ${manifestFile} is invalid: ${errors.join('; ')}`);\n  }\n\n  return manifestData;\n}\n\n\nexport function getManifestId(manifestData: ExtensionManifest): string | void {\n  return manifestData.applications ?\n    manifestData.applications.gecko.id : undefined;\n}\n","/* @flow */\n\n/*\n * A small promisify helper to make it easier to customize a\n * function promisified (using the 'util' module available in\n * nodejs >= 8) to resolve to an array of results:\n *\n *    import {promisify} from 'util';\n *    import {multiArgsPromisedFn} from '../util/promisify';\n *\n *    aCallbackBasedFn[promisify.custom] = multiArgsPromisedFn(tmp.dir);\n *    ...\n */\nexport function multiArgsPromisedFn(fn: Function): Function {\n  return (...callerArgs: Array<any>): Promise<any> => {\n    return new Promise((resolve, reject) => {\n      fn(...callerArgs, (err, ...rest) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(rest);\n        }\n      });\n    });\n  };\n}\n","/* @flow */\n\nimport type {Readable} from 'stream';\n\nexport function isTTY(stream: Readable): boolean {\n  // $FLOW_FIXME: flow complains that stream may not provide isTTY as a property.\n  return stream.isTTY;\n}\n\nexport function setRawMode(stream: Readable, rawMode: boolean) {\n  // $FLOW_FIXME: flow complains that stdin may not provide setRawMode.\n  stream.setRawMode(rawMode);\n}\n","/* @flow */\nimport {promisify} from 'util';\n\nimport tmp from 'tmp';\n\nimport {createLogger} from './logger';\nimport {multiArgsPromisedFn} from './promisify';\n\nconst log = createLogger(__filename);\n\nexport type MakePromiseCallback = (tmpDir: TempDir) => any;\n\ntmp.dir[promisify.custom] = multiArgsPromisedFn(tmp.dir);\n\nconst createTempDir = promisify(tmp.dir);\n\n/*\n * Work with a self-destructing temporary directory in a promise chain.\n *\n * The directory will be destroyed when the promise chain is finished\n * (whether there was an error or not).\n *\n * Usage:\n *\n * withTempDir(\n *   (tmpDir) =>\n *     doSomething(tmpDir.path())\n *     .then(...)\n * );\n *\n */\nexport function withTempDir(makePromise: MakePromiseCallback): Promise<any> {\n  const tmpDir = new TempDir();\n  return tmpDir.create()\n    .then(() => {\n      return makePromise(tmpDir);\n    })\n    .catch(tmpDir.errorHandler())\n    .then(tmpDir.successHandler());\n}\n\n/*\n * Work with a self-destructing temporary directory object.\n *\n * It is safer to use withTempDir() instead but if you know\n * what you're doing you can use it directly like:\n *\n * let tmpDir = new TempDir();\n * tmpDir.create()\n *   .then(() => {\n *     // work with tmpDir.path()\n *   })\n *   .catch(tmpDir.errorHandler())\n *   .then(tmpDir.successHandler());\n *\n */\nexport class TempDir {\n  _path: string | void;\n  _removeTempDir: Function | void;\n\n  constructor() {\n    this._path = undefined;\n    this._removeTempDir = undefined;\n  }\n\n  /*\n   * Returns a promise that is fulfilled when the temp directory has\n   * been created.\n   */\n  create(): Promise<TempDir> {\n    return createTempDir(\n      {\n        prefix: 'tmp-web-ext-',\n        // This allows us to remove a non-empty tmp dir.\n        unsafeCleanup: true,\n      })\n      .then(([tmpPath, removeTempDir]) => {\n        this._path = tmpPath;\n        this._removeTempDir = removeTempDir;\n        log.debug(`Created temporary directory: ${this.path()}`);\n        return this;\n      });\n  }\n\n  /*\n   * Get the absolute path of the temp directory.\n   */\n  path(): string {\n    if (!this._path) {\n      throw new Error('You cannot access path() before calling create()');\n    }\n    return this._path;\n  }\n\n  /*\n   * Returns a callback that will catch an error, remove\n   * the temporary directory, and throw the error.\n   *\n   * This is intended for use in a promise like\n   * Promise().catch(tmp.errorHandler())\n   */\n  errorHandler(): Function {\n    return (error) => {\n      this.remove();\n      throw error;\n    };\n  }\n\n  /*\n   * Returns a callback that will remove the temporary direcotry.\n   *\n   * This is intended for use in a promise like\n   * Promise().then(tmp.successHandler())\n   */\n  successHandler(): Function {\n    return (promiseResult) => {\n      this.remove();\n      return promiseResult;\n    };\n  }\n\n  /*\n   * Remove the temp directory.\n   */\n  remove() {\n    if (!this._removeTempDir) {\n      return;\n    }\n    log.debug(`Removing temporary directory: ${this.path()}`);\n    this._removeTempDir && this._removeTempDir();\n  }\n\n}\n","/* @flow */\nimport defaultUpdateNotifier from 'update-notifier';\n\ntype CheckForUpdatesParams = {|\n  version: string,\n  updateNotifier?: typeof defaultUpdateNotifier,\n|};\n\nexport function checkForUpdates(\n  {\n    version,\n    updateNotifier = defaultUpdateNotifier,\n  }: CheckForUpdatesParams\n) {\n  const pkg = {name: 'web-ext', version};\n\n  updateNotifier({\n    pkg,\n    updateCheckInterval: 1000 * 60 * 60 * 24 * 3, // 3 days,\n  }).notify();\n}\n","/* @flow */\nimport {promisify} from 'util';\n\nimport zipDirModule from 'zip-dir';\n\nexport const zipDir = promisify(zipDirModule);\n","/* @flow */\nimport Watchpack from 'watchpack';\nimport debounce from 'debounce';\n\nimport {createLogger} from './util/logger';\n\n\nconst log = createLogger(__filename);\n\n\n// onSourceChange types and implementation\n\nexport type ShouldWatchFn = (filePath: string) => boolean;\n\nexport type OnChangeFn = () => any;\n\nexport type OnSourceChangeParams = {|\n  sourceDir: string,\n  artifactsDir: string,\n  onChange: OnChangeFn,\n  shouldWatchFile: ShouldWatchFn,\n|};\n\n// NOTE: this fix an issue with flow and default exports (which currently\n// lose their type signatures) by explicitly declare the default export\n// signature. Reference: https://github.com/facebook/flow/issues/449\n// eslint-disable-next-line no-shadow\ndeclare function exports(params: OnSourceChangeParams): Watchpack;\n\nexport type OnSourceChangeFn = (params: OnSourceChangeParams) => Watchpack;\n\nexport default function onSourceChange(\n  {sourceDir, artifactsDir, onChange, shouldWatchFile}: OnSourceChangeParams\n): Watchpack {\n  // TODO: For network disks, we would need to add {poll: true}.\n  const watcher = new Watchpack();\n\n  const executeImmediately = true;\n  onChange = debounce(onChange, 1000, executeImmediately);\n\n  watcher.on('change', (filePath) => {\n    proxyFileChanges({artifactsDir, onChange, filePath, shouldWatchFile});\n  });\n\n  log.debug(`Watching for file changes in ${sourceDir}`);\n  watcher.watch([], [sourceDir], Date.now());\n\n  // TODO: support interrupting the watcher on Windows.\n  // https://github.com/mozilla/web-ext/issues/225\n  process.on('SIGINT', () => watcher.close());\n  return watcher;\n}\n\n\n// proxyFileChanges types and implementation.\n\nexport type ProxyFileChangesParams = {|\n  artifactsDir: string,\n  onChange: OnChangeFn,\n  filePath: string,\n  shouldWatchFile: ShouldWatchFn,\n|};\n\nexport function proxyFileChanges(\n  {artifactsDir, onChange, filePath, shouldWatchFile}: ProxyFileChangesParams\n): void {\n  if (filePath.indexOf(artifactsDir) === 0 || !shouldWatchFile(filePath)) {\n    log.debug(`Ignoring change to: ${filePath}`);\n  } else {\n    log.debug(`Changed: ${filePath}`);\n    log.debug(`Last change detection: ${(new Date()).toTimeString()}`);\n    onChange();\n  }\n}\n","module.exports = require(\"adbkit\");","module.exports = require(\"addons-linter\");","module.exports = require(\"bunyan\");","module.exports = require(\"camelcase\");","module.exports = require(\"child_process\");","module.exports = require(\"colors\");","module.exports = require(\"debounce\");","module.exports = require(\"decamelize\");","module.exports = require(\"es6-error\");","module.exports = require(\"es6-promise\");","module.exports = require(\"event-to-promise\");","module.exports = require(\"events\");","module.exports = require(\"firefox-profile\");","module.exports = require(\"fs\");","module.exports = require(\"fx-runner\");","module.exports = require(\"git-rev-sync\");","module.exports = require(\"js-select\");","module.exports = require(\"mkdirp\");","module.exports = require(\"multimatch\");","module.exports = require(\"mz\");","module.exports = require(\"net\");","module.exports = require(\"node-notifier\");","module.exports = require(\"opn\");","module.exports = require(\"os\");","module.exports = require(\"parse-json\");","module.exports = require(\"path\");","module.exports = require(\"readline\");","module.exports = require(\"require-uncached\");","module.exports = require(\"sign-addon\");","module.exports = require(\"strip-json-comments\");","module.exports = require(\"tmp\");","module.exports = require(\"update-notifier\");","module.exports = require(\"util\");","module.exports = require(\"watchpack\");","module.exports = require(\"yargs\");","module.exports = require(\"zip-dir\");"],"sourceRoot":""}